<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM WARS</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--green:#00ff41;--green-dim:#00aa2a;--red:#ff3333;--blue:#3399ff;--gold:#ffd700;--orange:#ff8800;--bg:#0a0a12;--panel:#12131f;--panel-border:#1e2035;--text:#c8c8d0}
body{background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;overflow:hidden;height:100vh;width:100vw}
#titleScreen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:18vh;z-index:1000;background:var(--bg)}
#titleScreen .villain-bg{position:absolute;top:0;left:0;right:0;height:80%;background:url('data:image/jpeg;base64,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') center center/cover no-repeat;opacity:0.45;mask-image:linear-gradient(to bottom,rgba(0,0,0,1) 0%,rgba(0,0,0,0.7) 55%,rgba(0,0,0,0) 90%);-webkit-mask-image:linear-gradient(to bottom,rgba(0,0,0,1) 0%,rgba(0,0,0,0.7) 55%,rgba(0,0,0,0) 90%);pointer-events:none;z-index:0;animation:villainFade 3s ease-out;image-rendering:pixelated;image-rendering:-moz-crisp-edges}
#titleScreen .scanlines{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,65,0.03) 2px,rgba(0,255,65,0.03) 4px);pointer-events:none;z-index:1}
#titleScreen .logo-container{position:relative;z-index:2;text-align:center;animation:logoIn 1.5s ease-out;background:rgba(10,10,18,0.6);border:3px solid rgba(0,255,65,0.3);border-radius:0;padding:20px 60px 16px;box-shadow:6px 6px 0 rgba(0,0,0,0.6),-2px -2px 0 rgba(0,255,65,0.08),inset 0 0 40px rgba(0,0,0,0.4);backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px);max-width:680px;width:90%;image-rendering:pixelated}
@keyframes logoIn{0%{transform:scale(3);opacity:0;filter:blur(20px)}60%{transform:scale(1.05);opacity:1;filter:blur(0)}100%{transform:scale(1)}}
@keyframes villainFade{0%{opacity:0;transform:scale(1.1)}100%{opacity:0.45;transform:scale(1)}}
#titleScreen h1{font-family:'Orbitron',sans-serif;font-weight:900;font-size:72px;letter-spacing:12px;color:var(--green);text-shadow:3px 3px 0 #005500,6px 6px 0 rgba(0,0,0,0.5),0 0 30px rgba(0,255,65,0.4);margin-bottom:4px;white-space:nowrap}
#titleScreen .subtitle{font-size:14px;color:var(--green-dim);letter-spacing:8px;text-transform:uppercase;margin-bottom:20px}
#titleScreen .level-name{font-family:'Orbitron',sans-serif;font-size:20px;color:#3399ff;letter-spacing:4px;margin-bottom:24px}
.menu-btn{background:transparent;border:2px solid var(--green-dim);color:var(--green);font-family:'Orbitron',sans-serif;font-size:14px;letter-spacing:4px;padding:12px 32px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;border-radius:0;box-shadow:3px 3px 0 rgba(0,0,0,0.5)}
.menu-btn:hover{background:rgba(0,255,65,0.15);border-color:var(--green);box-shadow:3px 3px 0 rgba(0,255,65,0.3);transform:translate(-1px,-1px)}
#titleScreen .flavor{position:absolute;bottom:40px;font-size:11px;color:#333;letter-spacing:2px;z-index:2}
#gameContainer{display:none;width:100vw;height:100vh;position:relative}
canvas#gameCanvas{display:block;width:100%;height:100%}
#topBar{position:absolute;top:0;left:0;right:0;height:48px;background:linear-gradient(180deg,rgba(18,19,31,0.95),rgba(18,19,31,0.8));border-bottom:1px solid var(--panel-border);display:flex;align-items:center;padding:0 16px;gap:20px;z-index:10;backdrop-filter:blur(8px)}
.stat-group{display:flex;align-items:center;gap:6px;font-size:13px}
.stat-icon{font-size:16px}.stat-label{color:#666;font-size:10px;text-transform:uppercase;letter-spacing:1px}
.stat-value{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700}
#companyName{font-family:'Orbitron',sans-serif;font-weight:700;font-size:14px;color:var(--green);letter-spacing:2px;margin-right:auto}
#gameSpeed{font-size:11px;color:#555;cursor:pointer;padding:4px 8px;border:1px solid #333;border-radius:3px}
#gameSpeed:hover{border-color:var(--green-dim);color:var(--green-dim)}
#rightPanel{position:absolute;top:48px;right:0;bottom:40px;width:260px;background:rgba(18,19,31,0.92);border-left:1px solid var(--panel-border);z-index:10;backdrop-filter:blur(8px);display:flex;flex-direction:column;overflow-y:auto}
.panel-section{padding:12px;border-bottom:1px solid var(--panel-border)}
.panel-title{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:2px;color:var(--green-dim);text-transform:uppercase;margin-bottom:8px}
.build-btn{display:flex;align-items:center;gap:8px;width:100%;background:rgba(255,255,255,0.03);border:1px solid #2a2a3a;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:12px;padding:8px 10px;margin-bottom:4px;cursor:pointer;transition:all 0.15s;text-align:left}
.build-btn:hover:not(:disabled){background:rgba(0,255,65,0.05);border-color:var(--green-dim)}
.build-btn:disabled{opacity:0.35;cursor:not-allowed}
.build-btn .btn-icon{font-size:18px;width:24px;text-align:center}
.build-btn .btn-info{flex:1}.build-btn .btn-name{display:block;font-size:12px}
.build-btn .btn-cost{display:block;font-size:10px;color:var(--green-dim)}
.build-btn .btn-desc{display:block;font-size:9px;color:#555;margin-top:2px}
#bottomBar{position:absolute;bottom:0;left:0;right:0;height:40px;background:rgba(18,19,31,0.92);border-top:1px solid var(--panel-border);display:flex;align-items:center;padding:0 16px;z-index:10;font-size:11px;color:#555;backdrop-filter:blur(8px)}
#eventLog{flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
#minimap{position:absolute;bottom:44px;left:8px;width:200px;height:260px;background:rgba(10,10,18,0.9);border:1px solid var(--panel-border);z-index:10}
.scroll-zone{position:absolute;z-index:5}
.scroll-zone-top{top:48px;left:0;right:260px;height:30px}
.scroll-zone-bottom{bottom:40px;left:0;right:260px;height:30px}
.scroll-zone-left{top:48px;left:0;bottom:40px;width:30px}
.scroll-zone-right{top:48px;right:260px;bottom:40px;width:30px}
#zoomLevel{position:absolute;bottom:48px;right:268px;font-size:10px;color:#444;z-index:10;padding:3px 8px;background:rgba(18,19,31,0.8);border:1px solid #1e2035}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}70%{opacity:1}100%{opacity:0;transform:translateY(-60px) scale(1.2)}}
.income-float{position:absolute;pointer-events:none;z-index:15;font-family:'Orbitron',sans-serif;font-weight:700;font-size:16px;text-shadow:0 0 10px currentColor,0 2px 4px rgba(0,0,0,0.8);animation:floatUp 1.8s ease-out forwards}
#gameOver{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;flex-direction:column;align-items:center;justify-content:center}
#gameOver h2{font-family:'Orbitron',sans-serif;font-size:48px;margin-bottom:16px}
#gameOver .go-stats{font-size:14px;color:#888;margin-bottom:32px;text-align:center;line-height:2}
.toast{position:absolute;top:56px;left:50%;transform:translateX(-50%);background:rgba(18,19,31,0.95);border:1px solid var(--green-dim);padding:8px 20px;font-size:12px;color:var(--green);z-index:20;animation:toastIn 0.3s ease,toastOut 0.3s ease 2.5s forwards;pointer-events:none}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}}
@keyframes toastOut{to{opacity:0;transform:translateX(-50%) translateY(-10px)}}
#settingsBtn{font-size:18px;cursor:pointer;padding:4px 8px;border:1px solid #333;border-radius:3px;transition:all 0.2s;user-select:none}
#settingsBtn:hover{border-color:var(--green-dim);color:var(--green-dim);background:rgba(0,255,65,0.05)}
#settingsPanel{display:none;position:absolute;top:52px;right:264px;width:240px;background:rgba(18,19,31,0.96);border:1px solid var(--panel-border);z-index:20;padding:14px;backdrop-filter:blur(12px);border-radius:4px;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
#settingsPanel.open{display:block}
.settings-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:12px;color:#999}
.settings-row label{flex:0 0 90px}
.slider-wrap{flex:1;display:flex;align-items:center;gap:8px}
.slider-wrap span{font-family:'Orbitron',sans-serif;font-size:11px;color:var(--green-dim);min-width:32px;text-align:right}
input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;height:4px;background:#1e2035;border-radius:2px;outline:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--green);cursor:pointer;border:2px solid var(--bg);box-shadow:0 0 6px rgba(0,255,65,0.3)}
input[type="range"]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--green);cursor:pointer;border:2px solid var(--bg)}
input[type="checkbox"]{accent-color:var(--green);width:16px;height:16px;cursor:pointer}
.info-btn{background:none;border:1px solid #333;color:#666;font-size:10px;width:18px;height:18px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s;padding:0;line-height:1;font-family:'Orbitron',sans-serif}
.info-btn:hover{border-color:var(--blue);color:var(--blue);background:rgba(51,153,255,0.1)}
#infoModal{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.6);align-items:center;justify-content:center}
#infoModal.open{display:flex}
#infoModalContent{background:#12131f;border:1px solid var(--panel-border);padding:20px;min-width:300px;max-width:400px;border-radius:6px;box-shadow:0 12px 48px rgba(0,0,0,0.6)}
#infoModalContent h3{font-family:'Orbitron',sans-serif;font-size:16px;color:var(--green);margin-bottom:12px;display:flex;align-items:center;gap:10px}
#infoModalContent h3 .modal-icon{font-size:28px}
.modal-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.modal-stat{background:rgba(255,255,255,0.03);border:1px solid #1e2035;padding:8px;border-radius:3px}
.modal-stat-label{font-size:9px;color:#555;text-transform:uppercase;letter-spacing:1px}
.modal-stat-value{font-family:'Orbitron',sans-serif;font-size:14px;color:var(--text);margin-top:2px}
.modal-desc{font-size:12px;color:#888;line-height:1.6;margin-bottom:14px;padding:8px;background:rgba(255,255,255,0.02);border-left:2px solid var(--green-dim)}
.modal-requires{font-size:10px;color:#555;margin-bottom:14px}
.modal-close{background:transparent;border:1px solid #333;color:#888;font-family:'Orbitron',sans-serif;font-size:11px;padding:8px 24px;cursor:pointer;width:100%;transition:all 0.15s}
.modal-close:hover{border-color:var(--green-dim);color:var(--green)}
.build-btn-row{display:flex;gap:4px;margin-bottom:4px}
.build-btn-row .build-btn{flex:1;margin-bottom:0}
#setupForm{width:100%;max-width:440px;margin:16px auto 0;text-align:left}
.setup-row{margin-bottom:14px}
.setup-label{display:block;font-family:'Orbitron',sans-serif;font-size:10px;color:#888;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px}
.setup-input{width:100%;box-sizing:border-box;background:rgba(255,255,255,0.04);border:1px solid #2a2a3a;color:var(--green);font-family:'Orbitron',sans-serif;font-size:14px;padding:10px 14px;outline:none;transition:border-color 0.2s;letter-spacing:1px}
.setup-input:focus{border-color:var(--green-dim);box-shadow:0 0 12px rgba(0,255,65,0.08)}
.setup-options{display:flex;gap:6px}
.setup-opt{flex:1;background:rgba(255,255,255,0.03);border:1px solid #2a2a3a;color:#888;font-family:'Orbitron',sans-serif;font-size:12px;padding:8px 4px 6px;cursor:pointer;transition:all 0.15s;display:flex;flex-direction:column;align-items:center;gap:2px}
.setup-opt:hover{border-color:#555;color:#ccc;background:rgba(255,255,255,0.06)}
.setup-opt.active{border-color:var(--green-dim);color:var(--green);background:rgba(0,255,65,0.08);box-shadow:0 0 10px rgba(0,255,65,0.06)}
.opt-sub{font-size:8px;color:#555;letter-spacing:0.5px;font-family:'Share Tech Mono',monospace}
.setup-opt.active .opt-sub{color:var(--green-dim)}
.mp-section{margin-top:18px;padding-top:16px;border-top:1px solid #1e2035}
.mp-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.mp-btn{flex:1;background:rgba(255,255,255,0.03);border:1px solid #2a2a3a;color:#aaa;font-family:'Orbitron',sans-serif;font-size:11px;padding:10px;cursor:pointer;transition:all 0.15s;text-align:center}
.mp-btn:hover{border-color:var(--green-dim);color:var(--green);background:rgba(0,255,65,0.05)}
.mp-btn.red:hover{border-color:var(--red);color:var(--red);background:rgba(255,51,51,0.05)}
.mp-code-input{width:120px;background:rgba(255,255,255,0.04);border:1px solid #2a2a3a;color:var(--gold);font-family:'Orbitron',sans-serif;font-size:18px;padding:8px 12px;outline:none;text-align:center;letter-spacing:4px;text-transform:uppercase}
.mp-code-input:focus{border-color:var(--gold);box-shadow:0 0 12px rgba(255,220,68,0.1)}
.mp-status{font-family:'Share Tech Mono',monospace;font-size:11px;color:#555;text-align:center;margin-top:8px;min-height:16px}
.mp-status.ready{color:var(--green);animation:pulse-text 1s infinite}
.mp-status.waiting{color:var(--gold)}
.mp-room-code{font-family:'Orbitron',sans-serif;font-size:24px;color:var(--gold);text-align:center;letter-spacing:6px;margin:8px 0;user-select:all}
@keyframes pulse-text{0%,100%{opacity:1}50%{opacity:0.5}}
.team-item{display:flex;align-items:center;gap:6px;padding:4px 6px;border-bottom:1px solid #1a1a2a;font-size:10px;font-family:'Share Tech Mono',monospace}
.team-item:hover{background:rgba(255,255,255,0.03)}
.team-icon{font-size:14px;width:20px;text-align:center}
.team-name{flex:1;color:#aaa;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.team-salary{color:var(--orange);font-size:9px;margin-right:4px}
.team-state{font-size:8px;padding:1px 4px;border-radius:3px;margin-right:4px}
.team-state.idle{color:#555;background:rgba(255,255,255,0.03)}
.team-state.moving{color:var(--blue);background:rgba(68,136,255,0.1)}
.team-state.converting{color:var(--gold);background:rgba(255,220,68,0.1)}
.fire-btn{background:none;border:1px solid #3a1a1a;color:#aa4444;font-size:10px;padding:2px 6px;cursor:pointer;font-family:'Orbitron',sans-serif;transition:all 0.15s}
.fire-btn:hover{border-color:#ff4444;color:#ff4444;background:rgba(255,68,68,0.1)}
@media(max-width:700px){
#titleScreen h1{font-size:42px;letter-spacing:6px}
#titleScreen .subtitle{font-size:10px;letter-spacing:4px}
#titleScreen .logo-container{padding:16px 20px 12px;max-width:95%}
#mainMenu{flex-direction:column;gap:6px}
.menu-btn{font-size:12px;letter-spacing:3px;padding:10px 24px;width:100%}
.setup-row{flex-direction:column;gap:4px}
.setup-label{min-width:unset;text-align:left}
.setup-options{flex-wrap:wrap}
.setup-opt{font-size:9px;padding:6px 8px;min-width:60px}
.setup-input{width:100%;box-sizing:border-box}
#setupForm{max-height:55vh;overflow-y:auto}
.mp-input{width:100%;box-sizing:border-box}
}
@media(max-width:480px){
#titleScreen h1{font-size:32px;letter-spacing:4px}
#titleScreen .subtitle{font-size:8px;letter-spacing:3px}
#titleScreen .logo-container{padding:12px 14px 10px}
#titleScreen{padding-bottom:12vh}
.menu-btn{font-size:11px;padding:10px 16px}
}
</style>
</head>
<body>
<div id="titleScreen"><div class="scanlines"></div><div class="villain-bg"></div><div class="logo-container">
<h1>CRM WARS</h1>
<div class="subtitle">Command Sales &amp; Conquer the Market</div>
<!-- PHASE 1: Main Menu -->
<div id="mainMenu" style="display:flex;gap:10px;justify-content:center;margin-top:12px">
  <button class="menu-btn" onclick="showSetup('ai')">VS AI</button>
  <button class="menu-btn" onclick="showSetup('mp')" style="border-color:#ddaa33;color:#ddaa33">VS HUMAN</button>
</div>

<!-- PHASE 2: Setup -->
<div id="setupScreen" style="display:none">
  <div style="text-align:left;margin-bottom:8px"><button class="mp-btn" onclick="showMenu()" style="width:auto;padding:6px 14px;font-size:10px">‚Üê BACK</button></div>
  <div id="setupForm">
    <div class="setup-row"><label class="setup-label">Company Name</label><input type="text" id="setupName" class="setup-input" value="STARTUP INC." maxlength="24" spellcheck="false"></div>
    <div class="setup-row"><label class="setup-label">Starting Cash</label>
      <div class="setup-options" id="cashOptions">
        <button class="setup-opt" data-val="300" onclick="pickOpt(this)">$300K<span class="opt-sub">Lean</span></button>
        <button class="setup-opt active" data-val="500" onclick="pickOpt(this)">$500K<span class="opt-sub">Standard</span></button>
        <button class="setup-opt" data-val="800" onclick="pickOpt(this)">$800K<span class="opt-sub">Funded</span></button>
        <button class="setup-opt" data-val="1200" onclick="pickOpt(this)">$1.2M<span class="opt-sub">Series A</span></button>
      </div></div>
    <div class="setup-row"><label class="setup-label">Starting Reps</label>
      <div class="setup-options" id="repOptions">
        <button class="setup-opt" data-val="1" onclick="pickOpt(this)">1<span class="opt-sub">Solo</span></button>
        <button class="setup-opt active" data-val="2" onclick="pickOpt(this)">2<span class="opt-sub">Small Team</span></button>
        <button class="setup-opt" data-val="4" onclick="pickOpt(this)">4<span class="opt-sub">Squad</span></button>
        <button class="setup-opt" data-val="6" onclick="pickOpt(this)">6<span class="opt-sub">Army</span></button>
      </div></div>
    <div class="setup-row"><label class="setup-label">Market Size</label>
      <div class="setup-options" id="marketOptions">
        <button class="setup-opt" data-val="0.4" onclick="pickOpt(this)">Small<span class="opt-sub">~50 prospects</span></button>
        <button class="setup-opt active" data-val="1" onclick="pickOpt(this)">Medium<span class="opt-sub">~120 prospects</span></button>
        <button class="setup-opt" data-val="1.8" onclick="pickOpt(this)">Large<span class="opt-sub">~220 prospects</span></button>
        <button class="setup-opt" data-val="3" onclick="pickOpt(this)">Massive<span class="opt-sub">~360 prospects</span></button>
      </div></div>
    <div class="setup-row"><label class="setup-label">Players</label>
      <div class="setup-options" id="playerCountOptions">
        <button class="setup-opt active" data-val="2" onclick="pickOpt(this)">2<span class="opt-sub">Classic</span></button>
        <button class="setup-opt" data-val="3" onclick="pickOpt(this)">3<span class="opt-sub">Three-way</span></button>
        <button class="setup-opt" data-val="4" onclick="pickOpt(this)">4<span class="opt-sub">Free-for-all</span></button>
      </div></div>
    <div class="setup-row"><label class="setup-label">Game Mode</label>
      <div class="setup-options" id="modeOptions">
        <button class="setup-opt active" data-val="standard" onclick="pickOpt(this);document.getElementById('zeroSumSub').style.display='none'">Standard<span class="opt-sub">Fixed prospects</span></button>
        <button class="setup-opt" data-val="growing" onclick="pickOpt(this);document.getElementById('zeroSumSub').style.display='none'">Growing<span class="opt-sub">New customers arrive</span></button>
        <button class="setup-opt" data-val="zero_sum" onclick="pickOpt(this);document.getElementById('zeroSumSub').style.display='flex'">Zero Sum<span class="opt-sub">All pre-owned, steal only</span></button>
      </div>
      <div id="zeroSumSub" class="setup-options" style="display:none;margin-top:6px">
        <button class="setup-opt active" data-val="random" onclick="pickOpt(this)">Random Split<span class="opt-sub">50/50 scattered</span></button>
        <button class="setup-opt" data-val="territorial" onclick="pickOpt(this)">Territorial<span class="opt-sub">Local monopolies</span></button>
      </div>
      </div>
    <div class="setup-row"><label class="setup-label">Win Condition</label>
      <div class="setup-options" id="winCondOptions">
        <button class="setup-opt active" data-val="domination" onclick="pickOpt(this)">Domination<span class="opt-sub">75% market share</span></button>
        <button class="setup-opt" data-val="mrr_race" onclick="pickOpt(this)">MRR Race<span class="opt-sub">First to $500K MRR</span></button>
        <button class="setup-opt" data-val="elimination" onclick="pickOpt(this)">Elimination<span class="opt-sub">Bankrupt opponent</span></button>
        <button class="setup-opt" data-val="conquest" onclick="pickOpt(this)">Conquest<span class="opt-sub">Own every customer</span></button>
      </div></div>

    <!-- AI-only settings -->
    <div id="aiSettings">
      <div class="setup-row"><label class="setup-label">Opponent Start</label>
        <div class="setup-options" id="oppStartOptions">
          <button class="setup-opt" data-val="even" onclick="pickOpt(this)">Even Start<span class="opt-sub">Same as you</span></button>
          <button class="setup-opt active" data-val="slight" onclick="pickOpt(this)">Head Start<span class="opt-sub">Bigger team</span></button>
          <button class="setup-opt" data-val="incumbent" onclick="pickOpt(this)">Incumbent<span class="opt-sub">Established empire</span></button>
        </div></div>
      <div class="setup-row"><label class="setup-label">AI Difficulty</label>
        <div style="display:flex;align-items:center;gap:10px">
          <input type="range" id="aiDiffSlider" min="1" max="5" value="3" step="1" style="flex:1;accent-color:var(--red)" oninput="document.getElementById('aiDiffLabel').textContent=['Passive','Easy','Medium','Hard','Ruthless'][this.value-1];document.getElementById('aiDiffDesc').textContent=['Barely builds or hires. Ignores your customers entirely.','Slow to expand. Occasional hiring and building, no real strategy.','Balanced play. Builds steadily, researches tech, competes for prospects.','Optimal build order. Actively sends reps to steal your best accounts.','Maximum aggression. Builds constantly, targets your highest-value customers relentlessly.'][this.value-1]">
          <span id="aiDiffLabel" style="font-family:'Orbitron',sans-serif;font-size:11px;color:var(--red);min-width:60px;text-align:right">Medium</span>
        </div>
        <div id="aiDiffDesc" style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#555;margin-top:6px;line-height:1.4">Balanced play. Builds steadily, researches tech, competes for prospects.</div>
      </div>
    </div>

    <!-- Multiplayer-only settings -->
    <div id="mpSettings" style="display:none">
      <div class="mp-section" style="margin-top:10px;padding-top:12px">
        <div id="mpLobby">
          <div class="mp-row">
            <button class="mp-btn" onclick="mpCreate()">üü¢ HOST GAME</button>
            <button class="mp-btn red" onclick="document.getElementById('mpJoinPanel').style.display='flex'">üî¥ JOIN GAME</button>
          </div>
          <div id="mpJoinPanel" style="display:none;flex-direction:column;align-items:center;gap:8px;margin-top:8px">
            <div style="font-size:10px;color:#666">ENTER ROOM CODE</div>
            <div class="mp-row" style="justify-content:center"><input type="text" id="mpCodeInput" class="mp-code-input" maxlength="4" placeholder="____" spellcheck="false"><button class="mp-btn" style="width:auto;padding:10px 16px" onclick="mpJoin()">JOIN</button></div>
          </div>
        </div>
        <div id="mpWaiting" style="display:none;text-align:center">
          <div style="font-size:10px;color:#666;margin-bottom:4px">ROOM CODE</div>
          <div class="mp-room-code" id="mpRoomDisplay"></div>
          <div class="mp-status waiting" id="mpStatus">Waiting for opponent...</div>
        </div>
      </div>
    </div>
  </div>

  <button class="menu-btn" onclick="launchGame()" style="margin-top:14px" id="startSoloBtn">‚öî START GAME</button>
  <button class="menu-btn" id="startMpBtn" style="display:none;margin-top:14px;border-color:var(--gold);color:var(--gold)" onclick="launchMultiplayer()">‚öî START HEAD-TO-HEAD</button>
</div>

</div><div class="flavor">¬© 2026 CRM WARS ‚Äî ALL YOUR CUSTOMERS ARE BELONG TO US</div></div>
<div id="gameContainer">
<canvas id="gameCanvas"></canvas>
<div id="topBar">
  <div id="companyName">STARTUP INC.</div>
  <div class="stat-group"><span class="stat-icon">üí∞</span><div><div class="stat-label">Cash</div><div class="stat-value" style="color:var(--green)" id="cashDisplay">$500K</div></div></div>
  <div class="stat-group"><span class="stat-icon">üìà</span><div><div class="stat-label">MRR</div><div class="stat-value" style="color:var(--gold)" id="arrDisplay">$0</div></div></div>
  <div class="stat-group"><span class="stat-icon">üî•</span><div><div class="stat-label">Burn</div><div class="stat-value" style="color:var(--orange)" id="burnDisplay">$0</div></div></div>
  <div class="stat-group"><span class="stat-icon">üìä</span><div><div class="stat-label">Net</div><div class="stat-value" id="netDisplay">$0</div></div></div>
  <div class="stat-group"><span class="stat-icon">üë•</span><div><div class="stat-label">Won</div><div class="stat-value" style="color:var(--blue)" id="custDisplay">0</div></div></div>
  <div class="stat-group"><span class="stat-icon">üéØ</span><div><div class="stat-label">Free</div><div class="stat-value" style="color:#888" id="freeDisplay">0</div></div></div>
  <div class="stat-group" id="winCondGroup" style="border-left:1px solid rgba(255,255,255,0.08);padding-left:12px"><span class="stat-icon" id="winCondIcon">üèÜ</span><div><div class="stat-label" id="winCondLabel">Goal</div><div class="stat-value" style="color:#bb88ff" id="winCondDisplay">--</div></div></div>
  <div id="settingsBtn" onclick="toggleSettings()">‚öô</div>
</div>
<div id="settingsPanel">
  <div class="panel-title" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">‚öô SETTINGS <span onclick="toggleSettings()" style="cursor:pointer;color:#666;font-size:14px">‚úï</span></div>
  <div class="settings-row"><label>Game Speed</label><div class="slider-wrap"><input type="range" id="speedSlider" min="1" max="20" value="1" step="1" oninput="onSpeedSlider(this.value)"><span id="speedLabel">1x</span></div></div>
  <div class="settings-row"><label>Grid Opacity</label><div class="slider-wrap"><input type="range" id="gridSlider" min="0" max="100" value="40" step="5" oninput="gridOpacity=this.value/100;document.getElementById('gridLabel').textContent=this.value+'%';prerenderMap()"><span id="gridLabel">40%</span></div></div>
  <div class="settings-row"><label>Show Labels</label><div class="slider-wrap"><input type="checkbox" id="labelToggle" checked onchange="showLabels=this.checked;prerenderMap()"></div></div>
  <div class="settings-row"><label>Voice Feedback</label><div class="slider-wrap"><input type="checkbox" id="voiceToggle" checked onchange="voiceEnabled=this.checked"></div></div>
  <div class="settings-row"><label>SFX Volume</label><div class="slider-wrap"><input type="range" id="sfxSlider" min="0" max="100" value="50" step="5" oninput="setSFXVolume(this.value)"><span id="sfxLabel">50%</span></div></div>
  <div class="settings-row"><label>Music Volume</label><div class="slider-wrap"><input type="range" id="musicSlider" min="0" max="100" value="30" step="5" oninput="setMusicVolume(this.value)"><span id="musicLabel">30%</span></div></div>
  <div class="settings-row"><label>UI Scale</label><div class="slider-wrap"><input type="range" id="uiScaleSlider" min="80" max="150" value="100" step="10" oninput="setUIScale(this.value)"><span id="uiScaleLabel">100%</span></div></div>
</div>
<div id="rightPanel">
  <div class="panel-section"><div class="panel-title">üèó Build</div><div id="buildingButtons"></div></div>
  <div class="panel-section"><div class="panel-title">üë§ Hire</div><div id="unitButtons"></div></div>
  <div class="panel-section"><div class="panel-title">üë• Team <span id="teamCount" style="color:#555;font-size:10px"></span></div><div id="teamList"></div></div>
  <div class="panel-section"><div class="panel-title">üî¨ Research</div><div id="techButtons"></div></div>
  <div class="panel-section"><div class="panel-title">üìä Intel</div><div id="marketIntel" style="font-size:11px;color:#666;line-height:1.7"></div></div>
</div>
<canvas id="minimap"></canvas>
<div class="scroll-zone scroll-zone-top" data-dir="up"></div>
<div class="scroll-zone scroll-zone-bottom" data-dir="down"></div>
<div class="scroll-zone scroll-zone-left" data-dir="left"></div>
<div class="scroll-zone scroll-zone-right" data-dir="right"></div>
<div id="zoomLevel">100%</div>
<div id="bottomBar"><div id="eventLog"></div></div>
</div>
<div id="gameOver"><h2 id="goTitle"></h2><div class="go-stats" id="goStats"></div>
<button class="menu-btn" onclick="location.reload()" style="border-color:var(--green-dim);color:var(--green)">PLAY AGAIN</button></div>
<div id="infoModal" onclick="if(event.target===this)closeInfo()"><div id="infoModalContent"></div></div>
<script>
// =============================================
//  CRM WARS v4 ‚Äî TERRITORY MAP (UK & Ireland)
// =============================================

// ---- VOICE SYSTEM ----
const VOICE_LINES={
  // Unit selection lines (by type)
  select:{
    sales_rep:["Ready to sell!","What's the target?","Always be closing.","Point me at a prospect.","Let's get after it.","Show me the money.","I've got my pitch ready.","Where do you need me boss?"],
    sr_sales_rep:["Senior rep reporting.","I'll handle the big fish.","Nobody closes like me.","Ready for the hard sell.","Time to steal some accounts.","I eat quotas for breakfast.","Let me at their best customers.","Experience wins deals."],
    marketer:["Marketing is live!","Let's build some buzz.","I'll bring them to us.","Content is king.","Generating demand!","Brand awareness incoming.","Let me work my magic.","Prospects won't know what hit them."],
    service_rep:["Customer success, standing by.","I'll keep them loyal.","Nobody poaches on my watch.","CS rep reporting in.","Retention is my game.","I've got our accounts covered.","They'll never want to leave.","Send me where you need me."],
    ai_agent:["AI systems online.","Processing targets.","Neural networks engaged.","Efficiency optimized.","I compute, therefore I close.","Running sales algorithm.","Target acquired. Probability: high.","Beep boop. Just kidding. Let's sell."],
    talent_acq:["HR on standby.","I see talent everywhere.","Who's their best closer?","Time to make an offer they can't refuse.","Headhunter ready.","Let me check their LinkedIn.","I know everyone in this industry.","Talent acquisition, reporting in."]
  },
  // Command lines (sent to target)
  command:{
    sales_rep:["I'm on it!","On my way.","Consider it done.","Moving out!","Let's close this one.","Get the gong ready!"],
    sr_sales_rep:["I'll handle this personally.","This one's mine.","Watch and learn.","Easy money.","I'll have them signing by tonight."],
    marketer:["Heading out!","I'll spread the word.","On the move.","Marketing blitz incoming."],
    service_rep:["On my way to defend.","CS incoming.","I'll block the poach.","Heading to protect the account."],
    ai_agent:["Executing directive.","Target locked.","Optimal route calculated.","Processing... en route.","Compliance probability: 94%."],
    talent_acq:["Sourcing the target.","Making contact.","Setting up the interview.","Extending the offer.","They won't say no to this package."]
  },
  // System events
  system:{
    building:["Construction underway.","Building in progress.","Expanding operations.","New facility under construction."],
    buildComplete:["Construction complete!","Building ready for business.","New facility online.","Structure complete. Looking good."],
    training:["New recruit in training.","Rep onboarding started.","Training in progress.","Getting them sales-ready."],
    trainComplete:{
      sales_rep:["Sales rep trained and ready to close deals!","New rep reporting for duty.","Fresh legs on the team. Let's go!","Ready to get after it, boss!"],
      sr_sales_rep:["Senior rep locked and loaded.","Heavy hitter ready to roll.","The closer has arrived.","Time to show them how it's done."],
      marketer:["Marketer ready to generate buzz!","Brand champion reporting in.","Let's make some noise!","The pipeline builder is here."],
      service_rep:["CS rep trained and ready!","Customer defender online.","No poaching on my watch.","Customer success expert reporting."],
      ai_agent:["AI SDR fully operational.","Machine learning complete. Ready to sell.","Artificial intelligence, real results.","Neural nets trained. Targets loading."],
      talent_acq:["Talent Acquisition specialist ready.","Headhunter on the prowl.","Time to poach their best people.","HR's secret weapon is online."]
    },
    researching:["R and D in progress.","Scientists are working on it.","Research underway.","Lab is cooking something up."],
    researchComplete:["Research complete! New tech unlocked.","Breakthrough! Technology upgraded.","R and D delivers again.","Tech upgrade ready to deploy."],
    dealWon:["Deal closed! Get the gong!","Ka-ching! Another one signed.","Winner winner, chicken dinner!","That's how we do it!","Revenue baby! Let's go!","Signed, sealed, delivered!"],
    dealStolen:["Hostile takeover! We stole one!","Poached from the competition!","That's our customer now!","Ripped it right from under them!"],
    enemyStole:["They stole one of our accounts!","We lost a customer! Fight back!","Competitor took one. Not cool.","Account lost. Time to retaliate."],
    poachSuccess:["We poached their best rep!","Welcome to the team! Great hire.","Their loss, our gain!","Talent acquired! They'll be furious."],
    poachFail:["They got away. Back to sourcing.","Offer rejected. We'll find another.","Poach attempt failed. Regroup."],
    negotiationWon:["Our HR outplayed theirs!","Talent war won! We captured their recruiter.","Hostile takeover of their HR department!"],
    negotiationLost:["We lost the talent war!","Their recruiter got the upper hand.","HR battle lost. Regroup."],
    sabotageSuccess:["Their loyalty is crumbling!","Sabotage successful. Their customers are wavering.","Marketing blitz landed. They're losing faith."],
    customerChurned:["Customer left. We need CS reps out there.","Churn alert! Deploy service reps.","We lost one to churn. Lock down the rest."],
    winCondProgress:["Almost there! Just a few more accounts!","We're closing in on victory!","The finish line is in sight!"],
    lowCash:["Budget's getting tight.","Cash reserves running low.","Watch the burn rate, boss."],
    enemyGrowing:["They're pulling ahead.","Competitor is gaining ground.","We need to pick up the pace."],
    acquisition:["Initiating hostile takeover!","M and A department activated.","Preparing acquisition paperwork."],
    acquisitionComplete:["Acquisition complete! Their customers are ours.","Hostile takeover successful!","We just bought the competition."],
    acquisitionThreat:["Hostile takeover incoming! Shore up the balance sheet!","They're trying to acquire us! Get cash above fifty K!","M and A threat detected. We need revenue, now!"]
  }
};

// Voice config per unit type: pitch, rate
const VOICE_CONFIG={
  sales_rep:{pitch:1.0,rate:1.0},
  sr_sales_rep:{pitch:0.8,rate:0.9},
  marketer:{pitch:1.2,rate:1.1},
  service_rep:{pitch:0.9,rate:0.95},
  ai_agent:{pitch:0.5,rate:1.3},
  talent_acq:{pitch:0.7,rate:0.85},
  system:{pitch:1.1,rate:1.0}
};

// ---- STATIC VOICE PLAYBACK ----
let voiceManifest=null; // manifest.json lookup: cacheKey ‚Üí filename
const voiceBlobCache=new Map(); // in-memory: cacheKey ‚Üí blob URL (same-session replay speed)

// Load manifest on startup ‚Äî if it fails, browser TTS fallback is used
fetch('voices/manifest.json').then(r=>{
  if(!r.ok)throw new Error('HTTP '+r.status);
  return r.json();
}).then(m=>{
  voiceManifest=m;
  console.log('Voice manifest loaded: '+Object.keys(m).length+' lines');
}).catch(()=>{
  console.log('No voice manifest found ‚Äî using browser TTS fallback');
});

function playStaticAudio(url){
  const audio=new Audio(url);
  audio.volume=0.7;
  const advance=()=>{
    voiceBusy=false;
    if(voiceQueue.length>0){const next=voiceQueue.shift();speak(next.text,next.type)}
  };
  audio.onended=advance;
  audio.onerror=advance;
  audio.play().catch(advance);
}

function elevenSpeak(text,type){
  const cacheKey=text+'||'+type;

  // 1. Check in-memory blob URL cache (instant replay)
  if(voiceBlobCache.has(cacheKey)){
    playStaticAudio(voiceBlobCache.get(cacheKey));
    return;
  }

  // 2. Look up in manifest and play static file
  if(voiceManifest&&voiceManifest[cacheKey]){
    const url='voices/'+voiceManifest[cacheKey];
    // Fetch as blob for same-session caching
    fetch(url).then(r=>{
      if(!r.ok)throw new Error('HTTP '+r.status);
      return r.blob();
    }).then(blob=>{
      const blobUrl=URL.createObjectURL(blob);
      voiceBlobCache.set(cacheKey,blobUrl);
      playStaticAudio(blobUrl);
    }).catch(()=>{
      browserSpeak(text,type);
    });
    return;
  }

  // 3. No manifest or line not found ‚Äî browser TTS fallback
  browserSpeak(text,type);
}

let voiceEnabled=true,voiceQueue=[],voiceBusy=false,lastVoiceTime=0;
const VOICE_COOLDOWN=800; // ms between voices
const voiceMilestones=new Set(); // track fired milestone voices to avoid repeats
let burnExceedsMRRCount=0; // track consecutive cycles where burn > MRR

function browserSpeak(text,type){
  if(!window.speechSynthesis)return;
  window.speechSynthesis.cancel();
  const utter=new SpeechSynthesisUtterance(text);
  const cfg=VOICE_CONFIG[type]||VOICE_CONFIG.system;
  utter.pitch=cfg.pitch;
  utter.rate=cfg.rate;
  utter.volume=0.7;
  const voices=window.speechSynthesis.getVoices();
  if(voices.length){
    const eng=voices.filter(v=>v.lang.startsWith('en'));
    if(type==='ai_agent'){
      const robot=eng.find(v=>v.name.toLowerCase().includes('google'))||eng[0];
      if(robot)utter.voice=robot;
    } else if(eng.length){
      const typeIdx={sales_rep:0,sr_sales_rep:1,marketer:2,service_rep:3,system:0};
      const idx=(typeIdx[type]||0)%eng.length;
      utter.voice=eng[idx];
    }
  }
  utter.onend=()=>{
    voiceBusy=false;
    if(voiceQueue.length>0){const next=voiceQueue.shift();speak(next.text,next.type)}
  };
  utter.onerror=()=>{
    voiceBusy=false;
    if(voiceQueue.length>0){const next=voiceQueue.shift();speak(next.text,next.type)}
  };
  window.speechSynthesis.speak(utter);
}

function speak(text,type){
  if(!voiceEnabled)return;
  if(!voiceManifest&&!window.speechSynthesis)return;
  if(voiceBusy){
    if(voiceQueue.length<3)voiceQueue.push({text,type});
    return;
  }
  voiceBusy=true;
  if(voiceManifest){
    elevenSpeak(text,type);
  } else {
    browserSpeak(text,type);
  }
}

function speakRandom(lines,type){
  if(!lines||!lines.length)return;
  speak(lines[Math.floor(Math.random()*lines.length)],type);
}

function voiceSelect(u){
  if(u.owner!==player)return; // Don't voice enemy units
  playSFXRandom('select-');
  const lines=VOICE_LINES.select[u.type];
  if(lines)speakRandom(lines,u.type);
}
function voiceCommand(u){
  playSFXRandom('command-');
  const lines=VOICE_LINES.command[u.type];
  if(lines)speakRandom(lines,u.type);
}
function voiceSystem(event,subtype){
  if(event==='trainComplete'&&subtype){
    const lines=VOICE_LINES.system.trainComplete[subtype];
    if(lines){speakRandom(lines,subtype);return}
  }
  const lines=VOICE_LINES.system[event];
  if(lines)speakRandom(lines,'system');
}

// Pre-load voices
if(window.speechSynthesis)window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices();

// ---- SFX SYSTEM ----
let sfxManifest=null,sfxCache=new Map(),sfxVolume=0.5,sfxEnabled=true;
(async function loadSFX(){
  try{
    const res=await fetch('audio/manifest.json');
    if(!res.ok)return;
    sfxManifest=await res.json();
    // Preload all SFX (tiny files)
    for(const [key,filename] of Object.entries(sfxManifest)){
      if(key.startsWith('music-'))continue; // don't preload music tracks into sfxCache
      const a=new Audio('audio/'+filename);
      a.preload='auto';
      sfxCache.set(key,a);
    }
  }catch(e){console.warn('SFX manifest not found, SFX disabled')}
})();

function playSFX(key){
  if(!sfxEnabled||sfxVolume<=0)return;
  const cached=sfxCache.get(key);
  if(!cached)return;
  const clone=cached.cloneNode();
  clone.volume=sfxVolume;
  clone.play().catch(()=>{});
}
function playSFXRandom(prefix){
  const keys=[...sfxCache.keys()].filter(k=>k.startsWith(prefix));
  if(keys.length)playSFX(keys[Math.floor(Math.random()*keys.length)]);
}
function setSFXVolume(val){
  sfxVolume=val/100;
  document.getElementById('sfxLabel').textContent=val+'%';
}

// ---- MUSIC SYSTEM ----
let bgMusic=null,musicVolume=0.3,musicTrack='',musicUnmuted=false;
function initMusic(){
  bgMusic=new Audio();
  bgMusic.loop=true;
  bgMusic.volume=0; // start muted for autoplay policy
  if(sfxManifest&&sfxManifest['music-title']){
    bgMusic.src='audio/'+sfxManifest['music-title'];
    bgMusic.play().catch(()=>{});
  }
}
function switchMusic(track){
  if(!bgMusic||!sfxManifest)return;
  const key='music-'+track;
  if(!sfxManifest[key]||musicTrack===track)return;
  musicTrack=track;
  // Crossfade: fade out then switch
  const fadeOut=setInterval(()=>{
    if(bgMusic.volume>0.02){bgMusic.volume=Math.max(0,bgMusic.volume-0.03)}
    else{clearInterval(fadeOut);bgMusic.src='audio/'+sfxManifest[key];bgMusic.volume=musicUnmuted?musicVolume:0;bgMusic.play().catch(()=>{})}
  },30);
}
function setMusicVolume(val){
  musicVolume=val/100;
  document.getElementById('musicLabel').textContent=val+'%';
  if(bgMusic&&musicUnmuted)bgMusic.volume=musicVolume;
}
function unmuteMusic(){
  if(musicUnmuted||!bgMusic)return;
  musicUnmuted=true;
  bgMusic.volume=musicVolume;
  if(bgMusic.paused)bgMusic.play().catch(()=>{});
}
// Init music after a short delay to allow manifest to load
setTimeout(()=>{if(sfxManifest)initMusic()},500);

// ---- GLOBAL CLICK SFX INTERCEPTOR ----
document.body.addEventListener('click',function(e){
  const el=e.target.closest('button,input[type="checkbox"],.setup-opt,.menu-btn');
  if(!el)return;
  // Skip canvas and minimap clicks ‚Äî handled separately
  if(e.target.id==='gameCanvas'||e.target.id==='minimap')return;
  if(e.target.closest('#gameCanvas,#minimap'))return;

  // Disabled button ‚Üí error sound
  if(el.tagName==='BUTTON'&&el.disabled){
    playSFXRandom('error-');
    return;
  }

  // Build/hire/research buttons
  if(el.closest('#buildingButtons')){playSFXRandom('build-');return}
  if(el.closest('#unitButtons')){playSFXRandom('build-');return}
  if(el.closest('#techButtons')){playSFXRandom('research-');return}

  // Menu buttons (START, PLAY AGAIN, etc.)
  if(el.classList.contains('menu-btn')){playSFXRandom('confirm-');return}

  // Start solo/multiplayer buttons
  if(el.id==='startSoloBtn'||el.id==='hostBtn'||el.id==='joinBtn'){playSFXRandom('confirm-');return}

  // Setup options
  if(el.classList.contains('setup-opt')){playSFXRandom('click-');return}

  // Any other button
  if(el.tagName==='BUTTON'||el.tagName==='INPUT'){playSFXRandom('click-');return}
},true);

// ---- M&A MECHANIC ----
function isDistressed(p){
  const sal=p.units.filter(u=>u.state!=='building').reduce((s,u)=>s+u.salary,0);
  return p.cash<50&&p.arr<sal;
}
function acquisitionCost(target){
  const custVal=target.customers.reduce((s,c)=>s+c.value,0);
  return Math.max(200,custVal*3);
}
function executeAcquisition(buyer,target){
  const cost=acquisitionCost(target);
  if(buyer.cash<cost)return false;
  buyer.cash-=cost;
  // Transfer all customers with reduced loyalty
  target.customers.forEach(c=>{c.owner=buyer;c.loyalty=40;buyer.customers.push(c)});
  const custCount=target.customers.length;
  target.customers=[];
  // Reset target
  target.cash=500;target.units=[];target.buildings=target.buildings.filter(b=>b.type==='office').slice(0,1);
  target.tech={};target.taBuilt=false;
  // Give them 2 fresh sales reps
  const hq=target.buildings[0];
  if(hq){for(let i=0;i<2;i++){target.units.push(createUnit('sales_rep',target,hq.x+(Math.random()-0.5),hq.y+(Math.random()-0.5)))}}
  return custCount;
}
function tryPlayerAcquire(){
  const hasMA=player.buildings.some(b=>b.type==='m_and_a_dept'&&b.bp===undefined);
  const target=players.find(p=>p!==player&&isDistressed(p));
  if(!hasMA||!target)return;
  const cost=acquisitionCost(target);
  if(player.cash<cost){addLog('Not enough cash for acquisition ($'+cost+'K needed)','negative');return}
  const n=executeAcquisition(player,target);
  addLog('ACQUISITION of '+target.name+' COMPLETE! '+n+' customers acquired.','positive');
  voiceSystem('acquisitionComplete');
  if(winCondition==='elimination'){const alive=players.filter(p=>p.cash>0||p.arr>0||p.customers.length>0);if(alive.length===1&&alive[0]===player){endGame(true,'elimination');return}}
  showToast('üè¶ Hostile Takeover Complete!');
}
const TW=64,TH=32,MAP=50;
let TOTAL_CUST=123;
let canvas,ctx,mmCanvas,mmCtx,gameRunning=false,gameTime=0,speedMul=1;
let camX=0,camY=0,zoom=0.7,isDrag=false,dragSX,dragSY,camSX,camSY,dragMoved=false;
let selectedUnit=null,selectedUnits=[],logs=[],edgeDir={x:0,y:0},keysDown=new Set(),particles=[];
let gridOpacity=0.4,showLabels=true,lastBtnRebuild=0;
let boxSelecting=false,boxSX=0,boxSY=0,boxEX=0,boxEY=0;
let setupCash=500,setupReps=2,setupMarket=1,gameMode='standard',zeroSumType='random',winCondition='domination';
let aiDifficulty=3,oppStart='slight'; // 1-5 difficulty, even/slight/incumbent
let waypoints=[]; // {x,y,tile,customer,time,count}
let mpMode=false,mpRole=null,mpRoom=null,mpPollTimer=null,mpReady=false;
let mpPid=0; // this client's player index in multiplayer
let mpActionQueue=[]; // actions to send to opponents
let mpLastSync={}; // {pid: lastSyncIndex} per remote player
// ---- M&A STATE ----
let aiAcqCountdown=0; // ticks remaining for AI hostile takeover attempt
let aiAcquirer=null; // which AI player is attempting acquisition
const AI_ACQ_DURATION=30; // ticks for AI acquisition countdown

// ---- MULTIPLAYER ----
function mpGenCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<4;i++)r+=c[Math.floor(Math.random()*c.length)];return r}

async function mpCreate(){
  mpRoom=mpGenCode();mpRole='green';mpPid=0;
  const name=(document.getElementById('setupName').value||'STARTUP INC.').trim().toUpperCase();
  const pc=getSetupVal('playerCountOptions')||2;
  const slots=[{name,ready:true}];for(let i=1;i<pc;i++)slots.push({name:null,ready:false});
  const data={host:name,hostCash:getSetupVal('cashOptions')||500,hostReps:getSetupVal('repOptions')||2,
    market:getSetupVal('marketOptions')||1,mode:getSetupVal('modeOptions')||'standard',zsType:getSetupVal('zeroSumSub')||'random',winCond:getSetupVal('winCondOptions')||'domination',guest:null,seed:Math.floor(Math.random()*999999),status:'waiting',playerCount:pc,slots};
  try{
    await window.storage.set('crm-room:'+mpRoom,JSON.stringify(data),true);
    document.getElementById('mpLobby').style.display='none';
    document.getElementById('mpWaiting').style.display='block';
    document.getElementById('mpRoomDisplay').textContent=mpRoom;
    document.getElementById('mpStatus').textContent='Waiting for opponent...';
    document.getElementById('mpStatus').className='mp-status waiting';
    mpPollLobby();
  }catch(e){alert('Failed to create room: '+e.message)}
}

async function mpJoin(){
  const code=document.getElementById('mpCodeInput').value.trim().toUpperCase();
  if(code.length!==4)return;
  mpRoom=code;
  try{
    const res=await window.storage.get('crm-room:'+mpRoom,true);
    if(!res)return alert('Room not found!');
    const data=JSON.parse(res.value);
    if(data.status==='started')return alert('Game already started!');
    // Find first empty slot
    const slotIdx=data.slots.findIndex(s=>s.name===null);
    if(slotIdx<0)return alert('Room is full!');
    mpPid=slotIdx;mpRole=slotIdx===0?'green':'red'; // backward compat
    const name=(document.getElementById('setupName').value||'RIVAL CORP.').trim().toUpperCase();
    data.slots[slotIdx]={name,ready:true};
    // If all human slots filled, mark ready
    const allFilled=data.slots.every(s=>s.name!==null);
    if(allFilled)data.status='ready';
    await window.storage.set('crm-room:'+mpRoom,JSON.stringify(data),true);
    document.getElementById('mpLobby').style.display='none';
    document.getElementById('mpWaiting').style.display='block';
    document.getElementById('mpRoomDisplay').textContent=mpRoom;
    document.getElementById('mpStatus').textContent='‚úì Connected! Slot '+(slotIdx+1)+'. Waiting for host to start...';
    document.getElementById('mpStatus').className='mp-status ready';
    mpReady=true;
    mpPollLobby();
  }catch(e){alert('Failed to join: '+e.message)}
}

async function mpPollLobby(){
  if(!mpRoom)return;
  try{
    const res=await window.storage.get('crm-room:'+mpRoom,true);
    if(!res)return;
    const data=JSON.parse(res.value);
    const filledNames=data.slots.filter(s=>s.name).map(s=>s.name);
    const filledCount=filledNames.length;
    if(mpPid===0){
      // Host sees who joined
      if(filledCount>1){
        document.getElementById('mpStatus').textContent='‚úì '+filledNames.slice(1).join(', ')+' joined! ('+filledCount+'/'+data.playerCount+')';
        document.getElementById('mpStatus').className='mp-status ready';
        document.getElementById('startMpBtn').style.display='block';
        document.getElementById('startSoloBtn').style.display='none';
        mpReady=true;
      }
    } else {
      if(data.status==='started'){launchMultiplayer();return}
      document.getElementById('mpStatus').textContent='Waiting... ('+filledCount+'/'+data.playerCount+' players)';
    }
  }catch(e){}
  setTimeout(mpPollLobby,1000);
}

async function launchMultiplayer(){
  mpMode=true;
  try{
    const res=await window.storage.get('crm-room:'+mpRoom,true);
    if(!res)return;
    const data=JSON.parse(res.value);
    if(mpPid===0){data.status='started';await window.storage.set('crm-room:'+mpRoom,JSON.stringify(data),true)}
    setupCash=data.hostCash;setupReps=data.hostReps;setupMarket=data.market;gameMode=data.mode||'standard';zeroSumType=data.zsType||'random';winCondition=data.winCond||'domination';
    playerCount=data.playerCount||2;localIdx=mpPid;
    const myName=data.slots[mpPid].name;
    player.name=myName;player.cash=setupCash;player.color=PLAYER_COLORS[mpPid];
    // Initialize remote players from slots
    players=[];
    data.slots.forEach((slot,i)=>{
      if(i===mpPid){players.push(player);return}
      const rp={pid:i,name:slot.name||(HQ_CITIES[i]+' AI'),cash:setupCash,mrr:0,arr:0,
        customers:[],units:[],buildings:[],tech:{},color:PLAYER_COLORS[i],
        hqCity:HQ_CITIES[i],taBuilt:false,isAI:!slot.name,techBuild:{}};
      players.push(rp);
    });
    enemy=players.find(p=>p!==player)||players[1]; // backward compat
    document.getElementById('companyName').textContent=myName;
    mpSeed=data.seed;
    startGame(true);
    mpSyncLoop();
  }catch(e){alert('Failed to start: '+e.message)}
}
let mpSeed=42;
function mpRandom(){mpSeed=(mpSeed*16807+0)%2147483647;return(mpSeed-1)/2147483646}

async function mpSyncLoop(){
  if(!gameRunning||!mpMode)return;
  try{
    // Write our actions
    if(mpActionQueue.length>0){
      const key='crm-actions:'+mpRoom+':'+mpPid;
      let existing=[];
      try{const r=await window.storage.get(key,true);if(r)existing=JSON.parse(r.value)}catch(e){}
      existing.push(...mpActionQueue);
      await window.storage.set(key,JSON.stringify(existing),true);
      mpActionQueue=[];
    }
    // Read all remote players' actions
    for(let pid=0;pid<players.length;pid++){
      if(pid===mpPid||players[pid].isAI)continue;
      const oppKey='crm-actions:'+mpRoom+':'+pid;
      try{
        const r=await window.storage.get(oppKey,true);
        if(r){
          const actions=JSON.parse(r.value);
          const last=mpLastSync[pid]||0;
          if(actions.length>last){
            for(let i=last;i<actions.length;i++)mpApplyAction(actions[i],pid);
            mpLastSync[pid]=actions.length;
          }
        }
      }catch(e){}
    }
    // Write our state summary
    const stateKey='crm-state:'+mpRoom+':'+mpPid;
    const myState={cash:Math.floor(player.cash),mrr:Math.floor(player.arr),custs:player.customers.length,
      units:player.units.map(u=>({type:u.type,x:Math.round(u.x*10)/10,y:Math.round(u.y*10)/10,state:u.state})),
      buildings:player.buildings.map(b=>({type:b.type,x:b.x,y:b.y})),t:gameTime};
    await window.storage.set(stateKey,JSON.stringify(myState),true);
    // Read all remote players' state
    for(let pid=0;pid<players.length;pid++){
      if(pid===mpPid||players[pid].isAI)continue;
      const rp=players[pid];
      const oppStateKey='crm-state:'+mpRoom+':'+pid;
      try{
        const r=await window.storage.get(oppStateKey,true);
        if(r){
          const os=JSON.parse(r.value);
          while(rp.units.length<os.units.length){
            const eu=os.units[rp.units.length];
            rp.units.push(createUnit(eu.type,rp,eu.x,eu.y));
          }
          os.units.forEach((eu,i)=>{if(rp.units[i]){
            rp.units[i].px=rp.units[i].x;rp.units[i].py=rp.units[i].y;
            rp.units[i].x=eu.x;rp.units[i].y=eu.y;rp.units[i].state=eu.state}});
          while(rp.buildings.length<os.buildings.length){
            const eb=os.buildings[rp.buildings.length];
            rp.buildings.push({type:eb.type,x:eb.x,y:eb.y});
          }
          rp.cash=os.cash;rp.arr=os.arr;
        }
      }catch(e){}
    }
  }catch(e){}
  setTimeout(mpSyncLoop,250);
}

function mpApplyAction(a,fromPid){
  const rp=players[fromPid];if(!rp)return;
  if(a.type==='build'){
    if(BLDGS[a.btype]){const b=rp.buildings[0];if(b)rp.buildings.push({type:a.btype,x:b.x+(a.ox||0),y:b.y+(a.oy||0)})}
  } else if(a.type==='hire'){
    if(UNITS_DEF[a.utype]){const b=rp.buildings[0];if(b)rp.units.push(createUnit(a.utype,rp,b.x+(Math.random()-0.5)*2,b.y+(Math.random()-0.5)*2))}
  } else if(a.type==='research'){
    if(TECHS[a.tech])rp.tech[a.tech]=true;
  } else if(a.type==='fire'){
    if(a.uid>=0&&a.uid<rp.units.length)rp.units.splice(a.uid,1);
  } else if(a.type==='command'){
    const u=rp.units[a.uid];if(!u)return;
    if(a.cid!==undefined){const c=allCust[a.cid];if(c){u.target=c;u.tx=c.x;u.ty=c.y;u.state='moving'}}
    else{u.tx=a.tx;u.ty=a.ty;u.target=null;u.state='moving'}
  }
}

function pickOpt(el){
  const row=el.parentElement;
  row.querySelectorAll('.setup-opt').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}
let setupMode='ai'; // 'ai' or 'mp'
function showSetup(mode){
  setupMode=mode;
  document.getElementById('mainMenu').style.display='none';
  document.getElementById('setupScreen').style.display='block';
  document.getElementById('aiSettings').style.display=mode==='ai'?'block':'none';
  document.getElementById('mpSettings').style.display=mode==='mp'?'block':'none';
  document.getElementById('startSoloBtn').style.display=mode==='ai'?'block':'none';
  document.getElementById('startSoloBtn').textContent=mode==='ai'?'‚öî START vs AI':'';
  unmuteMusic();
}
function showMenu(){
  document.getElementById('mainMenu').style.display='block';
  document.getElementById('setupScreen').style.display='none';
}
function getSetupVal(containerId){
  const el=document.querySelector('#'+containerId+' .setup-opt.active');
  if(!el)return null;const v=el.dataset.val;const n=parseFloat(v);return isNaN(n)?v:n;
}
function launchGame(){
  const name=(document.getElementById('setupName').value||'STARTUP INC.').trim().toUpperCase();
  setupCash=getSetupVal('cashOptions')||500;
  setupReps=getSetupVal('repOptions')||2;
  setupMarket=getSetupVal('marketOptions')||1;
  gameMode=getSetupVal('modeOptions')||'standard';
  zeroSumType=getSetupVal('zeroSumSub')||'random';
  oppStart=getSetupVal('oppStartOptions')||'slight';
  winCondition=getSetupVal('winCondOptions')||'domination';
  aiDifficulty=parseInt(document.getElementById('aiDiffSlider').value)||3;
  playerCount=getSetupVal('playerCountOptions')||2;
  player.name=name;player.cash=setupCash;
  document.getElementById('companyName').textContent=name;
  startGame();
}

const PLAYER_COLORS=['#00ff41','#ff3333','#3388ff','#ffcc00'];
const PLAYER_RGBS=['0,255,65','255,51,51','51,136,255','255,204,0'];
const HQ_CITIES=['Dublin','London','Edinburgh','Cork'];
let players=[],localIdx=0,playerCount=2;
let player={name:'STARTUP INC.',cash:500,mrr:0,arr:0,customers:[],units:[],buildings:[],tech:{},color:'#00ff41',hqCity:'Dublin',taBuilt:false,isAI:false,pid:0};
let enemy={name:'MEGACRM CORP.',cash:800,mrr:120,arr:0,customers:[],units:[],buildings:[],tech:{basic_crm:true},color:'#ff3333',hqCity:'London',taBuilt:false,isAI:true,pid:1};
let freeCust=[],allCust=[];
function getOpponents(p){return players.filter(o=>o!==p)}
function getAllEnemyUnits(p){return players.filter(o=>o!==p).flatMap(o=>o.units)}
function getAllEnemyCustomers(p){return players.filter(o=>o!==p).flatMap(o=>o.customers)}

// UK & Ireland cities with map positions and customer density
// Convert real lat/lng to game tile coords
// lng range: -10.5 to 2.0 ‚Üí x: 2 to 47  (west=left, east=right)
// lat range: 49.5 to 59.0 ‚Üí y: 47 to 2   (north=top/low-y, south=bottom/high-y)
function geoToTile(lng,lat){
  const x=2+(lng-(-10.5))/(2.0-(-10.5))*45;
  const y=47-(lat-49.5)/(59.0-49.5)*45;
  return[Math.round(x*10)/10,Math.round(y*10)/10];
}

const CITIES=[
  {name:'Dublin',     ...cxy(-6.26,53.35), size:3, customers:14},
  {name:'Cork',       ...cxy(-8.47,51.90), size:2, customers:6},
  {name:'Galway',     ...cxy(-9.05,53.27), size:1.5,customers:5},
  {name:'Belfast',    ...cxy(-5.93,54.60), size:2, customers:7},
  {name:'Limerick',   ...cxy(-8.63,52.66), size:1.5,customers:4},
  {name:'Waterford',  ...cxy(-7.11,52.26), size:1,customers:2},
  {name:'Derry',      ...cxy(-7.32,55.00), size:1.5,customers:3},
  {name:'London',     ...cxy(-0.13,51.51), size:4, customers:18},
  {name:'Manchester', ...cxy(-2.24,53.48), size:2.5,customers:10},
  {name:'Birmingham', ...cxy(-1.90,52.49), size:2.5,customers:9},
  {name:'Edinburgh',  ...cxy(-3.19,55.95), size:2, customers:8},
  {name:'Glasgow',    ...cxy(-4.25,55.86), size:2, customers:7},
  {name:'Leeds',      ...cxy(-1.55,53.80), size:2, customers:7},
  {name:'Bristol',    ...cxy(-2.59,51.45), size:2, customers:6},
  {name:'Liverpool',  ...cxy(-2.98,53.41), size:2, customers:6},
  {name:'Cardiff',    ...cxy(-3.18,51.48), size:1.5,customers:5},
  {name:'Newcastle',  ...cxy(-1.61,54.98), size:1.5,customers:4},
  {name:'Aberdeen',   ...cxy(-2.09,57.15), size:1.5,customers:3},
  {name:'Cambridge',  ...cxy(0.12,52.21),  size:1.5,customers:4},
];
function cxy(lng,lat){const t=geoToTile(lng,lat);return{x:t[0],y:t[1]}}

// Detailed coastline outlines from real coordinates
// Ireland ‚Äî full island including Donegal, Malin Head, and all of the north
const IRELAND_OUTLINE=[
  // Northeast ‚Äî starting at Carlingford, up through NI coast
  [-6.05,54.04],[-5.85,54.18],[-5.55,54.25],[-5.47,54.42],[-5.45,54.58],[-5.55,54.65],[-5.70,54.70],
  [-5.93,54.60],[-6.10,54.55],[-6.25,54.48],[-6.33,54.38],[-6.50,54.25],[-6.75,54.18],
  // North coast NI ‚Üí Donegal
  [-7.10,54.20],[-7.32,54.15],[-7.45,54.28],[-7.60,54.32],[-7.72,54.38],[-7.85,54.40],[-8.02,54.42],
  // Donegal ‚Äî Malin Head and northwest
  [-7.80,54.55],[-7.60,54.68],[-7.50,54.80],[-7.35,54.98],[-7.40,55.10],[-7.30,55.22],[-7.38,55.38],
  [-7.10,55.28],[-6.95,55.20],[-6.80,55.15],[-6.62,55.17],
  // North Donegal coast east
  [-6.45,55.23],[-6.25,55.30],[-6.10,55.28],[-5.90,55.20],[-5.80,55.10],[-5.90,54.98],[-6.00,54.85],
  // Back south down through Antrim coast already covered, skip to Lough Foyle
  [-7.00,55.05],
  // West Donegal coast going south
  [-8.28,54.68],[-8.62,54.68],[-8.80,54.55],[-9.05,54.28],[-9.50,54.25],[-9.88,54.22],
  // West coast ‚Äî Galway, Clare, Kerry
  [-10.05,53.65],[-10.18,53.55],[-9.95,53.25],[-9.80,53.10],[-9.95,52.80],[-10.35,52.15],
  // Southwest ‚Äî Cork, Kerry peninsulas  
  [-10.10,51.85],[-9.75,51.70],[-9.45,51.55],[-9.00,51.52],[-8.50,51.63],
  // South coast
  [-8.10,51.58],[-7.60,51.55],[-7.20,51.78],[-6.96,52.00],[-6.90,52.18],
  // Southeast coast
  [-6.38,52.20],[-6.12,52.38],[-6.05,52.60],[-6.20,52.80],
  // East coast ‚Äî Dublin area
  [-6.00,53.00],[-5.85,53.20],[-5.93,53.42],[-6.05,53.50],[-6.20,53.64],
  [-6.12,53.74],[-5.95,53.85],[-5.85,54.00],[-6.05,54.04]
].map(p=>geoToTile(p[0],p[1]));

// Great Britain ‚Äî ~65 points
const UK_OUTLINE=[
  // South coast
  [-5.70,50.08],[-5.05,50.05],[-4.20,50.35],[-3.55,50.22],[-2.80,50.72],[-1.95,50.72],[-1.30,50.77],
  [-0.78,50.73],[0.10,50.78],[0.70,51.08],[1.28,51.10],[1.45,51.38],[1.40,51.58],[1.10,51.78],
  // East coast
  [0.95,51.82],[0.90,52.00],[0.50,52.10],[0.30,52.50],[0.45,52.75],[0.18,52.92],[0.05,53.10],
  [0.08,53.52],[-0.08,53.65],[-0.18,53.90],[-0.40,54.10],[-0.70,54.30],[-1.15,54.62],[-1.25,54.85],
  [-1.50,55.15],[-1.62,55.60],[-1.78,55.80],[-2.00,55.82],[-2.10,56.00],[-1.82,56.32],[-2.00,56.50],
  [-2.22,56.62],[-2.50,56.72],[-1.80,57.45],[-2.00,57.68],[-3.10,58.45],[-3.30,58.60],[-3.95,58.58],
  // North Scotland
  [-5.00,58.60],[-5.20,58.25],[-5.60,57.90],[-5.10,57.52],[-5.50,57.25],[-5.80,57.58],[-5.65,57.85],
  // West Scotland
  [-5.10,56.80],[-5.70,56.50],[-5.40,56.10],[-5.62,55.95],[-5.15,55.85],[-4.85,55.98],
  [-4.90,55.75],[-5.05,55.60],[-4.60,55.45],[-4.85,55.30],[-5.15,55.18],[-4.90,54.95],
  // England west coast
  [-3.50,54.85],[-3.20,54.70],[-3.40,54.45],[-3.10,54.10],[-3.08,53.80],[-2.95,53.40],[-3.10,53.20],
  [-3.00,53.08],[-3.10,52.88],[-4.10,52.90],[-4.70,52.80],[-4.90,52.42],[-5.20,51.90],[-5.25,51.62],
  [-4.65,51.55],[-4.28,51.42],[-3.50,51.38],[-3.22,51.40],[-2.70,51.58],[-2.68,51.32],[-3.30,50.95],
  [-3.70,50.68],[-4.50,50.55],[-5.10,50.32],[-5.55,50.12],[-5.70,50.08]
].map(p=>geoToTile(p[0],p[1]));

const BLDGS={
  office:{name:'Sales Office',icon:'üè¢',cost:100,desc:'Hire sales reps (cap +5)',capacity:5,buildTime:8},
  marketing_dept:{name:'Marketing Dept',icon:'üì¢',cost:200,desc:'Hire marketers',requires:'office',buildTime:12},
  support_center:{name:'CS Center',icon:'üéß',cost:250,desc:'Hire Customer Success reps',requires:'office',buildTime:12},
  research_lab:{name:'R&D Lab',icon:'üî¨',cost:300,desc:'Unlock research',requires:'office',buildTime:15},
  hq_upgrade:{name:'HQ Upgrade',icon:'üèõ',cost:500,desc:'+10 unit capacity',requires:'research_lab',buildTime:20},
  ai_datacenter:{name:'AI Data Center',icon:'ü§ñ',cost:600,desc:'Unlock AI tree',requires:'research_lab',buildTime:25},
  hr_dept:{name:'HR Department',icon:'üë©‚Äçüíº',cost:250,desc:'Hire Talent Acquisition',requires:'office',buildTime:15},
  m_and_a_dept:{name:'M&A Dept',icon:'üè¶',cost:400,desc:'Enables hostile takeovers',requires:'research_lab',buildTime:20}
};
const UNITS_DEF={
  sales_rep:{name:'Sales Rep',icon:'üï¥',cost:50,salary:8,speed:1,power:1,desc:'Converts free prospects',requires:'office',buildTime:5},
  sr_sales_rep:{name:'Sr. Sales Rep',icon:'üíº',cost:100,salary:15,speed:1.3,power:2,desc:'Can steal enemy accounts',requires:'office',techReq:'advanced_sales',buildTime:8},
  marketer:{name:'Marketer',icon:'üì£',cost:80,salary:10,speed:0.9,power:0,desc:'Sabotages enemy loyalty & boosts prospect spawns',requires:'marketing_dept',buildTime:6},
  service_rep:{name:'CS Rep',icon:'üõ°',cost:70,salary:10,speed:0.7,power:0,desc:'Defends customers from poaching',requires:'support_center',buildTime:6},
  ai_agent:{name:'AI SDR',icon:'ü§ñ',cost:150,salary:5,speed:2,power:3,desc:'AI-powered super rep',requires:'ai_datacenter',techReq:'ai_first',buildTime:12},
  talent_acq:{name:'Talent Acquisition',icon:'üéØ',cost:200,salary:20,speed:0.8,power:0,desc:'Poaches enemy top talent',requires:'hr_dept',buildTime:15}
};
const TECHS={
  basic_crm:{name:'Basic CRM',icon:'üíæ',cost:80,desc:'+20% close rate',requires:'research_lab',buildTime:10},
  advanced_sales:{name:'Advanced Sales',icon:'üìä',cost:150,desc:'Unlock Sr. Reps',requires:'research_lab',techReq:'basic_crm',buildTime:15},
  marketing_automation:{name:'Marketing Auto',icon:'‚ö°',cost:180,desc:'Marketers 2x range',requires:'research_lab',techReq:'basic_crm',buildTime:15},
  customer_success:{name:'Cust. Success',icon:'‚≠ê',cost:200,desc:'CS Rep 2x defense range',requires:'support_center',techReq:'basic_crm',buildTime:15},
  ai_first:{name:'AI-First Platform',icon:'üß†',cost:400,desc:'Unlock AI SDR',requires:'ai_datacenter',techReq:'advanced_sales',buildTime:25},
  enterprise:{name:'Enterprise Ed.',icon:'üè¢',cost:300,desc:'Accounts 2x MRR',requires:'research_lab',techReq:'advanced_sales',buildTime:20}
};

function toIso(x,y){return{x:(x-y)*(TW/2),y:(x+y)*(TH/2)}}
function fromIso(sx,sy){const a=sx/(TW/2),b=sy/(TH/2);return{x:Math.floor((a+b)/2),y:Math.floor((b-a)/2)}}

// ---- Pre-render static map ----
let offMap=null;
function prerenderMap(){
  const tl=toIso(0,MAP),tr=toIso(MAP,0),top=toIso(0,0),bot=toIso(MAP,MAP);
  const pad=80;
  const minX=tl.x-pad,maxX=tr.x+pad,minY=top.y-pad,maxY=bot.y+pad;
  offMap=document.createElement('canvas');
  offMap.width=maxX-minX;offMap.height=maxY-minY;
  const c=offMap.getContext('2d');c.translate(-minX,-minY);
  offMap._ox=minX;offMap._oy=minY;

  // Grid
  c.strokeStyle=`rgba(30,32,53,${gridOpacity})`;c.lineWidth=0.5;
  for(let x=0;x<=MAP;x++){const s=toIso(x,0),e=toIso(x,MAP);c.beginPath();c.moveTo(s.x,s.y);c.lineTo(e.x,e.y);c.stroke()}
  for(let y=0;y<=MAP;y++){const s=toIso(0,y),e=toIso(MAP,y);c.beginPath();c.moveTo(s.x,s.y);c.lineTo(e.x,e.y);c.stroke()}

  // Map border
  c.strokeStyle='rgba(0,255,65,0.12)';c.lineWidth=1;
  const c1=toIso(0,0),c2=toIso(MAP,0),c3=toIso(MAP,MAP),c4=toIso(0,MAP);
  c.beginPath();c.moveTo(c1.x,c1.y);c.lineTo(c2.x,c2.y);c.lineTo(c3.x,c3.y);c.lineTo(c4.x,c4.y);c.closePath();c.stroke();

  // Draw landmass outlines (subtle territory feel)
  function drawLandmass(outline,fillColor,strokeColor){
    c.beginPath();
    outline.forEach((p,i)=>{const iso=toIso(p[0],p[1]);i===0?c.moveTo(iso.x,iso.y):c.lineTo(iso.x,iso.y)});
    c.closePath();
    c.fillStyle=fillColor;c.fill();
    c.strokeStyle=strokeColor;c.lineWidth=1.5;c.stroke();
  }
  drawLandmass(IRELAND_OUTLINE,'rgba(20,35,40,0.45)','rgba(80,180,220,0.12)');
  drawLandmass(UK_OUTLINE,'rgba(20,35,40,0.45)','rgba(80,180,220,0.12)');

  // Draw city zones ‚Äî soft glowing circles
  CITIES.forEach(city=>{
    const iso=toIso(city.x,city.y);
    const r=city.size*TW*0.6;
    const g=c.createRadialGradient(iso.x,iso.y,0,iso.x,iso.y,r);
    g.addColorStop(0,'rgba(60,80,100,0.25)');
    g.addColorStop(0.7,'rgba(40,50,70,0.1)');
    g.addColorStop(1,'rgba(0,0,0,0)');
    c.fillStyle=g;c.beginPath();c.arc(iso.x,iso.y,r,0,Math.PI*2);c.fill();

    // City name label
    if(showLabels){c.font='bold 9px Orbitron,sans-serif';c.textAlign='center';
    c.fillStyle='rgba(150,170,200,0.5)';
    c.fillText(city.name.toUpperCase(),iso.x,iso.y+r*0.5+12);}

    // Dot
    c.fillStyle='rgba(100,140,180,0.4)';
    c.beginPath();c.arc(iso.x,iso.y,3,0,Math.PI*2);c.fill();
  });
}

// ---- Customers clustered around cities ----
function generateCustomers(){
  allCust=[];freeCust=[];
  let _s=mpSeed;const rng=mpMode?function(){_s=(_s*16807+0)%2147483647;return(_s-1)/2147483646}:Math.random;
  CITIES.forEach(city=>{
    const count=Math.max(1,Math.round(city.customers*setupMarket));
    for(let i=0;i<count;i++){
      const angle=rng()*Math.PI*2;
      const dist=rng()*city.size*1.5;
      const x=city.x+Math.cos(angle)*dist;
      const y=city.y+Math.sin(angle)*dist;
      const c={id:allCust.length,x,y,px:x,py:y,value:1+Math.floor(rng()*12),owner:null,loyalty:0,
        size:0.5+rng()*0.8,pp:rng()*Math.PI*2,city:city.name};
      allCust.push(c);freeCust.push(c);
    }
  });
  TOTAL_CUST=allCust.length;
  if(gameMode==='zero_sum'){
    if(zeroSumType==='territorial'){
      // Territorial ‚Äî assign each customer to nearest HQ
      freeCust.forEach(c=>{
        let best=null,bestD=Infinity;
        players.forEach(p=>{const hq=CITIES.find(ct=>ct.name===p.hqCity);if(!hq)return;const d=Math.sqrt((c.x-hq.x)**2+(c.y-hq.y)**2);if(d<bestD){bestD=d;best=p}});
        if(best){c.owner=best;c.loyalty=80;best.customers.push(c)}
      });
      freeCust.length=0;
    } else {
      // Random even split among all players
      const shuffled=[...freeCust];for(let i=shuffled.length-1;i>0;i--){const j=Math.floor(rng()*i);[shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]]}
      shuffled.forEach((c,i)=>{const p=players[i%players.length];c.owner=p;c.loyalty=80;p.customers.push(c)});
      freeCust.length=0;
    }
    players.forEach(p=>{p.arr=p.customers.reduce((s,c)=>s+c.value,0)});
  } else if(!mpMode){
    // Each AI starts with customers near their HQ
    const aiPlayers=players.filter(p=>p.isAI);
    const enemyCount=Math.max(2,Math.round(8*setupMarket));
    aiPlayers.forEach(aiP=>{
      const nearby=freeCust.filter(c=>c.city===aiP.hqCity).slice(0,enemyCount);
      nearby.forEach(c=>{c.owner=aiP;c.loyalty=80;aiP.customers.push(c);
        const i=freeCust.indexOf(c);if(i>=0)freeCust.splice(i,1)});
      aiP.arr=aiP.customers.reduce((s,c)=>s+c.value,0);
    });
  }
}

function createUnit(type,owner,x,y){
  const d=UNITS_DEF[type];
  const u={type,owner,x,y,px:x,py:y,tx:x,ty:y,target:null,state:'idle',progress:0,pProgress:0,
    speed:d.speed,power:d.power,salary:d.salary,anim:Math.random()*Math.PI*2,pAnim:0,
    // Experience tracking
    dealsWon:0,dealsStolen:0,revGen:0,bornAt:gameTime,
    nickname:genNickname(type,owner)};
  if(type==='talent_acq'){u.recruitTarget=null;u.recruitProgress=0;u.pRecruitProgress=0;u.negotiatingWith=null;u.negotiationProgress=50;u.pNegotiationProgress=50}
  return u;
}
const FIRST_NAMES=['Alex','Sam','Jordan','Morgan','Riley','Casey','Taylor','Quinn','Avery','Blake','Drew','Pat','Robin','Jamie','Lee','Kim','Ash','Sky','Max','Sage'];
const LAST_INITIALS='ABCDEFGHJKLMNPRSTW';
function genNickname(type,owner){
  if(type==='ai_agent')return'AI-'+Math.floor(Math.random()*900+100);
  if(type==='talent_acq')return'HR-'+FIRST_NAMES[Math.floor(Math.random()*FIRST_NAMES.length)];
  return FIRST_NAMES[Math.floor(Math.random()*FIRST_NAMES.length)]+' '+LAST_INITIALS[Math.floor(Math.random()*LAST_INITIALS.length)]+'.';
}

// ---- INIT ----
function startGame(isMultiplayer){
  switchMusic('game');
  document.getElementById('titleScreen').style.display='none';
  document.getElementById('gameContainer').style.display='block';
  canvas=document.getElementById('gameCanvas');ctx=canvas.getContext('2d');
  mmCanvas=document.getElementById('minimap');mmCtx=mmCanvas.getContext('2d');
  resizeCanvas();window.addEventListener('resize',resizeCanvas);
  prerenderMap();generateCustomers();

  // ---- INITIALIZE PLAYERS ARRAY ----
  const AI_NAMES=['MEGACRM CORP.','CLOUDSELL INC.','DATAPIPE CO.'];
  // Reset player object
  player.customers=[];player.units=[];player.buildings=[];player.tech={};player.taBuilt=false;player.isAI=false;player.pid=0;player.color=PLAYER_COLORS[0];player.arr=0;
  players=[player];
  localIdx=0;

  // Create AI/remote opponents
  for(let pi=1;pi<playerCount;pi++){
    const aiP={name:AI_NAMES[pi-1]||('RIVAL '+pi),cash:800,mrr:0,arr:0,customers:[],units:[],buildings:[],tech:{},
      color:PLAYER_COLORS[pi],hqCity:HQ_CITIES[pi]||HQ_CITIES[1],taBuilt:false,isAI:!mpMode,pid:pi};
    players.push(aiP);
  }
  // Backward-compat: enemy = first opponent
  enemy=players[1];

  // My HQ
  const myCity=CITIES.find(c=>c.name===player.hqCity);
  player.buildings.push({type:'office',x:myCity.x,y:myCity.y});
  for(let i=0;i<setupReps;i++){
    player.units.push(createUnit('sales_rep',player,myCity.x+(Math.random()-0.5)*1.5,myCity.y+(Math.random()-0.5)*1.5));
  }

  if(!mpMode){
    // Setup each AI opponent
    for(let pi=1;pi<playerCount;pi++){
      const aiP=players[pi];
      const hqCity=CITIES.find(c=>c.name===aiP.hqCity);
      if(!hqCity)continue;
      aiP.buildings.push({type:'office',x:hqCity.x,y:hqCity.y});
      if(oppStart==='even'){
        aiP.cash=setupCash;
        for(let i=0;i<setupReps;i++){
          aiP.units.push(createUnit('sales_rep',aiP,hqCity.x+(Math.random()-0.5)*1.5,hqCity.y+(Math.random()-0.5)*1.5));
        }
      } else if(oppStart==='slight'){
        aiP.buildings.push({type:'marketing_dept',x:hqCity.x-1,y:hqCity.y});
        aiP.cash=Math.round(setupCash*1.5);
        const enemyReps=Math.max(setupReps+1,Math.round(3*setupMarket));
        for(let i=0;i<enemyReps;i++){
          aiP.units.push(createUnit('sales_rep',aiP,hqCity.x+(Math.random()-0.5)*1.5,hqCity.y+(Math.random()-0.5)*1.5));
        }
      } else {
        aiP.buildings.push({type:'marketing_dept',x:hqCity.x-1,y:hqCity.y});
        aiP.buildings.push({type:'research_lab',x:hqCity.x+1,y:hqCity.y+1});
        aiP.buildings.push({type:'support_center',x:hqCity.x-1,y:hqCity.y+1});
        aiP.cash=Math.round(setupCash*2.5);
        aiP.tech.basic_crm=true;
        const enemyReps=Math.max(4,Math.round(5*setupMarket));
        for(let i=0;i<enemyReps;i++){
          const t=i<2?'sales_rep':i<3?'marketer':'sales_rep';
          aiP.units.push(createUnit(t,aiP,hqCity.x+(Math.random()-0.5)*2,hqCity.y+(Math.random()-0.5)*2));
        }
        aiP.units.push(createUnit('service_rep',aiP,hqCity.x+0.5,hqCity.y-0.5));
      }
    }
  } else {
    // Multiplayer ‚Äî remote players start at their cities, synced via storage
    players.filter(p=>p!==player).forEach(rp=>{
      const rpCity=CITIES.find(c=>c.name===rp.hqCity);
      if(rpCity){rp.buildings.push({type:'office',x:rpCity.x,y:rpCity.y});rp.cash=setupCash}
    });
  }

  const iso=toIso(myCity.x,myCity.y);camX=iso.x-window.innerWidth/2;camY=iso.y-window.innerHeight/2;
  setupInput();updateUI();gameRunning=true;
  if(mpMode){
    const oppNames=players.filter(p=>p!==player).map(p=>p.name).join(' vs ');
    addLog(player.name+' vs '+oppNames+' ‚Äî HEAD TO HEAD!','neutral');
    addLog('You are Player '+(mpPid+1)+'. HQ: '+player.hqCity,'neutral');
  } else {
    addLog(player.name+' HQ established in '+player.hqCity+'. Go win the UK & Ireland market!','neutral');
    players.filter(p=>p!==player).forEach(p=>addLog(p.name+' based in '+p.hqCity+'.','negative'));
  }
  requestAnimationFrame(gameLoop);
}
function resizeCanvas(){if(!canvas)return;canvas.width=window.innerWidth;canvas.height=window.innerHeight;mmCanvas.width=200;mmCanvas.height=260}

// ---- INPUT ----
function setupInput(){
  document.querySelectorAll('.scroll-zone').forEach(z=>{
    z.addEventListener('mouseenter',()=>{const d=z.dataset.dir;if(d==='up')edgeDir.y=-10;if(d==='down')edgeDir.y=10;if(d==='left')edgeDir.x=-10;if(d==='right')edgeDir.x=10});
    z.addEventListener('mouseleave',()=>{const d=z.dataset.dir;if(d==='up'||d==='down')edgeDir.y=0;if(d==='left'||d==='right')edgeDir.x=0});
  });
  canvas.addEventListener('wheel',e=>{e.preventDefault();const o=zoom;
    zoom=e.deltaY<0?Math.min(2.5,zoom+0.08):Math.max(0.25,zoom-0.08);
    const mx=e.clientX,my=e.clientY-48;camX=(mx/o+camX)-mx/zoom;camY=(my/o+camY)-my/zoom;
    document.getElementById('zoomLevel').textContent=Math.round(zoom*100)+'%'},{passive:false});
  canvas.addEventListener('mousedown',e=>{
    dragSX=e.clientX;dragSY=e.clientY;camSX=camX;camSY=camY;dragMoved=false;
    if(e.button===0&&keysDown.has(' ')){// Space+left = pan
      isDrag=true;
    } else if(e.button===0){// Left click ‚Äî will be box-select or click
      boxSelecting=false;boxSX=e.clientX;boxSY=e.clientY;boxEX=e.clientX;boxEY=e.clientY;isDrag=false;
    } else if(e.button===1||e.button===2){// Middle or right ‚Äî pan
      isDrag=true;e.preventDefault();
    }
  });
  canvas.addEventListener('mousemove',e=>{
    if(isDrag){// Camera pan
      const dx=e.clientX-dragSX,dy=e.clientY-dragSY;
      if(Math.abs(dx)>2||Math.abs(dy)>2){dragMoved=true;camX=camSX-dx/zoom;camY=camSY-dy/zoom}
    } else if(e.buttons===1&&!keysDown.has(' ')){// Left held ‚Äî box select
      boxEX=e.clientX;boxEY=e.clientY;
      if(Math.abs(boxEX-boxSX)>8||Math.abs(boxEY-boxSY)>8){boxSelecting=true;dragMoved=true}
    }
  });
  canvas.addEventListener('mouseup',e=>{
    if(e.button===0){
      if(boxSelecting){finishBoxSelect();boxSelecting=false}
      else if(!dragMoved)handleClick(e);
    }
    isDrag=false;dragMoved=false;
  });
  canvas.addEventListener('contextmenu',e=>{e.preventDefault();if(!dragMoved)handleRClick(e)});
  canvas.addEventListener('dblclick',e=>handleDblClick(e));
  document.addEventListener('keydown',e=>{if(e.key===' ')e.preventDefault();keysDown.add(e.key.toLowerCase());if(e.key==='Escape'){selectedUnit=null;selectedUnits=[];inspectedUnit=null}});
  document.addEventListener('keyup',e=>keysDown.delete(e.key.toLowerCase()));
}
function finishBoxSelect(){
  // Convert screen box to world coords
  const x1=Math.min(boxSX,boxEX)/zoom+camX, y1=(Math.min(boxSY,boxEY)-48)/zoom+camY;
  const x2=Math.max(boxSX,boxEX)/zoom+camX, y2=(Math.max(boxSY,boxEY)-48)/zoom+camY;
  selectedUnits=[];selectedUnit=null;
  player.units.forEach(u=>{
    const i=toIso(u.x,u.y);
    if(i.x>=x1&&i.x<=x2&&i.y>=y1&&i.y<=y2)selectedUnits.push(u);
  });
  if(selectedUnits.length===1){selectedUnit=selectedUnits[0];selectedUnits=[]}
  else if(selectedUnits.length>1)addLog('Selected '+selectedUnits.length+' units','neutral');
}
let inspectedUnit=null; // unit being inspected (can be enemy)
function handleClick(e){const wx=e.clientX/zoom+camX,wy=(e.clientY-48)/zoom+camY;
  // Check if clicking own unit ‚Äî select it
  for(const u of player.units){const i=toIso(u.x,u.y);if(Math.abs(wx-i.x)<18&&Math.abs(wy-i.y)<18){selectedUnit=u;selectedUnits=[];inspectedUnit=null;voiceSelect(u);return}}
  // Check if clicking enemy unit ‚Äî inspect it
  for(const u of getAllEnemyUnits(player)){const i=toIso(u.x,u.y);if(Math.abs(wx-i.x)<18&&Math.abs(wy-i.y)<18){inspectedUnit=u;selectedUnit=null;selectedUnits=[];return}}
  inspectedUnit=null;
  // If we have selected units (multi), command them
  if(selectedUnits.length>0){cmdMulti(selectedUnits,wx,wy);return}
  if(selectedUnit)cmdUnit(selectedUnit,wx,wy)}
function handleDblClick(e){const wx=e.clientX/zoom+camX,wy=(e.clientY-48)/zoom+camY;
  // Double-click any unit to open inspector
  for(const u of players.flatMap(p=>p.units)){const i=toIso(u.x,u.y);if(Math.abs(wx-i.x)<18&&Math.abs(wy-i.y)<18){showUnitInspector(u);return}}
}
function handleRClick(e){const wx=e.clientX/zoom+camX,wy=(e.clientY-48)/zoom+camY;
  if(selectedUnits.length>0)cmdMulti(selectedUnits,wx,wy);
  else if(selectedUnit)cmdUnit(selectedUnit,wx,wy)}
function cmdUnit(u,wx,wy){
  let hit=null;for(const c of allCust){const i=toIso(c.x,c.y);if(Math.abs(wx-i.x)<14&&Math.abs(wy-i.y)<14){hit=c;break}}
  const uid=player.units.indexOf(u);
  if(hit){u.target=hit;u.tx=hit.x;u.ty=hit.y;u.state='moving';addLog('Rep ‚Üí '+hit.city+' #'+hit.id,'neutral');
    addWaypoint(hit.x,hit.y,hit,1);voiceCommand(u);
    if(mpMode&&uid>=0)mpActionQueue.push({type:'command',uid,cid:hit.id})}
  else{const t=fromIso(wx,wy);u.tx=Math.max(0,Math.min(MAP-1,t.x));u.ty=Math.max(0,Math.min(MAP-1,t.y));u.target=null;u.state='moving';
    addWaypoint(u.tx,u.ty,null,1);voiceCommand(u);
    if(mpMode&&uid>=0)mpActionQueue.push({type:'command',uid,tx:u.tx,ty:u.ty})}}
function cmdMulti(units,wx,wy){
  let hit=null;for(const c of allCust){const i=toIso(c.x,c.y);if(Math.abs(wx-i.x)<14&&Math.abs(wy-i.y)<14){hit=c;break}}
  let n=0;
  units.forEach((u,idx)=>{
    if(hit){u.target=hit;u.tx=hit.x+(Math.random()-0.5)*1.5;u.ty=hit.y+(Math.random()-0.5)*1.5;u.state='moving';n++}
    else{const t=fromIso(wx,wy);u.tx=Math.max(0,Math.min(MAP-1,t.x+(Math.random()-0.5)*2));u.ty=Math.max(0,Math.min(MAP-1,t.y+(Math.random()-0.5)*2));u.target=null;u.state='moving';n++}
  });
  if(hit){addLog(n+' reps ‚Üí '+hit.city+' #'+hit.id,'neutral');addWaypoint(hit.x,hit.y,hit,n)}
  else{addLog(n+' reps moving','neutral');const t=fromIso(wx,wy);addWaypoint(Math.max(0,Math.min(MAP-1,t.x)),Math.max(0,Math.min(MAP-1,t.y)),null,n)}
}
function addWaypoint(x,y,customer,count){
  waypoints.push({x,y,customer,count,time:performance.now(),alpha:1});
}
function updateCam(){const s=14/zoom;
  if(keysDown.has('arrowleft')||keysDown.has('a'))camX-=s;if(keysDown.has('arrowright')||keysDown.has('d'))camX+=s;
  if(keysDown.has('arrowup')||keysDown.has('w'))camY-=s;if(keysDown.has('arrowdown')||keysDown.has('s'))camY+=s;
  camX+=edgeDir.x/zoom;camY+=edgeDir.y/zoom}

// ---- GAME LOOP ----
let lastT=0,tickAcc=0;
function gameLoop(t){if(!gameRunning)return;const dt=Math.min(t-lastT,100);lastT=t;tickAcc+=dt*speedMul;
  while(tickAcc>=1000){tickAcc-=1000;
    // Store previous positions for interpolation
    players.flatMap(p=>p.units).forEach(u=>{u.px=u.x;u.py=u.y;u.pAnim=u.anim;u.pProgress=u.progress;if(u.type==='talent_acq'){u.pRecruitProgress=u.recruitProgress;u.pNegotiationProgress=u.negotiationProgress}});
    allCust.forEach(c=>{c.px=c.x;c.py=c.y});
    gameTick();
  }
  render(dt,tickAcc/1000);requestAnimationFrame(gameLoop)}
function gameTick(){
  gameTime++;
  // Build progress for buildings, units, and tech
  players.forEach(p=>{
    p.buildings.forEach(b=>{if(b.bp!==undefined&&b.bp<b.bt){b.bp++;if(b.bp>=b.bt){delete b.bp;delete b.bt;if(p===player){addLog(BLDGS[b.type].name+' complete!','positive');voiceSystem('buildComplete');lastBtnRebuild=0}}}});
    p.units.forEach(u=>{if(u.state==='building'&&u.bp!==undefined){u.bp++;if(u.bp>=u.bt){delete u.bp;delete u.bt;u.state='idle';if(p===player){addLog(UNITS_DEF[u.type].name+' ready!','positive');voiceSystem('trainComplete',u.type);lastBtnRebuild=0}}}});
    if(p.techBuild){Object.keys(p.techBuild).forEach(k=>{const tb=p.techBuild[k];tb.bp++;if(tb.bp>=tb.bt){p.tech[k]=true;delete p.techBuild[k];if(p===player){addLog(TECHS[k].name+' researched!','positive');voiceSystem('researchComplete');lastBtnRebuild=0}}})}
  });
  if(gameTime%5===0)players.forEach(p=>{const sal=p.units.filter(u=>u.state!=='building').reduce((s,u)=>s+u.salary,0);p.cash-=sal;p.arr=p.customers.reduce((s,c)=>s+c.value*(p.tech.enterprise===true?2:1),0);p.cash+=p.arr});
  players.flatMap(p=>p.units).forEach(actUnit);
  // Loyalty decay ‚Äî owned customers slowly lose loyalty without CS rep nearby
  allCust.forEach(c=>{
    if(c.owner){
      const defRange=c.owner.tech.customer_success?8:4;
      const hasCSRep=c.owner.units.some(u=>u.type==='service_rep'&&u.state!=='building'&&Math.sqrt((u.x-c.x)**2+(u.y-c.y)**2)<defRange);
      if(!hasCSRep){
        c.loyalty-=0.1;
        if(c.loyalty<=0){
          c.loyalty=0;const p=c.owner;const i=p.customers.indexOf(c);if(i>=0)p.customers.splice(i,1);
          c.owner=null;freeCust.push(c);
          addLog((p===player?'Your':p.name+"'s")+'  customer #'+c.id+' in '+c.city+' churned!',p===player?'negative':'positive');
          if(p===player)voiceSystem('customerChurned');
        }
      }
    }
  });
  // Growing market ‚Äî spawn new customers periodically (marketers boost spawn rate near their position)
  if(gameMode==='growing'&&gameTime%8===0){
    const allMarketers=players.flatMap(p=>p.units).filter(u=>u.type==='marketer'&&u.state!=='building');
    const baseChance=0.4;
    // Each marketer near a city boosts spawn chance by 15%
    const spawnCity=()=>{
      const city=CITIES[Math.floor(Math.random()*CITIES.length)];
      const nearbyMarketers=allMarketers.filter(m=>Math.sqrt((m.x-city.x)**2+(m.y-city.y)**2)<city.size*2).length;
      const chance=Math.min(0.9,baseChance+nearbyMarketers*0.15);
      if(Math.random()<chance){
        const angle=Math.random()*Math.PI*2,dist=Math.random()*city.size*1.5;
        const x=city.x+Math.cos(angle)*dist,y=city.y+Math.sin(angle)*dist;
        const c={id:allCust.length,x,y,px:x,py:y,value:1+Math.floor(Math.random()*12),owner:null,loyalty:0,
          size:0.5+Math.random()*0.8,pp:Math.random()*Math.PI*2,city:city.name};
        allCust.push(c);freeCust.push(c);TOTAL_CUST=allCust.length;
        if(gameTime%40===0)addLog('New prospect appeared in '+city.name+'!','neutral');
      }
    };
    spawnCity();
  }
  if(gameTime%3===0)players.filter(p=>p.isAI).forEach(aiP=>aiTick(aiP));
  // ---- AI ACQUISITION COUNTDOWN ----
  if(aiAcqCountdown>0){
    aiAcqCountdown--;
    if(!isDistressed(player)){aiAcqCountdown=0;addLog('Takeover averted! Balance sheet stabilized.','positive')}
    else if(aiAcqCountdown<=0){
      const acq=aiAcquirer||enemy;
      const n=executeAcquisition(acq,player);
      addLog('HOSTILE TAKEOVER! '+acq.name+' acquired '+n+' of your customers!','negative');
      voiceSystem('acquisitionComplete');
      if(winCondition==='elimination'){endGame(false,'elimination');return}
    } else if(aiAcqCountdown%10===0){
      addLog('‚ö† Takeover in '+aiAcqCountdown+' ticks! Cash: $'+Math.floor(player.cash)+'K','negative');
    }
  }
  // ---- VOICE MILESTONES ----
  const _pShare=TOTAL_CUST>0?player.customers.length/TOTAL_CUST:0;
  const _eShare=TOTAL_CUST>0?Math.max(...getOpponents(player).map(p=>p.customers.length))/TOTAL_CUST:0;
  if(_pShare>=0.25&&!voiceMilestones.has('share25')){voiceMilestones.add('share25');voiceSystem('winCondProgress')}
  if(_pShare>=0.50&&!voiceMilestones.has('share50')){voiceMilestones.add('share50');speakRandom(["You control half the market!","Fifty percent market share. Dominant."],'system')}
  if(_pShare>=0.75&&!voiceMilestones.has('share75')){voiceMilestones.add('share75');speakRandom(["Seventy-five percent! Total domination is near."],'system')}
  if(player.cash<100&&player.cash>0&&!voiceMilestones.has('lowCash')){voiceMilestones.add('lowCash');voiceSystem('lowCash')}
  if(player.cash>=100&&voiceMilestones.has('lowCash'))voiceMilestones.delete('lowCash'); // allow re-fire if cash recovers and drops again
  if(player.customers.length===1&&!voiceMilestones.has('firstDeal')){voiceMilestones.add('firstDeal');speakRandom(["First deal! We're in business!","Our first customer. Let's get more!"],'system')}
  if(_eShare>=0.50&&!voiceMilestones.has('enemyDom')){voiceMilestones.add('enemyDom');voiceSystem('enemyGrowing')}
  // Idle units warning
  if(gameTime%20===0){const idleCount=player.units.filter(u=>u.state==='idle'&&u.type!=='service_rep').length;if(idleCount>=2&&!voiceMilestones.has('idle'+gameTime)){voiceMilestones.add('idle'+gameTime);speakRandom(["Idle reps detected. Deploy them!","We have reps sitting around. Put them to work."],'system')}}
  // Burn > MRR warning
  if(gameTime%5===0){const sal=player.units.filter(u=>u.state!=='building').reduce((s,u)=>s+u.salary,0);if(sal>player.arr&&player.arr>0){burnExceedsMRRCount++}else{burnExceedsMRRCount=0}if(burnExceedsMRRCount>=3&&!voiceMilestones.has('bleeding')){voiceMilestones.add('bleeding');speakRandom(["We're bleeding cash.","Burn rate exceeds revenue. Cut costs or close deals."],'system')}}
  // Win condition checks (N-player)
  const pShare=TOTAL_CUST>0?player.customers.length/TOTAL_CUST:0;
  if(winCondition==='domination'){
    if(pShare>=0.75){endGame(true,'domination');return}
    for(const op of players){if(op!==player&&TOTAL_CUST>0&&op.customers.length/TOTAL_CUST>=0.75){endGame(false,'domination');return}}
  } else if(winCondition==='mrr_race'){
    if(player.arr>=500){endGame(true,'mrr_race');return}
    for(const op of players){if(op!==player&&op.arr>=500){endGame(false,'mrr_race');return}}
    if(gameTime>=500){const best=players.reduce((a,b)=>a.arr>=b.arr?a:b);endGame(best===player,'mrr_timeout');return}
  } else if(winCondition==='elimination'){
    if(player.cash<=0&&player.arr<=0){endGame(false,'elimination');return}
    const alive=players.filter(p=>p.cash>0||p.arr>0||p.customers.length>0);
    if(alive.length===1&&alive[0]===player){endGame(true,'elimination');return}
    if(alive.length===1&&alive[0]!==player){endGame(false,'elimination');return}
  } else if(winCondition==='conquest'){
    if(TOTAL_CUST>0&&player.customers.length===TOTAL_CUST){endGame(true,'conquest');return}
    for(const op of players){if(op!==player&&TOTAL_CUST>0&&op.customers.length===TOTAL_CUST){endGame(false,'conquest');return}}
  }
  // Fallback bankruptcy check for all modes
  if(winCondition!=='elimination'){
    if(player.cash<=0&&player.arr<=0&&player.customers.length===0){endGame(false,'bankrupt');return}
  }
  updateUI();
}
function actUnit(u){
  u.anim+=0.1;
  if(u.state==='building')return; // Under construction ‚Äî don't act

  // ---- TALENT ACQUISITION LOGIC ----
  if(u.type==='talent_acq'){
    const opp=players.find(p=>p!==u.owner)||enemy;
    const myTAColor=u.owner===player?'positive':'negative';

    // TA-vs-TA NEGOTIATION CHECK ‚Äî if recruiting/moving and enemy TA nearby, enter negotiation
    if((u.state==='recruiting'||u.state==='moving'||u.state==='idle')&&!u.negotiatingWith){
      const enemyTA=getAllEnemyUnits(u.owner).find(e=>e.type==='talent_acq'&&e.state!=='building'&&e.state!=='negotiating'&&Math.sqrt((u.x-e.x)**2+(u.y-e.y)**2)<3);
      if(enemyTA){
        u.state='negotiating';u.negotiatingWith=enemyTA;u.negotiationProgress=50;
        enemyTA.state='negotiating';enemyTA.negotiatingWith=u;enemyTA.negotiationProgress=50;
        u.recruitTarget=null;u.recruitProgress=0;
        enemyTA.recruitTarget=null;enemyTA.recruitProgress=0;
        addLog('Talent Acquisition standoff!','neutral');
      }
    }

    // NEGOTIATION TUG-OF-WAR
    if(u.state==='negotiating'&&u.negotiatingWith){
      const other=u.negotiatingWith;
      // Only one side drives the tick ‚Äî the one with lower index (or player side)
      if(u.owner===player||(u.owner!==player&&other.owner!==player)){
        const push=(Math.random()*3)-1.2; // slight attacker bias (attacker = whoever initiated)
        u.negotiationProgress=Math.max(0,Math.min(100,u.negotiationProgress+push));
        other.negotiationProgress=100-u.negotiationProgress;
      }
      // Check win conditions
      if(u.negotiationProgress>=100){
        // u wins ‚Äî captures other TA
        other.owner=u.owner;other.state='idle';other.negotiatingWith=null;other.negotiationProgress=50;
        other.nickname=other.nickname+' (Poached)';
        u.state='idle';u.negotiatingWith=null;u.negotiationProgress=50;
        const otherOwner=other.owner;
        u.owner.units.push(other);const oi=otherOwner.units.indexOf(other);if(oi>=0)otherOwner.units.splice(oi,1);
        other.owner=u.owner;
        addLog((u.owner===player?'You':u.owner.name)+' won the talent war! Captured enemy TA!',myTAColor);
        if(u.owner===player)voiceSystem('negotiationWon');else if(otherOwner===player)voiceSystem('negotiationLost');
      } else if(u.negotiationProgress<=0){
        // other wins ‚Äî captures u
        const prevOwner=u.owner;
        const ui2=prevOwner.units.indexOf(u);if(ui2>=0)prevOwner.units.splice(ui2,1);
        const otherOwner2=other.owner;
        u.owner=otherOwner2;u.state='idle';u.negotiatingWith=null;u.negotiationProgress=50;
        u.nickname=u.nickname+' (Poached)';
        other.state='idle';other.negotiatingWith=null;other.negotiationProgress=50;
        otherOwner2.units.push(u);
        addLog((otherOwner2===player?'You':otherOwner2.name)+' won the talent war! Captured enemy TA!',otherOwner2===player?'positive':'negative');
        if(otherOwner2===player)voiceSystem('negotiationWon');else if(prevOwner===player)voiceSystem('negotiationLost');
      }
      return; // Don't do anything else while negotiating
    }

    // RECRUITING (POACHING) in progress
    if(u.state==='recruiting'&&u.recruitTarget){
      const rt=u.recruitTarget;
      // Check target still valid
      if(!rt.owner||rt.owner===u.owner||!rt.owner.units.includes(rt)){u.recruitTarget=null;u.recruitProgress=0;u.state='idle';return}
      // Must stay close to recruit
      const dx=rt.x-u.x,dy=rt.y-u.y,dist=Math.sqrt(dx*dx+dy*dy);
      if(dist>4){u.tx=rt.x;u.ty=rt.y;u.state='moving';return}
      u.recruitProgress+=1.5; // ~67 ticks to complete
      if(u.recruitProgress>=100){
        // Poach complete ‚Äî switch the unit to our team
        const rIdx=rt.owner.units.indexOf(rt);if(rIdx>=0)rt.owner.units.splice(rIdx,1);
        rt.owner=u.owner;rt.nickname=rt.nickname+' (Poached)';rt.state='idle';rt.target=null;
        u.owner.units.push(rt);
        u.recruitTarget=null;u.recruitProgress=0;u.state='idle';
        addLog((u.owner===player?'You':u.owner.name)+' poached '+(rt.nickname||UNITS_DEF[rt.type].name)+'!',myTAColor);
        if(u.owner===player)voiceSystem('poachSuccess');else voiceSystem('poachFail');
        dealFX(u,u.owner);
      }
      return;
    }

    // MOVEMENT toward recruit target
    if(u.state==='moving'){
      const dx=u.tx-u.x,dy=u.ty-u.y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<0.5){
        if(u.recruitTarget){u.state='recruiting';u.recruitProgress=0}
        else{u.state='idle'}
      } else {const s=u.speed*0.25;u.x+=dx/d*s;u.y+=dy/d*s}
      return;
    }

    // AUTO-TARGETING when idle ‚Äî find enemy's highest-value sales unit
    if(u.state==='idle'){
      const targets=getAllEnemyUnits(u.owner).filter(e=>['sales_rep','sr_sales_rep','ai_agent'].includes(e.type)&&e.state!=='building');
      if(targets.length>0){
        // Score by revGen + dealsWon*10 + type bonus
        const scored=targets.map(t=>{
          let score=t.revGen+t.dealsWon*10;
          if(t.type==='ai_agent')score+=50;else if(t.type==='sr_sales_rep')score+=25;
          return{unit:t,score};
        }).sort((a,b)=>b.score-a.score);
        const best=scored[0].unit;
        u.recruitTarget=best;u.tx=best.x;u.ty=best.y;u.state='moving';
      }
    }
    return; // TA doesn't do normal unit actions
  }

  if(u.type==='marketer'){
    const mktRange=u.owner.tech.marketing_automation?10:5;
    // Magnetic pull ‚Äî attract free prospects toward marketer
    freeCust.forEach(c=>{const dx=u.x-c.x,dy=u.y-c.y,d=Math.sqrt(dx*dx+dy*dy);if(d<mktRange&&d>0.5){c.x+=dx/d*0.03;c.y+=dy/d*0.03}});
    // Loyalty sabotage ‚Äî drain loyalty from nearby enemy customers
    const opp=players.find(p=>p!==u.owner)||enemy;
    if(u.state==='sabotaging'&&u.target){
      const c=u.target;
      if(!c.owner||c.owner===u.owner){u.target=null;u.state='idle'}
      else{
        const d=Math.sqrt((u.x-c.x)**2+(u.y-c.y)**2);
        if(d<2){
          const drainRate=u.owner.tech.marketing_automation?0.4:0.2;
          c.loyalty-=drainRate;
          u.progress=Math.max(0,100-c.loyalty);
          if(c.loyalty<=0){addLog((u.owner===player?'Marketing':'Enemy marketing')+' softened #'+c.id+'!',u.owner===player?'positive':'negative');if(u.owner===player)voiceSystem('sabotageSuccess');u.target=null;u.state='idle';u.progress=0}
        }
      }
    }
    // Auto-target enemy customers when idle
    if(u.state==='idle'){
      const enemyCusts=getAllEnemyCustomers(u.owner).filter(c=>c.loyalty>0);
      if(enemyCusts.length>0){
        let near=null,nd=Infinity;
        enemyCusts.forEach(c=>{const d=(u.x-c.x)**2+(u.y-c.y)**2;if(d<nd){nd=d;near=c}});
        if(near){u.target=near;u.tx=near.x;u.ty=near.y;u.state='moving'}
      } else {
        // No enemy customers ‚Äî roam near base
        const b=u.owner.buildings[0];if(b){u.tx=b.x+(Math.random()-0.5)*12;u.ty=b.y+(Math.random()-0.5)*12;u.state='moving'}
      }
    }
  }
  if(u.type==='service_rep'){
    // CS Rep: passively defends nearby owned customers ‚Äî defense logic is in the converting section
    // Slow loyalty boost for customers in range (minor passive benefit)
    const defRange=u.owner.tech.customer_success?8:4;
    u.owner.customers.forEach(c=>{if(Math.sqrt((u.x-c.x)**2+(u.y-c.y)**2)<defRange)c.loyalty=Math.min(100,c.loyalty+0.15)});
    // CS Reps do NOT auto-roam ‚Äî user must send them where they're needed
    // They stay put when idle (guarding position)
  }
  // MOVEMENT ‚Äî faster base speed (0.25 per tick, was 0.15)
  if(u.state==='moving'){const dx=u.tx-u.x,dy=u.ty-u.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d<0.3){u.state=u.target?(u.type==='marketer'?'sabotaging':'converting'):'idle';u.progress=0}
    else{const s=u.speed*0.25;u.x+=dx/d*s;u.y+=dy/d*s}}
  if((u.state==='converting'||u.state==='blocked')&&u.target){const c=u.target,tb=u.owner.tech.basic_crm===true?1.2:1,pw=u.power*tb;
    // Value-based close speed: small deals close fast, large deals are a grind
    const vf=c.value<=3?1.67:c.value<=7?1:0.67;
    if(c.owner===null){u.state='converting';u.progress+=pw*1.0*vf;if(u.progress>=100){c.owner=u.owner;c.loyalty=100;u.owner.customers.push(c);const i=freeCust.indexOf(c);if(i>=0)freeCust.splice(i,1);u.dealsWon++;u.revGen+=c.value;addLog((u.owner===player?'You':u.owner.name)+' won '+c.city+' #'+c.id+' ($'+c.value+'K)',u.owner===player?'positive':'negative');if(u.owner===player)voiceSystem('dealWon');dealFX(c,u.owner);u.target=null;u.state='idle';u.progress=0}}
    else if(c.owner!==u.owner){
      // Count CS reps defending this customer (from the customer's owner)
      const defRange=c.owner.tech.customer_success?8:4;
      const defenders=c.owner.units.filter(d=>d.type==='service_rep'&&d.state!=='building'&&Math.sqrt((d.x-c.x)**2+(d.y-c.y)**2)<defRange).length;
      // Count attackers working on this same customer
      const attackers=players.flatMap(p=>p.units).filter(a=>a.target===c&&(a.state==='converting'||a.state==='blocked')&&a.owner!==c.owner).length;
      if(defenders>0&&defenders>=attackers){
        // CS reps outnumber or match attackers ‚Äî customer not interested, block progress
        u.state='blocked';u.progress=Math.max(0,u.progress-0.3); // slowly decay progress
      } else {
        // Sales can proceed, but defenders slow it down
        u.state='converting';
        const stealRate=u.type==='sales_rep'?0.15:0.5;
        const slowFactor=defenders>0?0.3:1; // 70% slower if any CS rep nearby
        c.loyalty-=pw*stealRate*slowFactor*vf;
        u.progress=Math.max(0,100-c.loyalty);
        if(c.loyalty<=0){const prev=c.owner;const i=prev.customers.indexOf(c);if(i>=0)prev.customers.splice(i,1);c.owner=u.owner;c.loyalty=60;u.owner.customers.push(c);u.dealsWon++;u.dealsStolen++;u.revGen+=c.value;addLog((u.owner===player?'You':u.owner.name)+' stole #'+c.id+' in '+c.city+'!',u.owner===player?'positive':'negative');if(u.owner===player)voiceSystem('dealStolen');else voiceSystem('enemyStole');dealFX(c,u.owner);u.target=null;u.state='idle';u.progress=0}
      }
    }
    else{u.target=null;u.state='idle'}}
  if(u.state==='idle'&&['sales_rep','sr_sales_rep','ai_agent'].includes(u.type)){
    // All sales types can target enemy accounts ‚Äî sales_rep prefers free prospects but will go for enemy if none available
    let near=null,nd=Infinity;
    let targets;
    if(u.type==='sales_rep'){
      targets=freeCust.length>0?freeCust:[...allCust.filter(c=>c.owner&&c.owner!==u.owner)];
    } else {
      targets=[...freeCust,...allCust.filter(c=>c.owner&&c.owner!==u.owner)];
    }
    targets.forEach(c=>{const d=(u.x-c.x)**2+(u.y-c.y)**2;if(d<nd){nd=d;near=c}});
    if(near){u.target=near;u.tx=near.x;u.ty=near.y;u.state='moving'}}
}
function aiTick(aiP){
  // AI difficulty scales: 1=Passive, 2=Easy, 3=Medium, 4=Hard, 5=Ruthless
  const d=aiDifficulty;
  const hireChance=[0.05,0.15,0.35,0.55,0.75][d-1];
  const buildChance=[0.02,0.05,0.10,0.18,0.30][d-1];
  const techChance=[0.01,0.04,0.08,0.15,0.25][d-1];
  const cashThreshold=[600,400,200,100,50][d-1];

  const cap=aiP.buildings.filter(b=>b.type==='office'&&b.bp===undefined).length*5+aiP.buildings.filter(b=>b.type==='hq_upgrade'&&b.bp===undefined).length*10;
  const b=aiP.buildings[0];if(!b)return;

  // HIRE
  if(aiP.units.length<cap&&aiP.cash>cashThreshold&&Math.random()<hireChance){
    let t='sales_rep';
    if(d>=4){
      const hasService=aiP.units.some(u=>u.type==='service_rep');
      const hasMarketer=aiP.units.some(u=>u.type==='marketer');
      if(aiP.tech.ai_first===true&&Math.random()<0.4)t='ai_agent';
      else if(aiP.tech.advanced_sales===true&&Math.random()<0.35)t='sr_sales_rep';
      else if(!hasService&&aiP.buildings.some(x=>x.type==='support_center'&&x.bp===undefined)&&Math.random()<0.3)t='service_rep';
      else if(!hasMarketer&&aiP.buildings.some(x=>x.type==='marketing_dept'&&x.bp===undefined)&&Math.random()<0.25)t='marketer';
    } else {
      if(aiP.tech.ai_first===true&&Math.random()<0.2)t='ai_agent';
      else if(aiP.tech.advanced_sales===true&&Math.random()<0.2)t='sr_sales_rep';
      else if(Math.random()<0.15&&aiP.buildings.some(x=>x.type==='support_center'&&x.bp===undefined))t='service_rep';
      else if(Math.random()<0.1&&aiP.buildings.some(x=>x.type==='marketing_dept'&&x.bp===undefined))t='marketer';
    }
    if(aiP.cash>=UNITS_DEF[t].cost){aiP.cash-=UNITS_DEF[t].cost;
      const u=createUnit(t,aiP,b.x+(Math.random()-0.5)*3,b.y+(Math.random()-0.5)*3);
      u.bp=0;u.bt=UNITS_DEF[t].buildTime;u.state='building';aiP.units.push(u)}
  }

  // BUILD
  if(aiP.cash>cashThreshold&&Math.random()<buildChance){
    const has=type=>aiP.buildings.some(x=>x.type===type);
    let toBuild=null;
    if(d>=4){
      if(!has('research_lab'))toBuild='research_lab';
      else if(!has('marketing_dept'))toBuild='marketing_dept';
      else if(!has('support_center'))toBuild='support_center';
      else if(!has('ai_datacenter')&&aiP.tech.advanced_sales===true)toBuild='ai_datacenter';
      else if(!has('hq_upgrade')&&has('research_lab'))toBuild='hq_upgrade';
    } else {
      if(!has('research_lab')&&Math.random()<0.5)toBuild='research_lab';
      else if(!has('support_center')&&Math.random()<0.4)toBuild='support_center';
      else if(!has('marketing_dept')&&Math.random()<0.3)toBuild='marketing_dept';
      else if(!has('ai_datacenter')&&aiP.tech.advanced_sales===true&&Math.random()<0.2)toBuild='ai_datacenter';
    }
    if(toBuild&&aiP.cash>=BLDGS[toBuild].cost){aiP.cash-=BLDGS[toBuild].cost;
      aiP.buildings.push({type:toBuild,x:b.x+(Math.random()-0.5)*2,y:b.y+(Math.random()-0.5)*2,bp:0,bt:BLDGS[toBuild].buildTime})}
  }

  // RESEARCH
  if(aiP.cash>cashThreshold&&Math.random()<techChance){
    const hasLab=aiP.buildings.some(x=>x.type==='research_lab'&&x.bp===undefined);
    if(hasLab){
      if(aiP.tech.basic_crm!==true){aiP.tech.basic_crm='building';aiP.techBuild=aiP.techBuild||{};aiP.techBuild.basic_crm={bp:0,bt:TECHS.basic_crm.buildTime}}
      else if(aiP.tech.advanced_sales!==true&&d>=3){aiP.tech.advanced_sales='building';aiP.techBuild=aiP.techBuild||{};aiP.techBuild.advanced_sales={bp:0,bt:TECHS.advanced_sales.buildTime}}
      else if(aiP.tech.customer_success!==true&&d>=3&&aiP.buildings.some(x=>x.type==='support_center'&&x.bp===undefined)){aiP.tech.customer_success='building';aiP.techBuild=aiP.techBuild||{};aiP.techBuild.customer_success={bp:0,bt:TECHS.customer_success.buildTime}}
      else if(aiP.tech.ai_first!==true&&aiP.tech.advanced_sales===true&&d>=4&&aiP.buildings.some(x=>x.type==='ai_datacenter'&&x.bp===undefined)){aiP.tech.ai_first='building';aiP.techBuild=aiP.techBuild||{};aiP.techBuild.ai_first={bp:0,bt:TECHS.ai_first.buildTime}}
      else if(aiP.tech.enterprise!==true&&aiP.tech.advanced_sales===true&&d>=3){aiP.tech.enterprise='building';aiP.techBuild=aiP.techBuild||{};aiP.techBuild.enterprise={bp:0,bt:TECHS.enterprise.buildTime}}
      else if(aiP.tech.marketing_automation!==true&&aiP.tech.basic_crm===true&&d>=4){aiP.tech.marketing_automation='building';aiP.techBuild=aiP.techBuild||{};aiP.techBuild.marketing_automation={bp:0,bt:TECHS.marketing_automation.buildTime}}
    }
  }

  // AGGRESSIVE TARGETING ‚Äî target nearest opponent's highest-value customers
  if(d>=4&&Math.random()<(d===5?0.4:0.2)){
    const oppCusts=getAllEnemyCustomers(aiP);
    if(oppCusts.length>0){
      const idle=aiP.units.filter(u=>u.state==='idle'&&['sales_rep','sr_sales_rep','ai_agent'].includes(u.type));
      if(idle.length){
        const u=idle[Math.floor(Math.random()*idle.length)];
        // Target nearest opponent's highest value customer
        const sorted=[...oppCusts].sort((a,b)=>b.value-a.value);
        const target=sorted[Math.floor(Math.random()*Math.min(3,sorted.length))];
        if(target){u.target=target;u.tx=target.x;u.ty=target.y;u.state='moving'}
      }
    }
  }

  // ---- AI TALENT ACQUISITION ----
  const hasHR=aiP.buildings.some(x=>x.type==='hr_dept'&&x.bp===undefined);
  const hasHRBuilding=aiP.buildings.some(x=>x.type==='hr_dept');

  if(d>=3&&!hasHRBuilding&&aiP.cash>cashThreshold&&Math.random()<buildChance*1.5){
    if(aiP.buildings.some(x=>x.type==='office'&&x.bp===undefined)&&aiP.cash>=BLDGS.hr_dept.cost){
      aiP.cash-=BLDGS.hr_dept.cost;
      aiP.buildings.push({type:'hr_dept',x:b.x+(Math.random()-0.5)*2,y:b.y+(Math.random()-0.5)*2,bp:0,bt:BLDGS.hr_dept.buildTime});
    }
  }

  if(d>=3&&hasHR&&!aiP.taBuilt&&aiP.cash>=UNITS_DEF.talent_acq.cost){
    const taChance=d>=4?0.3:0.15;
    if(Math.random()<taChance){
      aiP.cash-=UNITS_DEF.talent_acq.cost;
      const ta=createUnit('talent_acq',aiP,b.x+(Math.random()-0.5)*3,b.y+(Math.random()-0.5)*3);
      ta.bp=0;ta.bt=UNITS_DEF.talent_acq.buildTime;ta.state='building';aiP.units.push(ta);
      aiP.taBuilt=true;
    }
  }

  // AI intercepts opponent TA
  if(d>=3){
    const aiTA=aiP.units.find(u=>u.type==='talent_acq'&&u.state==='idle');
    const threatTA=players.filter(p=>p!==aiP).flatMap(p=>p.units).find(u=>u.type==='talent_acq'&&(u.state==='recruiting'||u.state==='moving')&&u.recruitTarget&&u.recruitTarget.owner===aiP);
    if(aiTA&&threatTA){
      aiTA.tx=threatTA.x;aiTA.ty=threatTA.y;aiTA.state='moving';
    }
  }

  // ---- AI M&A BEHAVIOR ----
  if(d>=4&&!aiP.buildings.some(x=>x.type==='m_and_a_dept')&&aiP.buildings.some(x=>x.type==='research_lab'&&x.bp===undefined)&&aiP.cash>=BLDGS.m_and_a_dept.cost&&Math.random()<buildChance){
    aiP.cash-=BLDGS.m_and_a_dept.cost;
    aiP.buildings.push({type:'m_and_a_dept',x:b.x+(Math.random()-0.5)*2,y:b.y+(Math.random()-0.5)*2,bp:0,bt:BLDGS.m_and_a_dept.buildTime});
  }
  const aiHasMA=aiP.buildings.some(x=>x.type==='m_and_a_dept'&&x.bp===undefined);
  if(aiHasMA&&isDistressed(player)&&aiAcqCountdown===0){
    aiAcqCountdown=AI_ACQ_DURATION;aiAcquirer=aiP;
    addLog('‚ö† HOSTILE TAKEOVER INCOMING from '+aiP.name+'! Get cash above $50K!','negative');
    voiceSystem('acquisitionThreat');
  }
}
function dealFX(c,owner){
  for(let i=0;i<8;i++){const a=i/8*Math.PI*2;particles.push({x:c.x,y:c.y,vx:Math.cos(a)*0.08,vy:Math.sin(a)*0.04-0.04,life:50,mx:50,col:owner.color,ch:'‚ú¶',sz:14})}
  particles.push({x:c.x,y:c.y-0.3,vx:0,vy:-0.05,life:70,mx:70,col:owner===player?'#ffd700':'#ff6666',ch:'+$'+c.value+'K',sz:13});
  if(owner===player){const iso=toIso(c.x,c.y),sx=(iso.x-camX)*zoom,sy=(iso.y-camY+48/zoom)*zoom;const f=document.createElement('div');f.className='income-float';f.style.cssText='left:'+sx+'px;top:'+sy+'px;color:#ffd700';f.textContent='üéâ +$'+c.value+'K MRR';document.getElementById('gameContainer').appendChild(f);setTimeout(()=>f.remove(),2000)}
}

// =============================================
//  RENDERING
// =============================================
function drawUnitDestination(u,unitIso,lerp){
  if(u.state==='idle'||u.state==='blocked'||u.state==='recruiting'||u.state==='negotiating'||u.state==='sabotaging')return;
  // Destination point
  let dx,dy,label='',isCustomer=false;
  if(u.target){
    dx=u.target.x;dy=u.target.y;
    label=u.target.city?'#'+u.target.id+' '+u.target.city:'Target';
    isCustomer=true;
  } else if(u.state==='moving'){
    dx=u.tx;dy=u.ty;label='Move';
  } else return;
  
  const dest=toIso(dx,dy);
  const col=isCustomer?'#ffdd44':'#00ff41';
  
  // Dashed path line
  ctx.strokeStyle=col;ctx.globalAlpha=0.35;ctx.lineWidth=1.5;
  ctx.setLineDash([6,4]);ctx.lineDashOffset=-performance.now()*0.02;
  ctx.beginPath();ctx.moveTo(unitIso.x,unitIso.y);ctx.lineTo(dest.x,dest.y);ctx.stroke();
  ctx.setLineDash([]);ctx.globalAlpha=1;
  
  // Animated dots along path
  const pdist=Math.sqrt((dest.x-unitIso.x)**2+(dest.y-unitIso.y)**2);
  if(pdist>20){
    const numDots=Math.min(5,Math.floor(pdist/30));
    for(let i=0;i<numDots;i++){
      const t=((performance.now()*0.001+i*0.25)%1);
      const mx=unitIso.x+(dest.x-unitIso.x)*t;
      const my=unitIso.y+(dest.y-unitIso.y)*t;
      ctx.globalAlpha=0.2+0.4*(1-Math.abs(t-0.5)*2);
      ctx.fillStyle=col;ctx.beginPath();ctx.arc(mx,my,2,0,Math.PI*2);ctx.fill();
    }
    ctx.globalAlpha=1;
  }
  
  // Destination marker ‚Äî pulsing diamond
  const pulse=Math.sin(performance.now()*0.005)*0.2+0.8;
  const sz=isCustomer?8:6;
  ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.globalAlpha=0.6*pulse;
  ctx.beginPath();ctx.moveTo(dest.x,dest.y-sz);ctx.lineTo(dest.x+sz,dest.y);ctx.lineTo(dest.x,dest.y+sz);ctx.lineTo(dest.x-sz,dest.y);ctx.closePath();ctx.stroke();
  ctx.fillStyle=col;ctx.globalAlpha=0.12*pulse;ctx.fill();
  ctx.globalAlpha=1;
  
  // Label at destination
  if(isCustomer){
    ctx.fillStyle='rgba(8,8,16,0.8)';
    const tw=ctx.measureText?40:40;
    ctx.fillRect(dest.x-tw/2,dest.y-sz-14,tw,11);
    ctx.fillStyle=col;ctx.font='bold 6px Orbitron';ctx.textAlign='center';
    ctx.fillText('$'+u.target.value+'K',dest.x,dest.y-sz-5);
  }
}
function render(dt,lerp){
  if(lerp===undefined)lerp=0;
  ctx.fillStyle='#080810';ctx.fillRect(0,0,canvas.width,canvas.height);
  updateCam();ctx.save();ctx.scale(zoom,zoom);ctx.translate(-camX,-camY+48/zoom);
  if(offMap)ctx.drawImage(offMap,offMap._ox,offMap._oy);

  // Interpolated positions for smooth rendering
  function lerpPos(obj){
    const lx=obj.px!==undefined?obj.px+(obj.x-obj.px)*lerp:obj.x;
    const ly=obj.py!==undefined?obj.py+(obj.y-obj.py)*lerp:obj.y;
    return toIso(lx,ly);
  }

  const rr=[];
  allCust.forEach(c=>{const i=lerpPos(c);rr.push({t:'c',d:c,y:(c.px||c.x)+(c.py||c.y)+lerp*2,i})});
  players.forEach(p=>{p.buildings.forEach(b=>{const i=toIso(b.x,b.y);rr.push({t:'b',d:b,o:p,y:b.x+b.y,i})})});
  players.flatMap(p=>p.units).forEach(u=>{const i=lerpPos(u);const la=u.pAnim!==undefined?u.pAnim+(u.anim-u.pAnim)*lerp:u.anim;const lp=u.pProgress!==undefined?u.pProgress+(u.progress-u.pProgress)*lerp:u.progress;rr.push({t:'u',d:u,y:(u.px||u.x)+(u.py||u.y)+lerp*2,i,la,lp})});
  rr.sort((a,b)=>a.y-b.y);
  rr.forEach(r=>{if(r.t==='c')drawCust(r.d,r.i);else if(r.t==='b')drawBase(r.d,r.o,r.i);else drawUnit(r.d,r.i,r.la,r.lp,lerpPos)});

  particles.forEach(p=>{const i=toIso(p.x,p.y);const a=p.life/p.mx;ctx.globalAlpha=a;ctx.fillStyle=p.col;ctx.font='bold '+(p.sz||12)+'px Orbitron,sans-serif';ctx.textAlign='center';ctx.fillText(p.ch,i.x,i.y-(1-a)*30);p.x+=p.vx;p.y+=p.vy;p.life--});
  ctx.globalAlpha=1;particles=particles.filter(p=>p.life>0);

  // Waypoint markers ‚Äî pulsing target indicators
  const now=performance.now();
  waypoints.forEach(wp=>{
    const age=(now-wp.time)/1000;
    wp.alpha=Math.max(0,1-age/3); // fade over 3 seconds
    if(wp.alpha<=0)return;
    const i=toIso(wp.x,wp.y);
    const pulse=Math.sin(age*5)*0.3+0.7;
    const sz=wp.customer?18:14;
    // Outer ring
    ctx.globalAlpha=wp.alpha*0.5*pulse;
    ctx.strokeStyle='#00ff41';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.ellipse(i.x,i.y,sz+age*8,sz*0.5+age*4,0,0,Math.PI*2);ctx.stroke();
    // Inner ring
    ctx.globalAlpha=wp.alpha*0.8;
    ctx.strokeStyle=wp.customer?'#ffdd44':'#00ff41';ctx.lineWidth=2;
    ctx.beginPath();ctx.ellipse(i.x,i.y,sz*pulse,sz*0.5*pulse,0,0,Math.PI*2);ctx.stroke();
    // Center marker
    ctx.fillStyle=wp.customer?'rgba(255,220,68,0.3)':'rgba(0,255,65,0.2)';
    ctx.beginPath();ctx.ellipse(i.x,i.y,6,3,0,0,Math.PI*2);ctx.fill();
    // Crosshair lines
    ctx.globalAlpha=wp.alpha*0.4;ctx.strokeStyle=wp.customer?'#ffdd44':'#00ff41';ctx.lineWidth=0.8;
    ctx.beginPath();ctx.moveTo(i.x-sz,i.y);ctx.lineTo(i.x-6,i.y);ctx.stroke();
    ctx.beginPath();ctx.moveTo(i.x+6,i.y);ctx.lineTo(i.x+sz,i.y);ctx.stroke();
    ctx.beginPath();ctx.moveTo(i.x,i.y-sz*0.5);ctx.lineTo(i.x,i.y-3);ctx.stroke();
    ctx.beginPath();ctx.moveTo(i.x,i.y+3);ctx.lineTo(i.x,i.y+sz*0.5);ctx.stroke();
    // Count badge
    if(wp.count>1){
      ctx.globalAlpha=wp.alpha;ctx.fillStyle='rgba(8,8,16,0.85)';
      ctx.beginPath();ctx.arc(i.x+sz*0.7,i.y-sz*0.4,7,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#00ff41';ctx.lineWidth=1;ctx.beginPath();ctx.arc(i.x+sz*0.7,i.y-sz*0.4,7,0,Math.PI*2);ctx.stroke();
      ctx.fillStyle='#00ff41';ctx.font='bold 7px Orbitron';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(wp.count,i.x+sz*0.7,i.y-sz*0.4);ctx.textBaseline='alphabetic';
    }
    ctx.globalAlpha=1;
  });
  waypoints=waypoints.filter(wp=>wp.alpha>0);

  if(selectedUnit){const sx=selectedUnit.px+(selectedUnit.x-selectedUnit.px)*lerp,sy=selectedUnit.py+(selectedUnit.y-selectedUnit.py)*lerp;const i=toIso(sx,sy);ctx.strokeStyle='#00ff41';ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(i.x,i.y+4,16,8,0,0,Math.PI*2);ctx.stroke();const g=ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,24);g.addColorStop(0,'rgba(0,255,65,0.2)');g.addColorStop(1,'rgba(0,255,65,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(i.x,i.y,24,0,Math.PI*2);ctx.fill();
    drawUnitDestination(selectedUnit,i,lerp)}
  // Inspected unit (enemy or own) ‚Äî red/green pulsing ring
  if(inspectedUnit){const sx=inspectedUnit.px+(inspectedUnit.x-inspectedUnit.px)*lerp,sy=inspectedUnit.py+(inspectedUnit.y-inspectedUnit.py)*lerp;const i=toIso(sx,sy);
    const isP=inspectedUnit.owner===player;const col=isP?'#00ff41':'#ff3333';const rgb=isP?'0,255,65':'255,51,51';
    const pulse=Math.sin(performance.now()*0.004)*0.3+0.7;
    ctx.strokeStyle=col;ctx.lineWidth=2.5;ctx.globalAlpha=pulse;ctx.beginPath();ctx.ellipse(i.x,i.y+4,18,9,0,0,Math.PI*2);ctx.stroke();
    ctx.globalAlpha=1;const g=ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,28);g.addColorStop(0,`rgba(${rgb},0.15)`);g.addColorStop(1,`rgba(${rgb},0)`);ctx.fillStyle=g;ctx.beginPath();ctx.arc(i.x,i.y,28,0,Math.PI*2);ctx.fill();
  }
  // Multi-select highlights + destinations
  selectedUnits.forEach(u=>{const sx=u.px+(u.x-u.px)*lerp,sy=u.py+(u.y-u.py)*lerp;const i=toIso(sx,sy);ctx.strokeStyle='#00ff41';ctx.lineWidth=1.5;ctx.beginPath();ctx.ellipse(i.x,i.y+4,14,7,0,0,Math.PI*2);ctx.stroke();
    drawUnitDestination(u,i,lerp)});
  ctx.restore();
  // Box-select rectangle (screen space)
  if(boxSelecting){
    const bx=Math.min(boxSX,boxEX),by=Math.min(boxSY,boxEY),bw=Math.abs(boxEX-boxSX),bh=Math.abs(boxEY-boxSY);
    ctx.strokeStyle='rgba(0,255,65,0.6)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.strokeRect(bx,by,bw,bh);ctx.setLineDash([]);
    ctx.fillStyle='rgba(0,255,65,0.06)';ctx.fillRect(bx,by,bw,bh);
  }
  // Multi-select count badge
  if(selectedUnits.length>1){ctx.fillStyle='rgba(10,10,18,0.85)';ctx.fillRect(8,canvas.height-86,120,22);ctx.strokeStyle='#00ff41';ctx.lineWidth=1;ctx.strokeRect(8,canvas.height-86,120,22);ctx.fillStyle='#00ff41';ctx.font='bold 11px Orbitron';ctx.textAlign='left';ctx.fillText('‚ú¶ '+selectedUnits.length+' SELECTED',14,canvas.height-70)}
  // Pan mode indicator
  if(keysDown.has(' ')){
    ctx.fillStyle='rgba(10,10,18,0.8)';ctx.fillRect(8,canvas.height-56,105,20);
    ctx.strokeStyle='#6688aa';ctx.lineWidth=1;ctx.strokeRect(8,canvas.height-56,105,20);
    ctx.fillStyle='#6688aa';ctx.font='bold 9px Orbitron';ctx.textAlign='left';ctx.fillText('‚ú• PAN MODE',14,canvas.height-42);
  }

  // ---- UNIT INFO PANEL (bottom-center) ----
  const showUnit=inspectedUnit||selectedUnit;
  if(showUnit&&!boxSelecting&&selectedUnits.length<=1){
    const u=showUnit,def=UNITS_DEF[u.type],isP=u.owner===player;
    const col=isP?'#00ff41':'#ff3333';const dimCol=isP?'rgba(0,255,65,0.6)':'rgba(255,51,51,0.6)';
    const panW=340,panH=90,panX=Math.floor(canvas.width/2-panW/2),panY=canvas.height-panH-32;
    // Background
    ctx.fillStyle='rgba(10,10,20,0.92)';ctx.beginPath();
    ctx.roundRect(panX,panY,panW,panH,6);ctx.fill();
    ctx.strokeStyle=col;ctx.lineWidth=1;ctx.beginPath();ctx.roundRect(panX,panY,panW,panH,6);ctx.stroke();
    // Owner bar
    ctx.fillStyle=col;ctx.globalAlpha=0.15;ctx.fillRect(panX+1,panY+1,panW-2,18);ctx.globalAlpha=1;
    // Name + type
    ctx.fillStyle=col;ctx.font='bold 10px Orbitron';ctx.textAlign='left';
    ctx.fillText((u.nickname||def.name)+' ‚Äî '+(isP?player.name:u.owner.name),panX+10,panY+13);
    ctx.fillStyle='#888';ctx.font='9px Share Tech Mono';ctx.textAlign='right';
    ctx.fillText(isP?'YOUR TEAM':'ENEMY',panX+panW-10,panY+13);
    // Type + rank
    const age=gameTime-u.bornAt;
    const rank=u.dealsWon>=10?'‚òÖ‚òÖ‚òÖ VETERAN':u.dealsWon>=5?'‚òÖ‚òÖ EXPERIENCED':u.dealsWon>=1?'‚òÖ ACTIVE':'ROOKIE';
    const rankCol=u.dealsWon>=10?'#ffd700':u.dealsWon>=5?'#ddaa33':u.dealsWon>=1?'#88aacc':'#555';
    ctx.textAlign='left';ctx.fillStyle='#aaa';ctx.font='bold 9px Orbitron';
    ctx.fillText(def.icon+' '+def.name.toUpperCase(),panX+10,panY+32);
    ctx.fillStyle=rankCol;ctx.font='bold 8px Orbitron';ctx.fillText(rank,panX+10,panY+44);
    // Stats row
    const sy=panY+58;ctx.font='7px Share Tech Mono';
    const stats=[
      ['DEALS',u.dealsWon,'#fff'],['STOLEN',u.dealsStolen,'#ff6666'],
      ['REV','$'+u.revGen+'K','#ffd700'],['SPEED',def.speed+'x','#88ccff'],
      ['POWER',def.power,'#ff8844'],['AGE',age+'t','#888']
    ];
    stats.forEach((s,i)=>{
      const sx2=panX+10+i*55;
      ctx.fillStyle='#555';ctx.textAlign='left';ctx.fillText(s[0],sx2,sy);
      ctx.fillStyle=s[2];ctx.font='bold 9px Orbitron';ctx.fillText(''+s[1],sx2,sy+12);
      ctx.font='7px Share Tech Mono';
    });
    // Status
    const stateLabel=u.state==='building'?'TRAINING':u.state==='converting'?'CLOSING DEAL':u.state==='moving'?'EN ROUTE':u.state==='blocked'?'NOT INTERESTED':u.state==='recruiting'?'POACHING':u.state==='negotiating'?'NEGOTIATING':u.state==='sabotaging'?'SABOTAGING':u.state.toUpperCase();
    const stateCol=u.state==='converting'?'#ffd700':u.state==='moving'?'#88ccff':u.state==='building'?'#ff8844':u.state==='blocked'?'#ff6644':u.state==='recruiting'?'#bb44ff':u.state==='negotiating'?'#ff44bb':u.state==='sabotaging'?'#ff8800':'#555';
    ctx.fillStyle=stateCol;ctx.font='bold 8px Orbitron';ctx.textAlign='right';
    ctx.fillText(stateLabel,panX+panW-10,panY+32);
    if(u.target&&u.state==='converting'){
      ctx.fillStyle='#aaa';ctx.font='7px Share Tech Mono';
      ctx.fillText(u.target.city+' #'+u.target.id+' ($'+u.target.value+'K)',panX+panW-10,panY+44);
    }
    // Hint
    ctx.fillStyle='#444';ctx.font='7px Share Tech Mono';ctx.textAlign='center';
    ctx.fillText(isP?'Double-click for full details':'Double-click to inspect',panX+panW/2,panY+panH-4);
  }
  drawMinimap();
}

function drawCust(c,iso){
  const targeted=players.flatMap(p=>p.units).some(u=>u.target===c&&u.state==='converting');
  let col,glow;
  if(!c.owner){col=targeted?'rgba(255,220,100,0.7)':'rgba(100,110,130,0.6)';glow=targeted?'#ffdd66':'#666'}
  else{
    const oc=c.owner.color||'#888';
    // Parse hex to rgba
    const hr=parseInt(oc.slice(1,3),16),hg=parseInt(oc.slice(3,5),16),hb=parseInt(oc.slice(5,7),16);
    col=`rgba(${hr},${hg},${hb},0.6)`;glow=oc;
  }

  const pulse=Math.sin(gameTime*0.1+c.pp)*0.08+1;
  const sz=(2+c.value*0.4)*pulse;

  // Diamond
  ctx.fillStyle=col;ctx.strokeStyle=glow;ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(iso.x,iso.y-sz);ctx.lineTo(iso.x+sz,iso.y);ctx.lineTo(iso.x,iso.y+sz*0.6);ctx.lineTo(iso.x-sz,iso.y);ctx.closePath();ctx.fill();ctx.stroke();

  // Value
  ctx.font='bold 7px Orbitron';ctx.textAlign='center';
  ctx.fillStyle=c.owner?(c.owner===player?'rgba(0,255,65,0.8)':'rgba(255,150,150,0.7)'):'#555';
  ctx.fillText('$'+c.value+'K',iso.x,iso.y-sz-4);

  // Ownership glow
  if(c.owner){const oc=c.owner.color||'#888';const hr=parseInt(oc.slice(1,3),16),hg=parseInt(oc.slice(3,5),16),hb=parseInt(oc.slice(5,7),16);const p=Math.sin(gameTime*0.15+c.pp)*0.1+0.15;ctx.globalAlpha=p;const g=ctx.createRadialGradient(iso.x,iso.y,0,iso.x,iso.y,12);g.addColorStop(0,`rgba(${hr},${hg},${hb},0.3)`);g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(iso.x,iso.y,12,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}
  if(targeted){ctx.strokeStyle='rgba(255,220,100,0.5)';ctx.lineWidth=1;ctx.setLineDash([2,2]);ctx.beginPath();ctx.ellipse(iso.x,iso.y+2,8,4,0,0,Math.PI*2);ctx.stroke();ctx.setLineDash([])}
  // Loyalty bar for owned customers
  if(c.owner&&c.loyalty>0){
    const bw=12,bh=2,bx=iso.x-bw/2,by=iso.y+sz*0.6+3;
    const pct=Math.min(1,c.loyalty/100);
    // Background
    ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(bx,by,bw,bh);
    // Fill ‚Äî green>yellow>red gradient based on loyalty
    const lc=pct>0.6?'rgba(0,255,65,0.8)':pct>0.3?'rgba(255,200,0,0.8)':'rgba(255,50,50,0.8)';
    ctx.fillStyle=lc;ctx.fillRect(bx,by,bw*pct,bh);
    // Border
    ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.lineWidth=0.5;ctx.strokeRect(bx,by,bw,bh);
  }
}

function drawBase(b,owner,iso){
  const def=BLDGS[b.type],isP=owner===player,col=owner.color||'#888';
  // Different building sizes per type
  const sizes={office:[20,38],marketing_dept:[16,28],support_center:[16,30],research_lab:[18,34],hq_upgrade:[24,48],ai_datacenter:[22,44],hr_dept:[17,30],m_and_a_dept:[19,36]};
  const[w,h]=sizes[b.type]||[18,32];
  const wallL=isP?'#1a3a28':'#3a1a1a', wallR=isP?'#244a34':'#4a2424', roofCol=isP?'#2a5a3a':'#5a2a2a';
  const winCol=isP?'rgba(0,255,65,0.5)':'rgba(255,80,80,0.5)', winOff='rgba(40,50,60,0.4)';

  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.25)';ctx.beginPath();ctx.ellipse(iso.x,iso.y+4,w+4,w*0.35,0,0,Math.PI*2);ctx.fill();

  // Left wall
  ctx.fillStyle=wallL;ctx.beginPath();
  ctx.moveTo(iso.x-w,iso.y);ctx.lineTo(iso.x,iso.y+w*0.5);ctx.lineTo(iso.x,iso.y+w*0.5-h);ctx.lineTo(iso.x-w,iso.y-h);ctx.closePath();ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.3)';ctx.lineWidth=0.5;ctx.stroke();

  // Right wall
  ctx.fillStyle=wallR;ctx.beginPath();
  ctx.moveTo(iso.x,iso.y+w*0.5);ctx.lineTo(iso.x+w,iso.y);ctx.lineTo(iso.x+w,iso.y-h);ctx.lineTo(iso.x,iso.y+w*0.5-h);ctx.closePath();ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.2)';ctx.stroke();

  // Windows ‚Äî left face
  const floors=Math.max(2,Math.floor(h/10));const cols=Math.max(2,Math.floor(w/7));
  for(let f=0;f<floors;f++){for(let c=0;c<cols;c++){
    const fx=c/cols,fy=f/floors;
    const wx=iso.x-w+4+c*(w-6)/cols;
    const wy=iso.y-h+5+f*(h-8)/floors;
    const shift=fx*w*0.25;
    const lit=(f*7+c*13+b.x*3)%3!==0;
    ctx.fillStyle=lit?winCol:winOff;
    ctx.fillRect(wx,wy+shift,Math.max(3,(w-6)/cols-2),Math.min(4,(h-8)/floors-3));
  }}
  // Windows ‚Äî right face
  for(let f=0;f<floors;f++){for(let c=0;c<cols;c++){
    const fx=c/cols,fy=f/floors;
    const wx=iso.x+3+c*(w-6)/cols;
    const wy=iso.y-h+5+f*(h-8)/floors;
    const shift=-fx*w*0.25+w*0.25;
    const lit=(f*11+c*3+b.y*7)%4!==0;
    ctx.fillStyle=lit?winCol:winOff;
    ctx.fillRect(wx,wy+shift,Math.max(3,(w-6)/cols-2),Math.min(4,(h-8)/floors-3));
  }}

  // Roof
  ctx.fillStyle=roofCol;ctx.beginPath();
  ctx.moveTo(iso.x,iso.y+w*0.5-h);ctx.lineTo(iso.x+w,iso.y-h);ctx.lineTo(iso.x,iso.y-w*0.5-h);ctx.lineTo(iso.x-w,iso.y-h);ctx.closePath();ctx.fill();
  ctx.strokeStyle=col;ctx.lineWidth=0.8;ctx.stroke();

  // Rooftop details
  if(b.type==='hr_dept'){
    // HR badge on roof
    ctx.fillStyle='rgba(180,80,220,0.25)';ctx.beginPath();ctx.ellipse(iso.x,iso.y-h-w*0.25,6,3,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(180,80,220,0.5)';ctx.lineWidth=1;ctx.stroke();
    ctx.font='bold 5px Orbitron';ctx.textAlign='center';ctx.fillStyle='rgba(180,80,220,0.6)';ctx.fillText('HR',iso.x,iso.y-h-w*0.25+2);
  } else if(b.type==='ai_datacenter'||b.type==='research_lab'){
    // Antenna
    ctx.strokeStyle='#888';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(iso.x,iso.y-h-w*0.25);ctx.lineTo(iso.x,iso.y-h-w*0.25-12);ctx.stroke();
    ctx.fillStyle=gameTime%20<10?'#ff4444':'#ff8888';ctx.beginPath();ctx.arc(iso.x,iso.y-h-w*0.25-12,2,0,Math.PI*2);ctx.fill();
  } else if(b.type==='hq_upgrade'){
    // Helipad H
    ctx.fillStyle='rgba(255,255,255,0.15)';ctx.beginPath();ctx.ellipse(iso.x,iso.y-h-w*0.25,6,3,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1;ctx.stroke();
    ctx.font='bold 5px Orbitron';ctx.textAlign='center';ctx.fillStyle='rgba(255,255,255,0.4)';ctx.fillText('H',iso.x,iso.y-h-w*0.25+2);
  } else if(b.type==='m_and_a_dept'){
    // Gold M&A badge on roof
    ctx.fillStyle='rgba(255,215,0,0.25)';ctx.beginPath();ctx.ellipse(iso.x,iso.y-h-w*0.25,7,3.5,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(255,215,0,0.5)';ctx.lineWidth=1;ctx.stroke();
    ctx.font='bold 5px Orbitron';ctx.textAlign='center';ctx.fillStyle='rgba(255,215,0,0.6)';ctx.fillText('M&A',iso.x,iso.y-h-w*0.25+2);
  }

  // Door (ground floor)
  ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillRect(iso.x-2,iso.y+w*0.5-7,4,7);
  ctx.fillStyle=col;ctx.globalAlpha=0.3;ctx.fillRect(iso.x-2,iso.y+w*0.5-7,4,7);ctx.globalAlpha=1;

  // Edge highlights
  ctx.strokeStyle=col;ctx.lineWidth=1;ctx.globalAlpha=0.4;
  ctx.beginPath();ctx.moveTo(iso.x-w,iso.y);ctx.lineTo(iso.x-w,iso.y-h);ctx.stroke();
  ctx.beginPath();ctx.moveTo(iso.x+w,iso.y);ctx.lineTo(iso.x+w,iso.y-h);ctx.stroke();
  ctx.globalAlpha=1;

  // Icon + Label above
  ctx.font='16px serif';ctx.textAlign='center';ctx.fillText(def.icon,iso.x,iso.y-h-w*0.25-2);
  ctx.font='bold 7px Orbitron';ctx.fillStyle=col;ctx.fillText(def.name.toUpperCase(),iso.x,iso.y-h-w*0.25-14);

  // ---- CONSTRUCTION OVERLAY ----
  if(b.bp!==undefined){
    const prog=b.bp/b.bt; // 0‚Üí1
    const maskH=(1-prog)*h; // how much to cover from top
    const maskTop=iso.y+w*0.5-h;
    
    // Dark overlay mask ‚Äî covers the unrevealed portion
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(iso.x-w-2,maskTop-2);ctx.lineTo(iso.x+w+2,maskTop-2);
    ctx.lineTo(iso.x+w+2,maskTop+maskH);ctx.lineTo(iso.x-w-2,maskTop+maskH);ctx.closePath();
    ctx.clip();
    ctx.fillStyle='rgba(8,8,16,0.7)';ctx.fillRect(iso.x-w-2,maskTop-2,w*2+4,maskH+4);
    
    // Scaffolding lines
    ctx.strokeStyle='rgba(180,140,60,0.4)';ctx.lineWidth=1;
    const scaffRows=Math.max(2,Math.floor(maskH/8));
    for(let i=0;i<scaffRows;i++){
      const sy=maskTop+i*(maskH/scaffRows);
      ctx.beginPath();ctx.moveTo(iso.x-w,sy);ctx.lineTo(iso.x+w,sy);ctx.stroke();
    }
    // Vertical scaffold poles
    ctx.beginPath();ctx.moveTo(iso.x-w+3,maskTop);ctx.lineTo(iso.x-w+3,maskTop+maskH);ctx.stroke();
    ctx.beginPath();ctx.moveTo(iso.x+w-3,maskTop);ctx.lineTo(iso.x+w-3,maskTop+maskH);ctx.stroke();
    ctx.beginPath();ctx.moveTo(iso.x,maskTop);ctx.lineTo(iso.x,maskTop+maskH);ctx.stroke();
    ctx.restore();
    
    // Progress bar below building
    const barW=w*1.8,barH=4,barX=iso.x-barW/2,barY=iso.y+w*0.5+6;
    ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(barX,barY,barW,barH);
    ctx.fillStyle=col;ctx.fillRect(barX,barY,barW*prog,barH);
    ctx.strokeStyle=col;ctx.lineWidth=0.5;ctx.strokeRect(barX,barY,barW,barH);
    // "BUILDING..." label
    ctx.fillStyle=col;ctx.font='bold 6px Orbitron';ctx.textAlign='center';
    ctx.fillText('BUILDING '+Math.floor(prog*100)+'%',iso.x,barY+barH+8);
  }
}

function drawUnit(u,iso,la,lp,lerpPos){
  const def=UNITS_DEF[u.type],isP=u.owner===player,col=u.owner.color||'#888',rgb=PLAYER_RGBS[players.indexOf(u.owner)]||'128,128,128';
  if(la===undefined)la=u.anim;
  if(lp===undefined)lp=u.progress;
  const bob=Math.sin(la*2)*1.5;

  // Beam to target
  if((u.state==='converting'||u.state==='moving'||u.state==='blocked')&&u.target){
    const ti=lerpPos?lerpPos(u.target):toIso(u.target.x,u.target.y);
    if(u.state==='blocked'){
      // Blocked beam ‚Äî red dashed, static
      ctx.strokeStyle='rgba(255,100,68,0.3)';ctx.lineWidth=1;ctx.setLineDash([4,6]);
      ctx.beginPath();ctx.moveTo(iso.x,iso.y-8);ctx.lineTo(ti.x,ti.y);ctx.stroke();ctx.setLineDash([]);
      // Shield icon at target
      const pulse=Math.sin(la*4)*0.15+0.7;
      ctx.globalAlpha=pulse;ctx.fillStyle='#44aadd';ctx.font='12px serif';ctx.textAlign='center';ctx.fillText('üõ°',ti.x,ti.y-12);ctx.globalAlpha=1;
    } else if(u.state==='converting'){
      const prog=lp/100;
      ctx.strokeStyle=`rgba(${rgb},${0.15+prog*0.4})`;ctx.lineWidth=1+prog*2;
      ctx.setLineDash([3+prog*5,6-prog*4]);ctx.lineDashOffset=-la*10;
      ctx.beginPath();ctx.moveTo(iso.x,iso.y-8);ctx.lineTo(ti.x,ti.y);ctx.stroke();ctx.setLineDash([]);
      // Target glow
      ctx.globalAlpha=(Math.sin(la*3)*0.2+0.5)*prog;
      const g=ctx.createRadialGradient(ti.x,ti.y,0,ti.x,ti.y,16+prog*10);g.addColorStop(0,`rgba(${rgb},0.3)`);g.addColorStop(1,`rgba(${rgb},0)`);ctx.fillStyle=g;ctx.beginPath();ctx.arc(ti.x,ti.y,16+prog*10,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
      // Dollar flow
      if(prog>0.5){const ft=(la*0.5)%1;for(let i=0;i<3;i++){const t=(ft+i*0.33)%1;ctx.globalAlpha=0.3+prog*0.5;ctx.fillStyle=col;ctx.font='9px Orbitron';ctx.textAlign='center';ctx.fillText('$',iso.x+(ti.x-iso.x)*t,iso.y-8+(ti.y-iso.y+8)*t)}ctx.globalAlpha=1}
    } else {
      // Moving line to target
      ctx.strokeStyle=`rgba(${rgb},0.12)`;ctx.lineWidth=1;ctx.setLineDash([3,6]);ctx.beginPath();ctx.moveTo(iso.x,iso.y);ctx.lineTo(ti.x,ti.y);ctx.stroke();ctx.setLineDash([]);
    }
  }

  const bx=iso.x, by=iso.y+bob;
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(bx,iso.y+3,7,3.5,0,0,Math.PI*2);ctx.fill();
  // Convert glow
  if(u.state==='converting'){ctx.globalAlpha=Math.sin(la*3)*0.1+0.15;const g=ctx.createRadialGradient(bx,by-8,0,bx,by-8,14);g.addColorStop(0,`rgba(${rgb},0.4)`);g.addColorStop(1,`rgba(${rgb},0)`);ctx.fillStyle=g;ctx.beginPath();ctx.arc(bx,by-8,14,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}

  // Profile icon background ‚Äî shape varies by type
  const r=9;
  const cx=bx, cy=by-r-2;

  if(u.type==='talent_acq'){
    // TALENT ACQUISITION ‚Äî diamond frame in purple/magenta with suit figure
    const dr=r*1.1;
    ctx.fillStyle=isP?'#1a0a2a':'#2a0a1a';
    ctx.beginPath();ctx.moveTo(cx,cy-dr);ctx.lineTo(cx+dr,cy);ctx.lineTo(cx,cy+dr);ctx.lineTo(cx-dr,cy);ctx.closePath();ctx.fill();
    ctx.strokeStyle=isP?'#bb44ff':'#ff44bb';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(cx,cy-dr);ctx.lineTo(cx+dr,cy);ctx.lineTo(cx,cy+dr);ctx.lineTo(cx-dr,cy);ctx.closePath();ctx.stroke();
    // Second inner diamond glow
    ctx.strokeStyle=isP?'rgba(187,68,255,0.3)':'rgba(255,68,187,0.3)';ctx.lineWidth=1;
    const ir=dr*0.7;ctx.beginPath();ctx.moveTo(cx,cy-ir);ctx.lineTo(cx+ir,cy);ctx.lineTo(cx,cy+ir);ctx.lineTo(cx-ir,cy);ctx.closePath();ctx.stroke();
    // Person clipped inside diamond
    ctx.save();ctx.beginPath();ctx.moveTo(cx,cy-dr+1);ctx.lineTo(cx+dr-1,cy);ctx.lineTo(cx,cy+dr-1);ctx.lineTo(cx-dr+1,cy);ctx.closePath();ctx.clip();
    // Suit body
    ctx.fillStyle=isP?'#4422aa':'#aa2244';ctx.beginPath();ctx.ellipse(cx,cy+dr,6,5,0,0,Math.PI*2);ctx.fill();
    // Suit lapels
    ctx.fillStyle=isP?'#2a1166':'#661122';ctx.beginPath();ctx.moveTo(cx-4,cy+1);ctx.lineTo(cx,cy+4);ctx.lineTo(cx-6,cy+9);ctx.fill();
    ctx.beginPath();ctx.moveTo(cx+4,cy+1);ctx.lineTo(cx,cy+4);ctx.lineTo(cx+6,cy+9);ctx.fill();
    // Tie
    ctx.fillStyle=isP?'#bb44ff':'#ff44bb';ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx-1.2,cy+3.5);ctx.lineTo(cx,cy+7);ctx.lineTo(cx+1.2,cy+3.5);ctx.closePath();ctx.fill();
    // Head
    ctx.fillStyle='#ddb88c';ctx.beginPath();ctx.arc(cx,cy-2.5,3.5,0,Math.PI*2);ctx.fill();
    // Hair
    ctx.fillStyle='#2a1a12';ctx.beginPath();ctx.arc(cx,cy-4,3.5,Math.PI+0.3,Math.PI*2-0.3);ctx.fill();
    ctx.restore();
    // Target reticle icon
    ctx.strokeStyle=isP?'#bb44ff':'#ff44bb';ctx.lineWidth=1;ctx.globalAlpha=0.6;
    ctx.beginPath();ctx.arc(cx+6,cy-5,3,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx+6,cy-7.5);ctx.lineTo(cx+6,cy-2.5);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx+3.5,cy-5);ctx.lineTo(cx+8.5,cy-5);ctx.stroke();
    ctx.globalAlpha=1;

  } else if(u.type==='ai_agent'){
    // ROBOT ‚Äî hexagonal frame, circuit face, antenna
    ctx.fillStyle=isP?'#0a1a2a':'#2a0a1a';
    ctx.beginPath();for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/6;ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a))}ctx.closePath();ctx.fill();
    ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.beginPath();for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/6;ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a))}ctx.closePath();ctx.stroke();
    // Robot face
    ctx.save();ctx.beginPath();for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/6;ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a))}ctx.closePath();ctx.clip();
    ctx.fillStyle=isP?'#0d2d1d':'#2d0d0d';ctx.fillRect(cx-r,cy-r,r*2,r*2);
    // Eyes ‚Äî glowing rectangles
    ctx.fillStyle=col;ctx.fillRect(cx-4,cy-3,3,2);ctx.fillRect(cx+1,cy-3,3,2);
    // Mouth ‚Äî grid
    ctx.fillStyle=col;ctx.globalAlpha=0.5;for(let i=0;i<4;i++)ctx.fillRect(cx-4+i*2.5,cy+2,1.5,1.5);ctx.globalAlpha=1;
    // Circuit lines
    ctx.strokeStyle=col;ctx.globalAlpha=0.3;ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(cx-6,cy);ctx.lineTo(cx-3,cy);ctx.lineTo(cx-3,cy-5);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx+6,cy+1);ctx.lineTo(cx+3,cy+1);ctx.lineTo(cx+3,cy+5);ctx.stroke();ctx.globalAlpha=1;
    ctx.restore();
    // Antenna
    ctx.strokeStyle=col;ctx.lineWidth=1.2;ctx.beginPath();ctx.moveTo(cx,cy-r);ctx.lineTo(cx,cy-r-5);ctx.stroke();
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(cx,cy-r-5,2,0,Math.PI*2);ctx.fill();

  } else if(u.type==='marketer'){
    // MARKETER ‚Äî square frame (like a billboard), megaphone icon, bright colors
    const s=r*0.85;
    ctx.fillStyle=isP?'#0a2a1a':'#2a1a0a';
    ctx.fillRect(cx-s,cy-s,s*2,s*2);
    ctx.strokeStyle=isP?'#44dd88':'#dd8844';ctx.lineWidth=1.5;ctx.strokeRect(cx-s,cy-s,s*2,s*2);
    // Person with megaphone
    ctx.save();ctx.beginPath();ctx.rect(cx-s+1,cy-s+1,s*2-2,s*2-2);ctx.clip();
    // Body ‚Äî bright shirt
    ctx.fillStyle=isP?'#22aa55':'#cc6622';ctx.beginPath();ctx.ellipse(cx,cy+s+1,6,5,0,0,Math.PI*2);ctx.fill();
    // Head
    ctx.fillStyle='#ddb88c';ctx.beginPath();ctx.arc(cx-1,cy-2,3.5,0,Math.PI*2);ctx.fill();
    // Hair ‚Äî styled
    ctx.fillStyle='#cc8833';ctx.beginPath();ctx.arc(cx-1,cy-3.5,3.5,Math.PI,Math.PI*2);ctx.fill();
    ctx.restore();
    // Megaphone
    ctx.fillStyle=isP?'#44dd88':'#dd8844';
    ctx.beginPath();ctx.moveTo(cx+2,cy-1);ctx.lineTo(cx+7,cy-4);ctx.lineTo(cx+7,cy+2);ctx.closePath();ctx.fill();
    ctx.fillRect(cx,cy-1,2,2);

  } else if(u.type==='service_rep'){
    // SERVICE REP ‚Äî shield-shaped frame, headset, calming blue-green
    ctx.fillStyle=isP?'#0a1a2a':'#2a1a1a';
    ctx.beginPath();ctx.moveTo(cx,cy-r);ctx.lineTo(cx+r,cy-r*0.3);ctx.lineTo(cx+r*0.7,cy+r);ctx.lineTo(cx,cy+r*0.7);ctx.lineTo(cx-r*0.7,cy+r);ctx.lineTo(cx-r,cy-r*0.3);ctx.closePath();ctx.fill();
    ctx.strokeStyle=isP?'#44aadd':'#dd6644';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(cx,cy-r);ctx.lineTo(cx+r,cy-r*0.3);ctx.lineTo(cx+r*0.7,cy+r);ctx.lineTo(cx,cy+r*0.7);ctx.lineTo(cx-r*0.7,cy+r);ctx.lineTo(cx-r,cy-r*0.3);ctx.closePath();ctx.stroke();
    // Person clipped
    ctx.save();ctx.beginPath();ctx.moveTo(cx,cy-r);ctx.lineTo(cx+r,cy-r*0.3);ctx.lineTo(cx+r*0.7,cy+r);ctx.lineTo(cx,cy+r*0.7);ctx.lineTo(cx-r*0.7,cy+r);ctx.lineTo(cx-r,cy-r*0.3);ctx.closePath();ctx.clip();
    ctx.fillStyle=isP?'#1166aa':'#aa4422';ctx.beginPath();ctx.ellipse(cx,cy+r+1,6,5,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#c4a47a';ctx.beginPath();ctx.arc(cx,cy-1.5,3.5,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#2a1a12';ctx.beginPath();ctx.arc(cx,cy-3,3.5,Math.PI,Math.PI*2);ctx.fill();
    ctx.restore();
    // Headset
    ctx.strokeStyle=isP?'#44aadd':'#dd6644';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(cx,cy-3,5.5,Math.PI+0.4,Math.PI*2-0.4);ctx.stroke();
    ctx.fillStyle=isP?'#44aadd':'#dd6644';ctx.beginPath();ctx.arc(cx+5,cy-1.5,2,0,Math.PI*2);ctx.fill();

  } else if(u.type==='sr_sales_rep'){
    // SR. SALES REP ‚Äî circle frame with gold ring, tie, professional look
    ctx.fillStyle=isP?'#0a2a18':'#2a0a0a';
    ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#ddaa33';ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.stroke();
    ctx.strokeStyle=col;ctx.lineWidth=1;ctx.beginPath();ctx.arc(cx,cy,r+1.5,0,Math.PI*2);ctx.stroke();
    // Person
    ctx.save();ctx.beginPath();ctx.arc(cx,cy,r-1,0,Math.PI*2);ctx.clip();
    ctx.fillStyle=isP?'#1a4a2a':'#4a1a1a';ctx.beginPath();ctx.ellipse(cx,cy+r+1,7,6,0,0,Math.PI*2);ctx.fill();
    // Suit lapels
    ctx.fillStyle=isP?'#0a3318':'#330a0a';ctx.beginPath();ctx.moveTo(cx-5,cy+2);ctx.lineTo(cx,cy+5);ctx.lineTo(cx-7,cy+10);ctx.fill();
    ctx.beginPath();ctx.moveTo(cx+5,cy+2);ctx.lineTo(cx,cy+5);ctx.lineTo(cx+7,cy+10);ctx.fill();
    // Tie
    ctx.fillStyle='#ddaa33';ctx.beginPath();ctx.moveTo(cx,cy+1);ctx.lineTo(cx-1.5,cy+5);ctx.lineTo(cx,cy+8);ctx.lineTo(cx+1.5,cy+5);ctx.closePath();ctx.fill();
    // Head
    ctx.fillStyle='#ddb88c';ctx.beginPath();ctx.arc(cx,cy-2,4,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#3a2818';ctx.beginPath();ctx.arc(cx,cy-3.5,4,Math.PI+0.3,Math.PI*2-0.3);ctx.fill();
    // Star badge
    ctx.restore();
    ctx.fillStyle='#ddaa33';ctx.font='7px serif';ctx.textAlign='center';ctx.fillText('‚òÖ',cx-6,cy-4);

  } else {
    // SALES REP ‚Äî basic circle, briefcase, friendly look
    ctx.fillStyle=isP?'#0a2a12':'#2a0a0a';
    ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.stroke();
    // Person
    ctx.save();ctx.beginPath();ctx.arc(cx,cy,r-1,0,Math.PI*2);ctx.clip();
    ctx.fillStyle=isP?'#00dd44':'#dd3333';ctx.beginPath();ctx.ellipse(cx,cy+r+1,7,6,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ddb88c';ctx.beginPath();ctx.arc(cx,cy-2,4,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#4a3828';ctx.beginPath();ctx.arc(cx,cy-3.5,4,Math.PI,Math.PI*2);ctx.fill();
    ctx.restore();
    // Briefcase
    ctx.fillStyle=isP?'#116622':'#661122';ctx.fillRect(cx+5,cy+1,5,4);
    ctx.strokeStyle='#886633';ctx.lineWidth=0.8;ctx.strokeRect(cx+5,cy+1,5,4);
    ctx.strokeStyle='#886633';ctx.lineWidth=0.8;ctx.beginPath();ctx.moveTo(cx+6.5,cy+1);ctx.lineTo(cx+6.5,cy-0.5);ctx.lineTo(cx+8.5,cy-0.5);ctx.lineTo(cx+8.5,cy+1);ctx.stroke();
  }

  // ---- DEAL STAGE PILL (above head, with integrated progress bar) ----
  if(u.state==='converting'&&lp>0){
    const prog=lp/100;
    const stage=prog<0.25?'DISCOVERY':prog<0.5?'DEMO':prog<0.75?'NEGOTIATION':'CLOSING';
    const sc=prog<0.25?'#5580aa':prog<0.5?'#3399dd':prog<0.75?'#ee9900':col;
    const pillW=50,pillH=14,pillX=bx-pillW/2,pillY=by-r-26;
    const pillR=7; // corner radius

    // Pill background
    ctx.fillStyle='rgba(8,8,16,0.92)';
    ctx.beginPath();ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillR,pillR);ctx.lineTo(pillX+pillW,pillY+pillH-pillR);ctx.arcTo(pillX+pillW,pillY+pillH,pillX+pillW-pillR,pillY+pillH,pillR);ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arcTo(pillX,pillY+pillH,pillX,pillY+pillH-pillR,pillR);ctx.lineTo(pillX,pillY+pillR);ctx.arcTo(pillX,pillY,pillX+pillR,pillY,pillR);ctx.closePath();ctx.fill();

    // Progress fill (clipped to pill shape)
    ctx.save();ctx.beginPath();ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillR,pillR);ctx.lineTo(pillX+pillW,pillY+pillH-pillR);ctx.arcTo(pillX+pillW,pillY+pillH,pillX+pillW-pillR,pillY+pillH,pillR);ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arcTo(pillX,pillY+pillH,pillX,pillY+pillH-pillR,pillR);ctx.lineTo(pillX,pillY+pillR);ctx.arcTo(pillX,pillY,pillX+pillR,pillY,pillR);ctx.closePath();ctx.clip();
    ctx.fillStyle=sc;ctx.globalAlpha=0.25;ctx.fillRect(pillX,pillY,pillW*prog,pillH);ctx.globalAlpha=1;
    ctx.restore();

    // Pill border
    ctx.strokeStyle=sc;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillR,pillR);ctx.lineTo(pillX+pillW,pillY+pillH-pillR);ctx.arcTo(pillX+pillW,pillY+pillH,pillX+pillW-pillR,pillY+pillH,pillR);ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arcTo(pillX,pillY+pillH,pillX,pillY+pillH-pillR,pillR);ctx.lineTo(pillX,pillY+pillR);ctx.arcTo(pillX,pillY,pillX+pillR,pillY,pillR);ctx.closePath();ctx.stroke();

    // Stage text + percentage
    ctx.fillStyle=sc;ctx.font='bold 7px Orbitron';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(stage+' '+Math.floor(prog*100)+'%',bx,pillY+pillH/2);
    ctx.textBaseline='alphabetic';

    // Small connector line from pill to head
    ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=0.5;
    ctx.beginPath();ctx.moveTo(bx,pillY+pillH);ctx.lineTo(bx,by-r-13);ctx.stroke();
  }

  // ---- NOT INTERESTED PILL (CS Rep blocking) ----
  if(u.state==='blocked'&&u.target){
    const pillW=62,pillH=14,pillX=bx-pillW/2,pillY=by-r-26;
    const pillR=7;const sc='#ff6644';
    // Pill background
    ctx.fillStyle='rgba(8,8,16,0.92)';
    ctx.beginPath();ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillR,pillR);ctx.lineTo(pillX+pillW,pillY+pillH-pillR);ctx.arcTo(pillX+pillW,pillY+pillH,pillX+pillW-pillR,pillY+pillH,pillR);ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arcTo(pillX,pillY+pillH,pillX,pillY+pillH-pillR,pillR);ctx.lineTo(pillX,pillY+pillR);ctx.arcTo(pillX,pillY,pillX+pillR,pillY,pillR);ctx.closePath();ctx.fill();
    // Red fill
    ctx.save();ctx.beginPath();ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillR,pillR);ctx.lineTo(pillX+pillW,pillY+pillH-pillR);ctx.arcTo(pillX+pillW,pillY+pillH,pillX+pillW-pillR,pillY+pillH,pillR);ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arcTo(pillX,pillY+pillH,pillX,pillY+pillH-pillR,pillR);ctx.lineTo(pillX,pillY+pillR);ctx.arcTo(pillX,pillY,pillX+pillR,pillY,pillR);ctx.closePath();ctx.clip();
    ctx.fillStyle=sc;ctx.globalAlpha=0.15;ctx.fillRect(pillX,pillY,pillW,pillH);ctx.globalAlpha=1;ctx.restore();
    // Pill border
    ctx.strokeStyle=sc;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillR,pillR);ctx.lineTo(pillX+pillW,pillY+pillH-pillR);ctx.arcTo(pillX+pillW,pillY+pillH,pillX+pillW-pillR,pillY+pillH,pillR);ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arcTo(pillX,pillY+pillH,pillX,pillY+pillH-pillR,pillR);ctx.lineTo(pillX,pillY+pillR);ctx.arcTo(pillX,pillY,pillX+pillR,pillY,pillR);ctx.closePath();ctx.stroke();
    // Pulsing X + text
    const pulse=Math.sin(la*3)*0.15+0.85;
    ctx.globalAlpha=pulse;ctx.fillStyle=sc;ctx.font='bold 6px Orbitron';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('‚úï NOT INTERESTED',bx,pillY+pillH/2);ctx.textBaseline='alphabetic';ctx.globalAlpha=1;
    // Connector
    ctx.strokeStyle='rgba(255,100,68,0.15)';ctx.lineWidth=0.5;
    ctx.beginPath();ctx.moveTo(bx,pillY+pillH);ctx.lineTo(bx,by-r-13);ctx.stroke();
  }

  // ---- TA POACHING PROGRESS PILL ----
  if(u.type==='talent_acq'&&u.state==='recruiting'&&u.recruitTarget){
    const rp=u.pRecruitProgress!==undefined?u.pRecruitProgress+(u.recruitProgress-u.pRecruitProgress)*((la-u.pAnim)/(u.anim-u.pAnim)||0):u.recruitProgress;
    const prog=Math.min(1,rp/100);
    const stage=prog<0.33?'SOURCING':prog<0.66?'INTERVIEWING':'OFFER SENT';
    const sc=prog<0.33?'#9944cc':prog<0.66?'#bb44ff':'#dd66ff';
    const pillW=54,pillH=14,pillX=bx-pillW/2,pillY=by-r-26;
    const pillR=7;
    ctx.fillStyle='rgba(8,8,16,0.92)';
    ctx.beginPath();ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillR,pillR);ctx.lineTo(pillX+pillW,pillY+pillH-pillR);ctx.arcTo(pillX+pillW,pillY+pillH,pillX+pillW-pillR,pillY+pillH,pillR);ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arcTo(pillX,pillY+pillH,pillX,pillY+pillH-pillR,pillR);ctx.lineTo(pillX,pillY+pillR);ctx.arcTo(pillX,pillY,pillX+pillR,pillY,pillR);ctx.closePath();ctx.fill();
    ctx.save();ctx.beginPath();ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillR,pillR);ctx.lineTo(pillX+pillW,pillY+pillH-pillR);ctx.arcTo(pillX+pillW,pillY+pillH,pillX+pillW-pillR,pillY+pillH,pillR);ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arcTo(pillX,pillY+pillH,pillX,pillY+pillH-pillR,pillR);ctx.lineTo(pillX,pillY+pillR);ctx.arcTo(pillX,pillY,pillX+pillR,pillY,pillR);ctx.closePath();ctx.clip();
    ctx.fillStyle=sc;ctx.globalAlpha=0.25;ctx.fillRect(pillX,pillY,pillW*prog,pillH);ctx.globalAlpha=1;ctx.restore();
    ctx.strokeStyle=sc;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(pillX+pillR,pillY);ctx.lineTo(pillX+pillW-pillR,pillY);ctx.arcTo(pillX+pillW,pillY,pillX+pillW,pillY+pillR,pillR);ctx.lineTo(pillX+pillW,pillY+pillH-pillR);ctx.arcTo(pillX+pillW,pillY+pillH,pillX+pillW-pillR,pillY+pillH,pillR);ctx.lineTo(pillX+pillR,pillY+pillH);ctx.arcTo(pillX,pillY+pillH,pillX,pillY+pillH-pillR,pillR);ctx.lineTo(pillX,pillY+pillR);ctx.arcTo(pillX,pillY,pillX+pillR,pillY,pillR);ctx.closePath();ctx.stroke();
    ctx.fillStyle=sc;ctx.font='bold 6px Orbitron';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(stage+' '+Math.floor(prog*100)+'%',bx,pillY+pillH/2);ctx.textBaseline='alphabetic';
    // Dashed beam to recruit target
    const ti=lerpPos?lerpPos(u.recruitTarget):toIso(u.recruitTarget.x,u.recruitTarget.y);
    ctx.strokeStyle=`rgba(187,68,255,${0.2+prog*0.4})`;ctx.lineWidth=1+prog*1.5;ctx.setLineDash([4,4]);ctx.lineDashOffset=-la*10;
    ctx.beginPath();ctx.moveTo(iso.x,iso.y-8);ctx.lineTo(ti.x,ti.y);ctx.stroke();ctx.setLineDash([]);
    // Pulsing purple ring around target being poached
    const rPulse=Math.sin(la*3)*0.2+0.8;
    ctx.globalAlpha=rPulse*(0.3+prog*0.5);
    ctx.strokeStyle='#bb44ff';ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(ti.x,ti.y+4,14+prog*6,7+prog*3,0,0,Math.PI*2);ctx.stroke();
    const tg=ctx.createRadialGradient(ti.x,ti.y,0,ti.x,ti.y,18+prog*8);tg.addColorStop(0,'rgba(187,68,255,0.25)');tg.addColorStop(1,'rgba(187,68,255,0)');ctx.fillStyle=tg;ctx.beginPath();ctx.arc(ti.x,ti.y,18+prog*8,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
  }

  // ---- TA NEGOTIATION RENDERING ----
  if(u.type==='talent_acq'&&u.state==='negotiating'&&u.negotiatingWith){
    const np=u.pNegotiationProgress!==undefined?u.pNegotiationProgress+(u.negotiationProgress-u.pNegotiationProgress)*((la-u.pAnim)/(u.anim-u.pAnim)||0):u.negotiationProgress;
    const ei=lerpPos?lerpPos(u.negotiatingWith):toIso(u.negotiatingWith.x,u.negotiatingWith.y);
    // Dashed beam between the two TAs
    ctx.strokeStyle='rgba(187,68,255,0.5)';ctx.lineWidth=2;ctx.setLineDash([6,4]);ctx.lineDashOffset=-la*12;
    ctx.beginPath();ctx.moveTo(iso.x,iso.y-8);ctx.lineTo(ei.x,ei.y-8);ctx.stroke();ctx.setLineDash([]);
    // Tug-of-war indicator dot
    const t=np/100;
    const dotX=iso.x+(ei.x-iso.x)*t,dotY=(iso.y-8)+(ei.y-8-iso.y+8)*t;
    const dotCol=t>0.5?col:'#ff3333';
    ctx.fillStyle=dotCol;ctx.beginPath();ctx.arc(dotX,dotY,4,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=1;ctx.beginPath();ctx.arc(dotX,dotY,4,0,Math.PI*2);ctx.stroke();
    // Progress label
    ctx.fillStyle='rgba(8,8,16,0.85)';ctx.fillRect(dotX-18,dotY-16,36,11);
    ctx.fillStyle='#bb44ff';ctx.font='bold 6px Orbitron';ctx.textAlign='center';
    ctx.fillText('NEGOTIATE',dotX,dotY-8);
  }

  if(u.state==='building'&&u.bp!==undefined){
    // Construction overlay on unit
    const prog=u.bp/u.bt;
    // Dim the unit
    ctx.globalAlpha=0.3+prog*0.7;
    // Draw a circular mask that fills clockwise
    ctx.save();ctx.beginPath();ctx.arc(cx,cy,r+1,0,Math.PI*2);ctx.clip();
    ctx.fillStyle='rgba(8,8,16,0.6)';ctx.fillRect(cx-r-2,cy-r-2,r*2+4,r*2+4);
    // Reveal arc
    ctx.fillStyle='rgba(0,0,0,0)';ctx.globalCompositeOperation='destination-out';
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r+2,-Math.PI/2,-Math.PI/2+Math.PI*2*prog);ctx.closePath();ctx.fill();
    ctx.globalCompositeOperation='source-over';
    ctx.restore();ctx.globalAlpha=1;
    // Progress ring
    ctx.strokeStyle=isP?'#00ff41':'#ff3333';ctx.lineWidth=2;
    ctx.beginPath();ctx.arc(cx,cy,r+2,-Math.PI/2,-Math.PI/2+Math.PI*2*prog);ctx.stroke();
    // Label
    ctx.fillStyle=isP?'#00ff41':'#ff3333';ctx.font='bold 6px Orbitron';ctx.textAlign='center';
    ctx.fillText('TRAINING '+Math.floor(prog*100)+'%',bx,iso.y+10);
    return; // Don't draw deal pill or other status
  }

  // CS Rep defense range indicator
  if(u.type==='service_rep'&&u.state==='idle'){
    const defR=u.owner.tech.customer_success?8:4;
    const nearCust=u.owner.customers.some(c=>Math.sqrt((u.x-c.x)**2+(u.y-c.y)**2)<defR);
    if(nearCust){
      const pulse=Math.sin(la*2)*0.08+0.12;
      ctx.globalAlpha=pulse;ctx.strokeStyle=isP?'#44aadd':'#dd6644';ctx.lineWidth=1;
      const rPx=defR*TW*0.35;
      ctx.beginPath();ctx.ellipse(bx,iso.y+2,rPx,rPx*0.5,0,0,Math.PI*2);ctx.stroke();
      ctx.globalAlpha=1;
    }
  }
  // Status label
  ctx.font='6px Share Tech Mono';ctx.textAlign='center';
  if(u.state==='idle'&&u.type==='service_rep'){
    const defR=u.owner.tech.customer_success?8:4;
    const nearCust=u.owner.customers.some(c=>Math.sqrt((u.x-c.x)**2+(u.y-c.y)**2)<defR);
    if(nearCust){ctx.fillStyle='#44aadd';ctx.fillText('DEFENDING',bx,iso.y+10)}
    else{ctx.fillStyle='#444';ctx.fillText('IDLE',bx,iso.y+10)}
  } else if(u.state==='idle'){ctx.fillStyle='#444';ctx.fillText('IDLE',bx,iso.y+10)}
  else if(u.state==='moving'){ctx.fillStyle='#446';ctx.fillText('‚ñ∏‚ñ∏',bx,iso.y+10)}
  else if(u.state==='blocked'){ctx.fillStyle='#ff6644';ctx.fillText('BLOCKED',bx,iso.y+10)}
  else if(u.state==='sabotaging'){ctx.fillStyle='#ff8800';ctx.fillText('SABOTAGING',bx,iso.y+10)}
  else if(u.state==='recruiting'){ctx.fillStyle='#bb44ff';ctx.fillText('POACHING',bx,iso.y+10)}
  else if(u.state==='negotiating'){ctx.fillStyle='#ff44bb';ctx.fillText('NEGOTIATING',bx,iso.y+10)}
}

// ---- MINIMAP ‚Äî shows UK/Ireland shape ----
function drawMinimap(){
  mmCtx.fillStyle='#0a0a12';mmCtx.fillRect(0,0,200,260);
  const s=200/MAP,ox=0,oy=10;
  // Landmass
  function drawOutlineMM(outline,col){mmCtx.beginPath();outline.forEach((p,i)=>{const px=p[0]*s+ox,py=p[1]*s+oy;i===0?mmCtx.moveTo(px,py):mmCtx.lineTo(px,py)});mmCtx.closePath();mmCtx.fillStyle=col;mmCtx.fill();mmCtx.strokeStyle='rgba(255,255,255,0.1)';mmCtx.lineWidth=1;mmCtx.stroke()}
  drawOutlineMM(IRELAND_OUTLINE,'rgba(20,40,45,0.6)');
  drawOutlineMM(UK_OUTLINE,'rgba(20,40,45,0.6)');
  // Cities
  CITIES.forEach(c=>{mmCtx.fillStyle='rgba(100,140,180,0.3)';mmCtx.beginPath();mmCtx.arc(c.x*s+ox,c.y*s+oy,c.size*1.5,0,Math.PI*2);mmCtx.fill()});
  // Customers
  freeCust.forEach(c=>{mmCtx.fillStyle='#555';mmCtx.fillRect(c.x*s+ox-0.5,c.y*s+oy-0.5,2,2)});
  // All players' customers in their color
  players.forEach(p=>{mmCtx.fillStyle=p.color;p.customers.forEach(c=>{mmCtx.fillRect(c.x*s+ox-0.5,c.y*s+oy-0.5,2,2)})});
  // Pulsing gold border for distressed side's customers
  players.forEach(p=>{if(isDistressed(p)){const pulse=Math.sin(gameTime*0.2)*0.3+0.7;mmCtx.strokeStyle=`rgba(255,215,0,${pulse})`;mmCtx.lineWidth=1;p.customers.forEach(c=>{mmCtx.strokeRect(c.x*s+ox-2,c.y*s+oy-2,4,4)})}});
  // Units ‚Äî all players
  players.forEach(p=>{mmCtx.fillStyle=p.color;p.units.forEach(u=>{mmCtx.fillRect(u.x*s+ox-1,u.y*s+oy-1,3,3)})});
  // HQ markers ‚Äî all players
  players.forEach(p=>{mmCtx.strokeStyle=p.color;mmCtx.lineWidth=2;p.buildings.slice(0,1).forEach(b=>{mmCtx.strokeRect(b.x*s+ox-3,b.y*s+oy-3,6,6)})});
}

// ---- UI ----
function updateUI(){
  const burn=player.units.reduce((s,u)=>s+u.salary,0);
  const net=player.arr-burn;
  document.getElementById('cashDisplay').textContent='$'+Math.floor(player.cash)+'K';
  document.getElementById('arrDisplay').textContent='$'+Math.floor(player.arr)+'K';
  document.getElementById('burnDisplay').textContent='$'+burn+'K';
  document.getElementById('netDisplay').textContent=(net>=0?'+':'')+Math.floor(net)+'K';
  document.getElementById('netDisplay').style.color=net>0?'var(--green)':net<0?'var(--red)':'#888';
  document.getElementById('custDisplay').textContent=player.customers.length;
  document.getElementById('freeDisplay').textContent=freeCust.length;
  document.getElementById('cashDisplay').style.color=player.cash<100?'var(--red)':player.cash<200?'var(--orange)':'var(--green)';
  // Win condition HUD
  const wcEl=document.getElementById('winCondDisplay');
  const wcLbl=document.getElementById('winCondLabel');
  const wcIcn=document.getElementById('winCondIcon');
  if(winCondition==='domination'){
    wcIcn.textContent='üèÜ';wcLbl.textContent='Share';
    const pct=TOTAL_CUST>0?Math.round(player.customers.length/TOTAL_CUST*100):0;
    wcEl.textContent=pct+'% / 75%';wcEl.style.color=pct>=60?'#00ff41':pct>=40?'#ffdd44':'#bb88ff';
  } else if(winCondition==='mrr_race'){
    wcIcn.textContent='‚è±';wcLbl.textContent='MRR Race';
    const left=Math.max(0,500-gameTime);
    wcEl.textContent='$'+Math.floor(player.arr)+'/$500K ('+left+'t)';wcEl.style.color=player.arr>=400?'#00ff41':player.arr>=200?'#ffdd44':'#bb88ff';
  } else if(winCondition==='elimination'){
    wcIcn.textContent='üíÄ';wcLbl.textContent='Alive';
    const aliveCount=players.filter(p=>p!==player&&(p.cash>0||p.arr>0||p.customers.length>0)).length;
    wcEl.textContent=aliveCount+' opponent'+(aliveCount!==1?'s':'')+' left';wcEl.style.color=aliveCount<=1?'#00ff41':aliveCount<=2?'#ffdd44':'#bb88ff';
  } else if(winCondition==='conquest'){
    wcIcn.textContent='üåç';wcLbl.textContent='Conquest';
    const pct=TOTAL_CUST>0?Math.round(player.customers.length/TOTAL_CUST*100):0;
    wcEl.textContent=player.customers.length+'/'+TOTAL_CUST+' ('+pct+'%)';wcEl.style.color=pct>=90?'#00ff41':pct>=50?'#ffdd44':'#bb88ff';
  }
  const now=performance.now();if(now-lastBtnRebuild>250){lastBtnRebuild=now;updateBuildBtns();updateUnitBtns();updateTechBtns();updateTeamList()}updateIntel()}
function updateBuildBtns(){const c=document.getElementById('buildingButtons');c.innerHTML='';
  Object.entries(BLDGS).forEach(([k,b])=>{const has=!b.requires||player.buildings.some(p=>p.type===b.requires&&p.bp===undefined);const dup=player.buildings.some(p=>p.type===k)&&k!=='hq_upgrade';
    const row=document.createElement('div');row.className='build-btn-row';
    const btn=document.createElement('button');btn.className='build-btn';btn.disabled=!has||dup||player.cash<b.cost;btn.innerHTML=`<span class="btn-icon">${b.icon}</span><span class="btn-info"><span class="btn-name">${b.name}</span><span class="btn-cost">$${b.cost}K</span></span>`;btn.onclick=()=>buildBldg(k);
    if(btn.disabled){if(!has)btn.title='Requires '+((BLDGS[b.requires]||{}).name||b.requires);else if(dup)btn.title='Already built';else btn.title='Not enough cash ($'+b.cost+'K needed)'}else{btn.title=''}
    const ib=document.createElement('button');ib.className='info-btn';ib.textContent='i';ib.onclick=(e)=>{e.stopPropagation();showBldgInfo(k)};
    row.appendChild(btn);row.appendChild(ib);c.appendChild(row)})}
function updateUnitBtns(){const c=document.getElementById('unitButtons');c.innerHTML='';
  const cap=player.buildings.filter(b=>b.type==='office'&&b.bp===undefined).length*5+player.buildings.filter(b=>b.type==='hq_upgrade'&&b.bp===undefined).length*10;
  Object.entries(UNITS_DEF).forEach(([k,u])=>{const hB=!u.requires||player.buildings.some(p=>p.type===u.requires&&p.bp===undefined);const hT=!u.techReq||player.tech[u.techReq]===true;const atC=player.units.length>=cap;
    const taMax=k==='talent_acq'&&player.taBuilt;
    const row=document.createElement('div');row.className='build-btn-row';
    const btn=document.createElement('button');btn.className='build-btn';btn.disabled=!hB||!hT||player.cash<u.cost||atC||taMax;
    if(btn.disabled){if(!hB)btn.title='Requires '+((BLDGS[u.requires]||{}).name||u.requires);else if(!hT)btn.title='Requires '+((TECHS[u.techReq]||{}).name||u.techReq)+' research';else if(player.cash<u.cost)btn.title='Not enough cash ($'+u.cost+'K needed)';else if(atC)btn.title='Office full ‚Äî build more offices or HQ Upgrade';else if(taMax)btn.title='Maximum 1 Talent Acquisition'}else{btn.title=''}
    const countLabel=taMax?'<span style="color:#bb44ff;font-size:9px">MAX 1</span>':'<span style="color:#555">('+player.units.filter(x=>x.type===k).length+')</span>';
    btn.innerHTML=`<span class="btn-icon">${u.icon}</span><span class="btn-info"><span class="btn-name">${u.name} ${countLabel}</span><span class="btn-cost">$${u.cost}K ¬∑ $${u.salary}K/mo</span></span>`;btn.onclick=()=>hireUnit(k);
    const ib=document.createElement('button');ib.className='info-btn';ib.textContent='i';ib.onclick=(e)=>{e.stopPropagation();showUnitInfo(k)};
    row.appendChild(btn);row.appendChild(ib);c.appendChild(row)})}
function updateTechBtns(){const c=document.getElementById('techButtons');c.innerHTML='';
  Object.entries(TECHS).forEach(([k,t])=>{const hB=!t.requires||player.buildings.some(p=>p.type===t.requires&&p.bp===undefined);const hT=!t.techReq||player.tech[t.techReq]===true;const done=player.tech[k]===true;const building=player.tech[k]==='building';
    const row=document.createElement('div');row.className='build-btn-row';
    const btn=document.createElement('button');btn.className='build-btn';btn.disabled=!hB||!hT||player.cash<t.cost||done||building;
    if(btn.disabled&&!done&&!building){if(!hB)btn.title='Requires '+((BLDGS[t.requires]||{}).name||t.requires);else if(!hT)btn.title='Requires '+((TECHS[t.techReq]||{}).name||t.techReq)+' research';else btn.title='Not enough cash ($'+t.cost+'K needed)'}else{btn.title=''}
    if(done)btn.style.borderColor='var(--green-dim)';
    if(building&&player.techBuild&&player.techBuild[k]){const tb=player.techBuild[k];const pct=Math.floor(tb.bp/tb.bt*100);btn.style.borderColor='var(--gold)';btn.innerHTML=`<span class="btn-icon">${t.icon}</span><span class="btn-info"><span class="btn-name">${t.name}</span><span class="btn-cost" style="color:var(--gold)">RESEARCHING ${pct}%</span></span>`}
    else{btn.innerHTML=`<span class="btn-icon">${t.icon}</span><span class="btn-info"><span class="btn-name">${t.name} ${done?'‚úì':''}</span><span class="btn-cost">${done?'DONE':'$'+t.cost+'K'}</span></span>`}
    btn.onclick=()=>resTech(k);
    const ib=document.createElement('button');ib.className='info-btn';ib.textContent='i';ib.onclick=(e)=>{e.stopPropagation();showTechInfo(k)};
    row.appendChild(btn);row.appendChild(ib);c.appendChild(row)})}function updateIntel(){const pP=Math.round(player.customers.length/TOTAL_CUST*100);const burn=player.units.reduce((s,u)=>s+u.salary,0);
  const cap=player.buildings.filter(b=>b.type==='office').length*5+player.buildings.filter(b=>b.type==='hq_upgrade').length*10;
  const hasMA=player.buildings.some(b=>b.type==='m_and_a_dept'&&b.bp===undefined);
  let oppLines='';
  players.filter(p=>p!==player).forEach(p=>{
    const ePct=Math.round(p.customers.length/TOTAL_CUST*100);
    const distTag=isDistressed(p)?'<span style="color:var(--gold);font-weight:bold"> VULNERABLE</span>':'';
    oppLines+=`<div style="color:${p.color}">‚ñ† ${p.name}: ${ePct}% (${p.customers.length})${distTag}</div>`;
  });
  const anyDistressed=players.find(p=>p!==player&&isDistressed(p));
  const acqBtn=(hasMA&&anyDistressed)?`<div style="margin-top:6px"><button onclick="tryPlayerAcquire()" style="background:rgba(255,215,0,0.15);border:1px solid var(--gold);color:var(--gold);font-family:'Orbitron',sans-serif;font-size:10px;padding:6px 12px;cursor:pointer;width:100%;letter-spacing:1px">üè¶ ACQUIRE ($${acquisitionCost(anyDistressed)}K)</button></div>`:'';
  const acqCountdown=aiAcqCountdown>0?`<div style="margin-top:6px;color:var(--red);font-weight:bold">‚ö† TAKEOVER: ${aiAcqCountdown}t<div style="background:#333;height:4px;margin-top:3px;border-radius:2px"><div style="background:var(--red);height:4px;width:${Math.round((AI_ACQ_DURATION-aiAcqCountdown)/AI_ACQ_DURATION*100)}%;border-radius:2px"></div></div></div>`:'';
  document.getElementById('marketIntel').innerHTML=`<div style="color:var(--green)">‚ñ† You: ${pP}% (${player.customers.length})</div>${oppLines}<div style="color:#666">‚ñ† Free: ${freeCust.length}</div><div style="margin-top:6px">Units: ${player.units.length}/${cap}</div>${acqBtn}${acqCountdown}`}
function updateTeamList(){
  const c=document.getElementById('teamList');c.innerHTML='';
  const cap=player.buildings.filter(b=>b.type==='office').length*5+player.buildings.filter(b=>b.type==='hq_upgrade').length*10;
  document.getElementById('teamCount').textContent=player.units.length+'/'+cap;
  // Group by type for summary
  const types={};player.units.forEach((u,i)=>{if(!types[u.type])types[u.type]={def:UNITS_DEF[u.type],units:[]};types[u.type].units.push({unit:u,idx:i})});
  Object.entries(types).forEach(([type,data])=>{
    const d=data.def;const totalSal=data.units.length*d.salary;
    // Type header
    const hdr=document.createElement('div');hdr.style.cssText='display:flex;align-items:center;gap:4px;padding:4px 6px;font-size:10px;color:#888;border-bottom:1px solid #1a1a2a;background:rgba(255,255,255,0.02)';
    hdr.innerHTML=`<span style="font-size:13px">${d.icon}</span><span style="flex:1;font-family:Orbitron,sans-serif;font-size:9px">${d.name} √ó${data.units.length}</span><span style="color:var(--orange);font-size:9px">$${totalSal}K/mo</span>`;
    c.appendChild(hdr);
    // Individual units
    data.units.forEach(({unit:u,idx})=>{
      const row=document.createElement('div');row.className='team-item';
      const isDefending=u.type==='service_rep'&&u.state==='idle'&&u.owner.customers.some(c=>Math.sqrt((u.x-c.x)**2+(u.y-c.y)**2)<(u.owner.tech.customer_success?8:4));
      const stateClass=u.state==='converting'?'converting':u.state==='moving'?'moving':u.state==='blocked'?'converting':u.state==='sabotaging'?'converting':u.state==='recruiting'?'converting':u.state==='negotiating'?'converting':isDefending?'moving':'idle';
      const stateLabel=u.state==='converting'?'SELLING':u.state==='moving'?'MOVING':u.state==='blocked'?'BLOCKED':u.state==='sabotaging'?'SABOTAGING':u.state==='recruiting'?'POACHING':u.state==='negotiating'?'NEGOTIATING':isDefending?'DEFENDING':'IDLE';
      const targetInfo=u.target?(' ‚Üí #'+u.target.id):'';
      row.innerHTML=`<span class="team-name" style="padding-left:20px">Rep ${idx+1}${targetInfo}</span><span class="team-state ${stateClass}">${stateLabel}</span><span class="team-salary">$${d.salary}K</span>`;
      const fb=document.createElement('button');fb.className='fire-btn';fb.textContent='‚úï';fb.title='Fire this team member';
      fb.onclick=()=>fireUnit(idx);
      row.appendChild(fb);
      // Click to select & center on unit
      row.style.cursor='pointer';
      row.addEventListener('click',(e)=>{if(e.target===fb)return;selectedUnit=u;selectedUnits=[];const iso=toIso(u.x,u.y);camX=iso.x-canvas.width/zoom/2;camY=iso.y-canvas.height/zoom/2});
      c.appendChild(row);
    });
  });
}
function fireUnit(idx){
  if(idx<0||idx>=player.units.length)return;
  const u=player.units[idx];
  const d=UNITS_DEF[u.type];
  // Can't fire your last unit
  if(player.units.length<=1){showToast('‚ö† Can\'t fire your last rep!');return}
  if(u.type==='talent_acq')player.taBuilt=false;
  player.units.splice(idx,1);
  if(selectedUnit===u)selectedUnit=null;
  const si=selectedUnits.indexOf(u);if(si>=0)selectedUnits.splice(si,1);
  addLog('Fired '+d.name+' (-$'+d.salary+'K/mo burn)','neutral');
  showToast('üëã '+d.name+' let go');
  if(mpMode)mpActionQueue.push({type:'fire',uid:idx});
  lastBtnRebuild=0;updateUI();
}
function buildBldg(type){if(player.cash<BLDGS[type].cost)return;player.cash-=BLDGS[type].cost;const b=player.buildings[0];const ox=(Math.random()-0.5)*3,oy=(Math.random()-0.5)*3;player.buildings.push({type,x:b.x+ox,y:b.y+oy,bp:0,bt:BLDGS[type].buildTime});addLog('Building '+BLDGS[type].name+'...','neutral');showToast('üèó '+BLDGS[type].name+'!');voiceSystem('building');lastBtnRebuild=0;updateUI();
  if(mpMode)mpActionQueue.push({type:'build',btype:type,ox,oy})}
function hireUnit(type){if(player.cash<UNITS_DEF[type].cost)return;
  if(type==='talent_acq'&&player.taBuilt){showToast('‚ö† Max 1 Talent Acquisition!');return}
  player.cash-=UNITS_DEF[type].cost;const b=player.buildings[0];const u=createUnit(type,player,b.x+(Math.random()-0.5)*2,b.y+(Math.random()-0.5)*2);u.bp=0;u.bt=UNITS_DEF[type].buildTime;u.state='building';player.units.push(u);
  if(type==='talent_acq')player.taBuilt=true;
  addLog('Training '+UNITS_DEF[type].name+'...','neutral');showToast('üë§ '+UNITS_DEF[type].name+'!');voiceSystem('training');lastBtnRebuild=0;updateUI();
  if(mpMode)mpActionQueue.push({type:'hire',utype:type})}
function resTech(k){if(player.cash<TECHS[k].cost||player.tech[k])return;player.cash-=TECHS[k].cost;player.tech[k]='building';player.techBuild=player.techBuild||{};player.techBuild[k]={bp:0,bt:TECHS[k].buildTime};addLog('Researching '+TECHS[k].name+'...','neutral');showToast('üî¨ '+TECHS[k].name+'!');voiceSystem('researching');lastBtnRebuild=0;updateUI();
  if(mpMode)mpActionQueue.push({type:'research',tech:k})}
function toggleSettings(){document.getElementById('settingsPanel').classList.toggle('open')}
function onSpeedSlider(v){speedMul=parseFloat(v);document.getElementById('speedLabel').textContent=v+'x'}
function setUIScale(v){const s=parseInt(v)/100;document.getElementById('uiScaleLabel').textContent=v+'%';['topBar','rightPanel','bottomBar'].forEach(id=>{const el=document.getElementById(id);if(el){el.style.transform='scale('+s+')';el.style.transformOrigin=id==='topBar'?'top left':id==='rightPanel'?'top right':'bottom left'}})}
function toggleSpeed(){const sp=[1,2,4,8];speedMul=sp[(sp.indexOf(speedMul)+1)%sp.length];document.getElementById('speedSlider').value=speedMul;document.getElementById('speedLabel').textContent=speedMul+'x'}
function addLog(msg,type){logs.unshift({msg,type,t:gameTime});if(logs.length>50)logs.pop();document.getElementById('eventLog').innerHTML=logs.slice(0,4).map(l=>`<span style="color:${l.type==='positive'?'var(--green-dim)':l.type==='negative'?'var(--red)':'var(--blue)'};margin-right:20px">[T${l.t}] ${l.msg}</span>`).join('')}
function showToast(m){const t=document.createElement('div');t.className='toast';t.textContent=m;document.getElementById('gameContainer').appendChild(t);setTimeout(()=>t.remove(),3000)}
function showBldgInfo(k){const b=BLDGS[k];const owned=player.buildings.filter(p=>p.type===k).length;
  const reqText=b.requires?'Requires: '+BLDGS[b.requires].name:'No requirements';
  document.getElementById('infoModalContent').innerHTML=`
    <h3><span class="modal-icon">${b.icon}</span>${b.name}</h3>
    <div class="modal-desc">${b.desc}</div>
    <div class="modal-stats">
      <div class="modal-stat"><div class="modal-stat-label">Cost</div><div class="modal-stat-value" style="color:var(--gold)">$${b.cost}K</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Owned</div><div class="modal-stat-value">${owned}</div></div>
      ${b.capacity?`<div class="modal-stat"><div class="modal-stat-label">Unit Cap</div><div class="modal-stat-value">+${b.capacity}</div></div>`:''}
      <div class="modal-stat"><div class="modal-stat-label">Type</div><div class="modal-stat-value" style="font-size:11px">Building</div></div>
    </div>
    <div class="modal-requires">${reqText}</div>
    <button class="modal-close" onclick="closeInfo()">CLOSE</button>`;
  document.getElementById('infoModal').classList.add('open')}
function showUnitInfo(k){const u=UNITS_DEF[k];const count=player.units.filter(x=>x.type===k).length;const totalSalary=count*u.salary;
  const reqText=[u.requires?'Building: '+BLDGS[u.requires].name:'',u.techReq?'Tech: '+TECHS[u.techReq].name:''].filter(Boolean).join(' ¬∑ ')||'No requirements';
  const abilities=[];
  if(u.power>0)abilities.push('Close deals (power: '+u.power+')');
  if(k==='sales_rep')abilities.push('Can steal enemy accounts (slow ‚Äî 0.15√ó rate)');
  if(k==='sr_sales_rep')abilities.push('Can steal enemy accounts (fast ‚Äî 0.5√ó rate)');
  if(k==='ai_agent')abilities.push('Can steal enemy accounts (fast ‚Äî 0.5√ó rate)');
  if(k==='marketer')abilities.push('Attracts nearby prospects');
  if(k==='service_rep'){abilities.push('Defends customers from enemy poaching');abilities.push('Slows enemy sales progress when nearby');abilities.push('Blocks sales entirely if CS reps outnumber attackers')}
  if(k==='ai_agent')abilities.push('AI-powered: fastest + strongest');
  if(k==='talent_acq'){abilities.push('Poaches enemy\'s best sales talent');abilities.push('Auto-targets highest-value enemy unit');abilities.push('Counters enemy TA in negotiation duels');abilities.push('Limit: 1 per team')}
  document.getElementById('infoModalContent').innerHTML=`
    <h3><span class="modal-icon">${u.icon}</span>${u.name}</h3>
    <div class="modal-desc">${u.desc}</div>
    <div class="modal-stats">
      <div class="modal-stat"><div class="modal-stat-label">Hire Cost</div><div class="modal-stat-value" style="color:var(--gold)">$${u.cost}K</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Salary</div><div class="modal-stat-value" style="color:var(--orange)">$${u.salary}K/mo</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Speed</div><div class="modal-stat-value">${u.speed}x</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Power</div><div class="modal-stat-value">${u.power}</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Deployed</div><div class="modal-stat-value">${count}</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Total Burn</div><div class="modal-stat-value" style="color:var(--orange)">$${totalSalary}K/mo</div></div>
    </div>
    <div class="modal-desc" style="border-left-color:var(--blue)">${abilities.map(a=>'‚Ä¢ '+a).join('<br>')}</div>
    <div class="modal-requires">${reqText}</div>
    <button class="modal-close" onclick="closeInfo()">CLOSE</button>`;
  document.getElementById('infoModal').classList.add('open')}
function showTechInfo(k){const t=TECHS[k];const done=player.tech[k];
  const reqText=[t.requires?'Building: '+BLDGS[t.requires].name:'',t.techReq?'Tech: '+TECHS[t.techReq].name:''].filter(Boolean).join(' ¬∑ ')||'No requirements';
  const effects=[];
  if(k==='basic_crm')effects.push('+20% close rate for all reps');
  if(k==='advanced_sales')effects.push('Unlocks Sr. Sales Rep hiring');
  if(k==='marketing_automation')effects.push('Doubles marketer attraction range');
  if(k==='customer_success')effects.push('Doubles CS rep defense range (4‚Üí8 tiles)');
  if(k==='ai_first')effects.push('Unlocks AI SDR ‚Äî fastest, strongest unit');
  if(k==='enterprise')effects.push('All accounts generate 2x MRR');
  document.getElementById('infoModalContent').innerHTML=`
    <h3><span class="modal-icon">${t.icon}</span>${t.name}</h3>
    <div class="modal-desc">${t.desc}</div>
    <div class="modal-stats">
      <div class="modal-stat"><div class="modal-stat-label">Research Cost</div><div class="modal-stat-value" style="color:var(--gold)">$${t.cost}K</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Status</div><div class="modal-stat-value" style="color:${done?'var(--green)':'#888'}">${done?'‚úì DONE':'Locked'}</div></div>
    </div>
    <div class="modal-desc" style="border-left-color:var(--gold)">${effects.map(e=>'‚òÖ '+e).join('<br>')}</div>
    <div class="modal-requires">${reqText}</div>
    <button class="modal-close" onclick="closeInfo()">CLOSE</button>`;
  document.getElementById('infoModal').classList.add('open')}
function showUnitInspector(u){
  const def=UNITS_DEF[u.type],isP=u.owner===player;
  const col=isP?'var(--green)':'var(--red)';
  const ownerName=isP?player.name:u.owner.name;
  const age=gameTime-(u.bornAt||0);
  const rank=u.dealsWon>=10?'‚òÖ‚òÖ‚òÖ VETERAN':u.dealsWon>=5?'‚òÖ‚òÖ EXPERIENCED':u.dealsWon>=1?'‚òÖ ACTIVE':'ROOKIE';
  const rankCol=u.dealsWon>=10?'#ffd700':u.dealsWon>=5?'#ddaa33':u.dealsWon>=1?'#88aacc':'#666';
  
  const abilities=[];
  if(def.power>0)abilities.push('Closes deals with power '+def.power);
  if(u.type==='sales_rep')abilities.push('Can steal enemy accounts (slow ‚Äî 0.15√ó rate)');
  if(u.type==='sr_sales_rep')abilities.push('Can steal enemy accounts (fast ‚Äî 0.5√ó rate)');
  if(u.type==='ai_agent')abilities.push('Can steal enemy accounts (fast ‚Äî 0.5√ó rate)');
  if(u.type==='marketer'){abilities.push('Sabotages enemy customer loyalty');abilities.push('Attracts free prospects within radius');abilities.push('Boosts prospect spawn rate in growing mode')}
  if(u.type==='service_rep'){abilities.push('Defends customers from enemy poaching');abilities.push('Slows enemy sales when near your accounts');abilities.push('Blocks sales if CS reps outnumber attackers')}
  if(u.type==='ai_agent')abilities.push('AI-powered: fastest movement + strongest close');
  if(u.type==='talent_acq'){abilities.push('Poaches enemy\'s best sales talent');abilities.push('Auto-targets highest-value enemy unit');abilities.push('Counters enemy TA in negotiation duels')}

  const stateLabel=u.state==='building'?'Under Training':u.state==='converting'?'Closing a Deal':u.state==='moving'?'En Route':u.state==='idle'?'Idle':u.state==='blocked'?'Not Interested (CS Blocked)':u.state==='sabotaging'?'Sabotaging Loyalty':u.state==='recruiting'?'Poaching Target':u.state==='negotiating'?'TA Negotiation':'Unknown';
  let targetInfo='';
  if(u.target){targetInfo=`<div class="modal-desc" style="border-left-color:var(--gold)">Current target: <b>${u.target.city} #${u.target.id}</b> ($${u.target.value}K)${u.target.owner&&u.target.owner!==u.owner?' ‚Äî <span style="color:var(--red)">ENEMY ACCOUNT</span>':u.target.owner===u.owner?' ‚Äî <span style="color:var(--green)">OWN ACCOUNT</span>':''}</div>`}
  else if(u.type==='talent_acq'&&u.recruitTarget){targetInfo=`<div class="modal-desc" style="border-left-color:#bb44ff">Poach target: <b>${u.recruitTarget.nickname||UNITS_DEF[u.recruitTarget.type].name}</b> ‚Äî <span style="color:#bb44ff">${Math.floor(u.recruitProgress)}% complete</span></div>`}
  else if(u.type==='talent_acq'&&u.negotiatingWith){targetInfo=`<div class="modal-desc" style="border-left-color:#ff44bb">Negotiating with: <b>${u.negotiatingWith.nickname||'Enemy TA'}</b> ‚Äî <span style="color:#ff44bb">Tug: ${Math.floor(u.negotiationProgress)}%</span></div>`}
  
  document.getElementById('infoModalContent').innerHTML=`
    <h3><span class="modal-icon">${def.icon}</span><span style="color:${col}">${u.nickname||def.name}</span></h3>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <span style="font-family:'Orbitron',sans-serif;font-size:11px;color:${col}">${def.name} ¬∑ ${ownerName}</span>
      <span style="font-family:'Orbitron',sans-serif;font-size:10px;color:${rankCol};background:rgba(255,255,255,0.05);padding:3px 8px;border-radius:3px">${rank}</span>
    </div>
    <div class="modal-desc">${def.desc}</div>
    <div class="modal-stats">
      <div class="modal-stat"><div class="modal-stat-label">Status</div><div class="modal-stat-value" style="font-size:10px;color:${u.state==='converting'?'var(--gold)':u.state==='moving'?'var(--blue)':u.state==='blocked'?'#ff6644':u.state==='recruiting'?'#bb44ff':u.state==='negotiating'?'#ff44bb':'#888'}">${stateLabel}</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Speed</div><div class="modal-stat-value">${def.speed}x</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Power</div><div class="modal-stat-value">${def.power}</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Salary</div><div class="modal-stat-value" style="color:var(--orange)">$${def.salary}K/mo</div></div>
    </div>
    <div style="font-family:'Orbitron',sans-serif;font-size:9px;color:#888;margin:8px 0 4px;letter-spacing:1px">CAREER STATS</div>
    <div class="modal-stats">
      <div class="modal-stat"><div class="modal-stat-label">Deals Won</div><div class="modal-stat-value" style="color:#fff">${u.dealsWon||0}</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Deals Stolen</div><div class="modal-stat-value" style="color:var(--red)">${u.dealsStolen||0}</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Revenue</div><div class="modal-stat-value" style="color:var(--gold)">$${u.revGen||0}K</div></div>
      <div class="modal-stat"><div class="modal-stat-label">Tenure</div><div class="modal-stat-value">${age} ticks</div></div>
    </div>
    ${targetInfo}
    <div class="modal-desc" style="border-left-color:var(--blue)">${abilities.map(a=>'‚Ä¢ '+a).join('<br>')}</div>
    <button class="modal-close" onclick="closeInfo()">CLOSE</button>`;
  document.getElementById('infoModal').classList.add('open');
}
function closeInfo(){document.getElementById('infoModal').classList.remove('open')}
function endGame(won,reason){
  gameRunning=false;
  switchMusic('title');
  document.getElementById('gameOver').style.display='flex';
  const titles={domination:won?'MARKET DOMINANCE':'OUTCOMPETED',mrr_race:won?'MRR CHAMPION':'MRR DEFEATED',mrr_timeout:won?'MRR LEADER':'MRR BEHIND',elimination:won?'COMPETITOR ELIMINATED':'BANKRUPT',conquest:won?'TOTAL CONQUEST':'TOTALLY CONQUERED',bankrupt:won?'COMPETITOR COLLAPSED':'BANKRUPT'};
  document.getElementById('goTitle').textContent=(won?'üèÜ ':'üíÄ ')+(titles[reason||winCondition]||'GAME OVER');
  document.getElementById('goTitle').style.color=won?'#00ff41':'#ff3333';
  
  const share=Math.round(player.customers.length/TOTAL_CUST*100);
  const burn=player.units.filter(u=>u.state!=='building').reduce((s,u)=>s+u.salary,0);
  const totalDeals=player.units.reduce((s,u)=>s+(u.dealsWon||0),0);
  const totalStolen=player.units.reduce((s,u)=>s+(u.dealsStolen||0),0);
  const totalRev=player.units.reduce((s,u)=>s+(u.revGen||0),0);
  const topRep=player.units.reduce((best,u)=>(u.dealsWon||0)>(best.dealsWon||0)?u:best,player.units[0]);
  
  let analysis='';
  if(!won){
    // Build a diagnosis
    const reasons=[];
    if(player.customers.length===0&&burn>0)reasons.push(`Your team of ${player.units.length} reps cost $${burn}K/month in salaries but generated $0 in revenue. You ran out of cash before closing a single deal.`);
    else if(player.arr<burn)reasons.push(`Monthly burn ($${burn}K) exceeded revenue ($${Math.floor(player.arr)}K). You were losing $${burn-Math.floor(player.arr)}K every billing cycle.`);
    if(player.units.length>=4&&totalDeals<=1)reasons.push(`You hired ${player.units.length} reps but only closed ${totalDeals} deal${totalDeals===1?'':'s'}. Consider fewer, better-positioned reps early on.`);
    if(Object.keys(player.tech).filter(k=>player.tech[k]===true).length===0&&gameTime>30)reasons.push('You never completed any research. Tech like Basic CRM (+20% close rate) significantly boosts your team.');
    if(player.buildings.filter(b=>b.bp===undefined).length<=1&&gameTime>40)reasons.push('You only had one building. Expanding with an R&D Lab or Marketing Dept unlocks powerful options.');
    const topOpp=players.filter(p=>p!==player).reduce((a,b)=>a.customers.length>=b.customers.length?a:b);
    if(topOpp&&topOpp.customers.length>player.customers.length*3)reasons.push(`${topOpp.name} dominated with ${topOpp.customers.length} accounts vs your ${player.customers.length}. They outpaced you in the market.`);
    if(totalDeals>0&&player.arr>0&&burn>player.arr)reasons.push('You were growing but not fast enough ‚Äî try closing higher-value deals or researching Enterprise Edition (2√ó MRR).');
    if(reasons.length===0)reasons.push('You ran out of cash. Try balancing hiring speed with revenue growth ‚Äî each rep costs salary every month.');
    
    analysis=`<div style="text-align:left;background:rgba(255,51,51,0.06);border:1px solid rgba(255,51,51,0.2);border-radius:6px;padding:12px 14px;margin:12px 0;max-width:380px">
      <div style="font-family:'Orbitron',sans-serif;font-size:10px;color:#ff3333;margin-bottom:8px;letter-spacing:1px">üìã POST-MORTEM</div>
      ${reasons.map(r=>`<div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#ccc;margin-bottom:6px;line-height:1.5">‚Ä¢ ${r}</div>`).join('')}
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:#666;margin-top:8px;border-top:1px solid rgba(255,255,255,0.05);padding-top:8px">üí° TIP: Keep your burn rate below your MRR. Close deals before hiring more reps.</div>
    </div>`;
  } else {
    // Victory analysis
    const mvpLine=topRep?`MVP: ${topRep.nickname||UNITS_DEF[topRep.type].name} ‚Äî ${topRep.dealsWon} deals, $${topRep.revGen}K revenue`:'';
    analysis=`<div style="text-align:left;background:rgba(0,255,65,0.04);border:1px solid rgba(0,255,65,0.15);border-radius:6px;padding:12px 14px;margin:12px 0;max-width:380px">
      <div style="font-family:'Orbitron',sans-serif;font-size:10px;color:#00ff41;margin-bottom:8px;letter-spacing:1px">üèÜ VICTORY REPORT</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#ccc;line-height:1.6">
        Total deals closed: ${totalDeals} (${totalStolen} stolen)<br>
        Total revenue generated: $${totalRev}K<br>
        ${mvpLine?mvpLine+'<br>':''}
        Final burn rate: $${burn}K/mo vs ${Math.floor(player.arr)}K MRR<br>
        ${players.filter(p=>p!==player).map(p=>p.name+': '+Math.round(p.customers.length/TOTAL_CUST*100)+'%').join('<br>')}
      </div>
    </div>`;
  }
  
  document.getElementById('goStats').innerHTML=`
    <div style="margin-bottom:4px">UK & Ireland Market Share: ${share}%</div>
    <div>Accounts Won: ${player.customers.length} ¬∑ Duration: ${gameTime} ticks</div>
    <div>Team Size: ${player.units.length} ¬∑ Tech: ${Object.keys(player.tech).filter(k=>player.tech[k]===true).length}</div>
    ${analysis}`;
}
</script></body></html>
